<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 레시피 셰프 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: #f8f9fc; 
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f0f2f5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #d1d9e6; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #b0b8c9; }
        
        .spinner {
            border-width: 3px;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4); 
            border-color: #6366f1;
        }
        .tab-button {
            transition: all 0.25s ease-in-out;
            border-bottom: 3px solid transparent; /* 기본 밑줄은 투명 */
            padding-top: 0.6rem;
            padding-bottom: 0.6rem; /* 기본 하단 패딩 */
            padding-left: 0.5rem;
            padding-right: 0.5rem; 
            white-space: nowrap; 
            display: inline-flex; 
            align-items: center;
            font-size: 0.8rem; 
            line-height: 1.2; /* 텍스트와 밑줄 사이 간격 조정을 위해 추가 */
        }
        @media (min-width: 768px) { 
            .tab-button {
                padding-top: 0.85rem;
                padding-bottom: 0.85rem; /* 데스크탑 기본 하단 패딩 */
                padding-left: 0.7rem;
                padding-right: 0.7rem;
                font-size: 0.875rem; 
            }
        }

        .tab-button i { 
            margin-right: 0.25rem; 
        }
        .tab-button.active {
            color: #4f46e5; 
            border-bottom-color: #4f46e5; /* 활성 탭 밑줄 색상 */
            font-weight: 700;
            /* 밑줄이 텍스트에 더 가깝게 보이도록 패딩 조정 */
            /* padding-bottom 값에서 border-bottom-width (3px) 만큼 빼줍니다. */
            /* Tailwind의 기본 패딩 값과 계산을 맞추기 위해 calc 사용 대신 직접 값을 조정합니다. */
            /* 예: 0.6rem (9.6px) - 3px = 6.6px. Tailwind는 rem 단위를 사용하므로, 
               정확한 계산보다는 시각적으로 조정하는 것이 나을 수 있습니다.
               또는, border를 box-shadow로 대체하는 방법도 있습니다.
               여기서는 padding-bottom을 직접 조정합니다. */
        }
         /* 활성 탭의 하단 패딩을 더 줄여 밑줄을 올립니다. */
        .tab-button.active {
            padding-bottom: calc(0.6rem - 3px); /* 모바일: 기본 패딩 - 밑줄 두께 */
        }
        @media (min-width: 768px) {
            .tab-button.active {
                padding-bottom: calc(0.85rem - 3px); /* 데스크탑: 기본 패딩 - 밑줄 두께 */
            }
        }


        .tab-button:not(.active):hover {
            color: #3730a3; 
            background-color: #f0f2ff; 
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card {
            background-color: white;
            border-radius: 18px; 
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.06); 
            padding: 1.5rem 2rem; 
            margin-top: 1.5rem; 
        }
        @media (min-width: 768px) { 
            .content-card {
                padding: 2rem 2.5rem; 
                margin-top: 2rem; 
            }
        }

        .content-card h3.card-title { 
            font-size: 1.4rem; 
            font-weight: 700;
            color: #3730a3; 
            margin-bottom: 1.2rem;
            padding-bottom: 0.7rem;
            border-bottom: 1px solid #e5e7eb; 
        }
         .content-card ul, .content-card ol {
            padding-left: 1.4rem;
        }
        .content-card li {
            margin-bottom: 0.7rem;
            line-height: 1.8;
            color: #4b5563; 
        }
        .content-card strong {
            font-weight: 700;
            color: #1f2937; 
        }
        .content-card p {
            color: #4b5563;
            line-height: 1.8;
            margin-bottom: 0.85rem;
        }
        .action-button { 
            font-size: 1.05rem;
            padding-top: 0.9rem;
            padding-bottom: 0.9rem;
        }
        button#substituteIngredientButton, button#analyzeNutritionButton, button#generateShoppingListButton, button#saveToRecipeBookButton { 
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.2rem;
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
            transition: all 0.15s ease-in-out;
            margin-top: 0.5rem;
        }
        button#substituteIngredientButton:hover, button#analyzeNutritionButton:hover, button#generateShoppingListButton:hover, button#saveToRecipeBookButton:hover {
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); 
        }

        button#substituteIngredientButton { background-color: #f59e0b; } 
        button#substituteIngredientButton:hover { background-color: #d97706; } 
        button#analyzeNutritionButton { background-color: #10b981; } 
        button#analyzeNutritionButton:hover { background-color: #059669; } 
        button#generateShoppingListButton { background-color: #3b82f6; } 
        button#generateShoppingListButton:hover { background-color: #2563eb; } 
        button#saveToRecipeBookButton { background-color: #8b5cf6; } /* Violet-500 */
        button#saveToRecipeBookButton:hover { background-color: #7c3aed; } /* Violet-600 */


        .meal-plan-item, .themed-recipe-item, .saved-recipe-item, .calorie-log-item, .exercise-log-item, .water-log-item { 
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background-color: #f9fafb;
        }
        .meal-plan-item strong, .themed-recipe-item strong, .saved-recipe-item strong, .calorie-log-item strong, .exercise-log-item strong {
            color: #4f46e5;
        }
        .meal-plan-item button, .themed-recipe-item button, .saved-recipe-item button, .calorie-log-item button, .exercise-log-item button {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            margin-top: 0.5rem;
        }
        .saved-recipe-item .button-group button, .calorie-log-item .button-group button, .exercise-log-item .button-group button {
            margin-left: 0.5rem;
        }
        #nutritionAnalysisResult, #shoppingListResult, #beveragePairingResult, #cookingTermResult, #unitConversionResult, #seasonalRecipeResult, 
        #calorieTrackerResult, #dietPlannerResult, #exerciseTrackerResult, #waterIntakeResult, #dietTipResult { 
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px dashed #cbd5e1; 
        }
        #copyShoppingListButton {
            background-color: #6b7280; 
            color: white;
            margin-top: 1rem;
        }
        #copyShoppingListButton:hover {
            background-color: #4b5563; 
        }
        /* 네비게이션 그룹 제목 스타일 수정 */
        .nav-group-title {
            font-size: 0.8rem; 
            color: #4b5563; 
            text-align: left; 
            padding-left: 0.5rem; 
            margin-top: 0.75rem; /* 그룹 간 상단 간격 */
            margin-bottom: 0.25rem; 
            font-weight: 600; 
        }
        #mainNavContainer > .nav-group-title:first-of-type { /* 첫번째 그룹 제목의 상단 마진 제거 */
             margin-top: 0;
        }
        #additionalTabs > .nav-group-title { /* 추가 탭 내의 그룹 제목 상단 마진 */
            margin-top: 0.75rem; /* md:mt-3 와 유사하게 */
        }
         #additionalTabs > .nav-group-title:first-child { /* 추가 탭 내의 첫 그룹 제목 상단 마진도 동일하게 */
            margin-top: 0.75rem;
        }


    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

    <div class="container mx-auto max-w-5xl w-full">
        <header class="text-center my-8 md:my-10 lg:my-14">
            <h1 class="text-3xl sm:text-4xl lg:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-purple-500 to-pink-500">
                AI 레시피 셰프
            </h1>
            <p class="text-base sm:text-lg lg:text-xl text-gray-600 mt-3 sm:mt-5">AI와 함께, 매일매일 특별한 미식 경험을 만들어보세요!</p>
        </header>

        <nav class="mb-8 md:mb-10">
            <div class="md:hidden text-center mb-3">
                <button id="mobileMoreMenuButton" class="py-2 px-4 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 text-sm font-medium w-full sm:w-auto">
                    <span id="mobileMoreMenuButtonText">더 많은 메뉴 보기</span> <i id="mobileMoreMenuIcon" class="fas fa-chevron-down ml-1 transition-transform duration-200"></i>
                </button>
            </div>

            <div id="mainNavContainer" class="border-b border-gray-200 pb-1 md:pb-2">
                <div class="nav-group-title">레시피 탐색</div>
                <div id="coreTabs" class="flex flex-wrap justify-center md:justify-start items-center gap-x-1 gap-y-1 md:gap-y-2">
                    <button data-tab="tab2" class="tab-button core-tab active"> 
                        <i class="fas fa-hat-chef"></i>오늘의 추천
                    </button>
                    <button data-tab="tab1" class="tab-button core-tab">
                        <i class="fas fa-cogs"></i>맞춤 레시피
                    </button>
                    <button data-tab="tab3" class="tab-button core-tab">
                        <i class="fas fa-book-sparkles"></i>요리 검색
                    </button>
                     <button data-tab="tab6" class="tab-button core-tab md:additional-tab"> <i class="fas fa-gifts"></i>테마별 요리
                    </button>
                    <button data-tab="tab10" class="tab-button core-tab md:additional-tab">
                        <i class="fas fa-leaf"></i>제철 요리
                    </button>
                </div>

                <div id="additionalTabs" class="hidden md:block"> 
                    <div class="nav-group-title">주방 도구</div>
                    <div class="flex flex-wrap justify-center md:justify-start items-center gap-x-1 gap-y-1 md:gap-y-2">
                        <button data-tab="tab4" class="tab-button additional-tab">
                            <i class="fas fa-carrot"></i>냉장고 파먹기
                        </button>
                        <button data-tab="tab7" class="tab-button additional-tab">
                            <i class="fas fa-wine-glass"></i>음료 추천
                        </button>
                        <button data-tab="tab8" class="tab-button additional-tab">
                            <i class="fas fa-book-open"></i>요리 용어
                        </button>
                        <button data-tab="tab9" class="tab-button additional-tab">
                            <i class="fas fa-balance-scale"></i>단위 변환
                        </button>
                    </div>
                    
                    <div class="nav-group-title">헬스 플래너(베타)</div>
                    <div class="flex flex-wrap justify-center md:justify-start items-center gap-x-1 gap-y-1 md:gap-y-2">
                         <button data-tab="tab12" class="tab-button additional-tab">
                            <i class="fas fa-calculator"></i>칼로리 트래커
                        </button>
                        <button data-tab="tab13" class="tab-button additional-tab">
                            <i class="fas fa-utensils"></i>AI 다이어트 플랜
                        </button>
                        <button data-tab="tab14" class="tab-button additional-tab">
                            <i class="fas fa-dumbbell"></i>운동 도우미
                        </button>
                        <button data-tab="tab15" class="tab-button additional-tab">
                            <i class="fas fa-tint"></i>수분 트래커
                        </button>
                        <button data-tab="tab16" class="tab-button additional-tab">
                            <i class="fas fa-lightbulb"></i>오늘의 다이어트 팁
                        </button>
                    </div>

                    <div class="nav-group-title">나의 공간</div>
                    <div class="flex flex-wrap justify-center md:justify-start items-center gap-x-1 gap-y-1 md:gap-y-2">
                        <button data-tab="tab5" class="tab-button additional-tab">
                            <i class="fas fa-calendar-alt"></i>AI 주간 식단
                        </button>
                        <button data-tab="tab11" class="tab-button additional-tab">
                            <i class="fas fa-bookmark"></i>내 레시피북
                        </button>
                    </div>
                </div>
            </div>
        </nav>


        <div class="bg-white p-6 sm:p-10 rounded-xl shadow-xl relative">
            <div id="tab1" class="tab-content">
                <section class="space-y-7">
                    <p class="text-md text-gray-700 mb-4">원하는 요리 스타일과 식단 선호도를 알려주시면, AI가 완벽한 레시피와 함께 필요한 모든 재료를 추천해 드립니다!</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-7">
                        <div>
                            <label for="dietaryPreferences" class="block text-md font-semibold text-gray-800 mb-2.5">🥗 식단 선호도/제한 (선택 사항)</label>
                            <input type="text" id="dietaryPreferences" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 저탄수화물, 비건, 견과류 제외">
                        </div>
                        <div>
                            <label for="cuisineStyle" class="block text-md font-semibold text-gray-800 mb-2.5">🍜 선호 요리 스타일 (선택 사항)</label>
                            <input type="text" id="cuisineStyle" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 이탈리안, 퓨전 한식, 초간단">
                        </div>
                    </div>
                    <button id="generateRecipeButton" class="action-button w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-wand-magic-sparkles mr-3"></i>AI 추천 레시피 생성
                    </button>
                </section>
            </div>

            <div id="tab2" class="tab-content active"> 
                 <section class="space-y-7">
                    <div>
                        <label for="whatToEatKeywords" class="block text-md font-semibold text-gray-800 mb-2.5">💡 원하는 요리 느낌 (선택 사항)</label>
                        <input type="text" id="whatToEatKeywords" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 든든한 한 끼, 와인과 어울리는, 매콤한 도전">
                        <p class="text-xs text-gray-500 mt-1.5">AI에게 자유로운 추천을 맡겨보세요! (비워두셔도 좋습니다)</p>
                    </div>
                    <button id="recommendDishButton" class="action-button w-full bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-lightbulb-on mr-3"></i>오늘의 요리 추천받기
                    </button>
                    <div id="recommendationDisplayWrapper" class="hidden">
                        <div id="recommendationDisplay" class="content-card">
                            </div>
                    </div>
                </section>
            </div>

            <div id="tab3" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="specificDishName" class="block text-md font-semibold text-gray-800 mb-2.5">🍳 찾고 싶은 요리 이름</label>
                        <input type="text" id="specificDishName" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 봉골레 파스타, 닭볶음탕">
                    </div>
                    <button id="searchSpecificDishButton" class="action-button w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-book-open-reader mr-3"></i>레시피 검색
                    </button>
                </section>
            </div>
            
            <div id="tab4" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="leftoverIngredients" class="block text-md font-semibold text-gray-800 mb-2.5">🥕 냉장고 속 재료 입력</label>
                        <textarea id="leftoverIngredients" rows="4" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 남은 삼겹살 조금, 시금치 반 단, 두부 반 모, 양파 1/4개"></textarea>
                        <p class="text-xs text-gray-500 mt-1.5">가지고 있는 재료들을 최대한 활용하는 레시피를 찾아드립니다!</p>
                    </div>
                     <div>
                        <label for="leftoverCuisineStyle" class="block text-md font-semibold text-gray-800 mb-2.5">🍜 선호 요리 스타일 (선택 사항)</label>
                        <input type="text" id="leftoverCuisineStyle" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 한식, 간단한 볶음, 국물 요리">
                    </div>
                    <button id="generateLeftoverRecipeButton" class="action-button w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-recycle mr-3"></i>냉장고 파먹기 레시피 생성!
                    </button>
                </section>
            </div>

            <div id="tab5" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="mealPlanPreferences" class="block text-md font-semibold text-gray-800 mb-2.5">📅 주간 식단 요청사항</label>
                        <input type="text" id="mealPlanPreferences" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 고단백 위주, 채식으로 일주일, 간단한 저녁 메뉴들">
                        <p class="text-xs text-gray-500 mt-1.5">AI가 7일치 저녁 식단 아이디어를 제안해 드립니다.</p>
                    </div>
                    <button id="generateMealPlanButton" class="action-button w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-calendar-check mr-3"></i>AI 주간 식단 생성!
                    </button>
                     <div id="mealPlanDisplayWrapper" class="hidden">
                        <div id="mealPlanDisplay" class="content-card">
                            </div>
                    </div>
                </section>
            </div>

            <div id="tab6" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="themeKeywords" class="block text-md font-semibold text-gray-800 mb-2.5">🎉 원하는 테마/상황 입력</label>
                        <input type="text" id="themeKeywords" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 생일 파티, 캠핑 요리, 비 오는 날, 손님 초대">
                        <p class="text-xs text-gray-500 mt-1.5">AI가 테마에 맞는 특별한 요리들을 추천해 드립니다.</p>
                    </div>
                    <button id="generateThemedRecipesButton" class="action-button w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-gifts mr-3"></i>테마 요리 추천받기!
                    </button>
                     <div id="themedRecipesDisplayWrapper" class="hidden">
                        <div id="themedRecipesDisplay" class="content-card">
                            </div>
                    </div>
                </section>
            </div>

            <div id="tab7" class="tab-content"> <section class="space-y-7">
                    <div>
                        <label for="beverageDishName" class="block text-md font-semibold text-gray-800 mb-2.5">🍷 페어링할 요리 이름</label>
                        <input type="text" id="beverageDishName" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 스테이크, 봉골레 파스타">
                    </div>
                    <button id="getBeveragePairingButton" class="action-button w-full bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-glass-cheers mr-3"></i>어울리는 음료 추천받기
                    </button>
                    <div id="beveragePairingResultWrapper" class="hidden">
                        <div id="beveragePairingResult" class="content-card"></div>
                    </div>
                </section>
            </div>

            <div id="tab8" class="tab-content"> <section class="space-y-7">
                    <div>
                        <label for="cookingTerm" class="block text-md font-semibold text-gray-800 mb-2.5">📖 궁금한 요리 용어</label>
                        <input type="text" id="cookingTerm" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 블랑슁, 줄리엔">
                    </div>
                    <button id="searchCookingTermButton" class="action-button w-full bg-gradient-to-r from-sky-500 to-cyan-500 hover:from-sky-600 hover:to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-search-plus mr-3"></i>용어 뜻 검색하기
                    </button>
                    <div id="cookingTermResultWrapper" class="hidden">
                        <div id="cookingTermResult" class="content-card"></div>
                    </div>
                </section>
            </div>

            <div id="tab9" class="tab-content"> <section class="space-y-7">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="unitValue" class="block text-sm font-medium text-gray-700">값</label>
                            <input type="number" id="unitValue" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 100">
                        </div>
                        <div>
                            <label for="fromUnit" class="block text-sm font-medium text-gray-700">현재 단위</label>
                            <input type="text" id="fromUnit" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: g, ml, 컵">
                        </div>
                        <div>
                            <label for="toUnit" class="block text-sm font-medium text-gray-700">변환할 단위</label>
                            <input type="text" id="toUnit" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: oz, tsp, 큰술">
                        </div>
                    </div>
                    <button id="convertUnitButton" class="action-button w-full bg-gradient-to-r from-lime-500 to-green-500 hover:from-lime-600 hover:to-green-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-exchange-alt mr-3"></i>단위 변환하기
                    </button>
                    <div id="unitConversionResultWrapper" class="hidden">
                        <div id="unitConversionResult" class="content-card"></div>
                    </div>
                </section>
            </div>

            <div id="tab10" class="tab-content"> <section class="space-y-7">
                    <div>
                        <label for="seasonInput" class="block text-md font-semibold text-gray-800 mb-2.5">🌿 월 또는 계절 입력</label>
                        <input type="text" id="seasonInput" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 3월, 여름">
                    </div>
                    <button id="getSeasonalRecipesButton" class="action-button w-full bg-gradient-to-r from-yellow-500 to-amber-500 hover:from-yellow-600 hover:to-amber-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-pepper-hot mr-3"></i>제철 레시피 추천받기
                    </button>
                    <div id="seasonalRecipeResultWrapper" class="hidden">
                        <div id="seasonalRecipeResult" class="content-card"></div>
                    </div>
                </section>
            </div>
            
            <div id="tab11" class="tab-content"> <section class="space-y-7">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">📖 나만의 레시피북</h3>
                    <div id="savedRecipesList" class="space-y-4">
                        <p class="text-gray-500 italic text-center">아직 저장된 레시피가 없습니다.</p>
                    </div>
                </section>
            </div>

             <div id="tab12" class="tab-content"> <section class="space-y-7">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">📝 스마트 칼로리 트래커</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="calorieFoodName" class="block text-md font-semibold text-gray-800 mb-2">음식/재료 이름</label>
                            <input type="text" id="calorieFoodName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 닭가슴살 100g, 사과 1개">
                        </div>
                        <div>
                            <label for="calorieMealType" class="block text-md font-semibold text-gray-800 mb-2">식사 종류</label>
                            <select id="calorieMealType" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="breakfast">아침</option>
                                <option value="lunch">점심</option>
                                <option value="dinner">저녁</option>
                                <option value="snack">간식</option>
                            </select>
                        </div>
                    </div>
                    <button id="analyzeAndLogCalorieButton" class="action-button w-full bg-green-500 hover:bg-green-600 text-white">
                        <i class="fas fa-calculator mr-2"></i>칼로리 분석 및 기록
                    </button>
                    <div id="calorieTrackerResultWrapper" class="hidden">
                        <div id="calorieTrackerResult" class="content-card"></div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3">오늘의 섭취 기록</h4>
                        <div id="dailyCalorieLog" class="space-y-2">
                            <p class="text-gray-500 italic">아직 기록된 내용이 없습니다.</p>
                        </div>
                        <p class="text-right font-semibold text-gray-800 mt-3">총 섭취 칼로리: <span id="totalDailyCalories">0</span> kcal</p>
                    </div>
                </section>
            </div>

            <div id="tab13" class="tab-content"> <section class="space-y-7">
                     <h3 class="text-xl font-bold text-indigo-600 mb-4">🍽️ AI 맞춤 다이어트 플래너</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="dietGoal" class="block text-md font-semibold text-gray-800 mb-2">다이어트 목표</label>
                            <select id="dietGoal" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="loss">체중 감량</option>
                                <option value="maintenance">체중 유지</option>
                                <option value="gain">근육 증가</option>
                            </select>
                        </div>
                        <div>
                            <label for="activityLevel" class="block text-md font-semibold text-gray-800 mb-2">평소 활동량</label>
                            <select id="activityLevel" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="low">낮음 (주로 앉아서 생활)</option>
                                <option value="moderate">보통 (가벼운 활동 또는 주 1-2회 운동)</option>
                                <option value="high">높음 (규칙적인 운동 또는 활동적인 직업)</option>
                            </select>
                        </div>
                         <div>
                            <label for="dietDuration" class="block text-md font-semibold text-gray-800 mb-2">목표 기간 (일)</label>
                            <input type="number" id="dietDuration" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 30">
                        </div>
                        <div>
                            <label for="dietPreferences" class="block text-md font-semibold text-gray-800 mb-2">식단 선호/제한 (선택)</label>
                            <input type="text" id="dietPreferencesPlanner" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 저탄수화물, 글루텐 프리">
                        </div>
                    </div>
                    <button id="generateDietPlanButton" class="action-button w-full bg-purple-500 hover:bg-purple-600 text-white">
                        <i class="fas fa-magic mr-2"></i>AI 맞춤 식단 생성
                    </button>
                    <div id="dietPlannerResultWrapper" class="hidden">
                        <div id="dietPlannerResult" class="content-card"></div>
                    </div>
                </section>
            </div>
             <div id="tab14" class="tab-content"> <section class="space-y-7">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">💪 운동 도우미 & 소모 칼로리 계산</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="exerciseType" class="block text-md font-semibold text-gray-800 mb-2">운동 종류</label>
                            <input type="text" id="exerciseType" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 걷기, 조깅, 수영">
                        </div>
                        <div>
                            <label for="exerciseDuration" class="block text-md font-semibold text-gray-800 mb-2">운동 시간 (분)</label>
                            <input type="number" id="exerciseDuration" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="예: 30">
                        </div>
                    </div>
                    <button id="calculateExerciseCaloriesButton" class="action-button w-full bg-blue-500 hover:bg-blue-600 text-white">
                        <i class="fas fa-fire mr-2"></i>소모 칼로리 계산 및 기록
                    </button>
                    <div id="exerciseTrackerResultWrapper" class="hidden">
                        <div id="exerciseTrackerResult" class="content-card"></div>
                    </div>
                     <div>
                        <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3">오늘의 운동 기록</h4>
                        <div id="dailyExerciseLog" class="space-y-2">
                            <p class="text-gray-500 italic">아직 기록된 운동이 없습니다.</p>
                        </div>
                        <p class="text-right font-semibold text-gray-800 mt-3">총 소모 칼로리: <span id="totalDailyExerciseCalories">0</span> kcal</p>
                    </div>
                </section>
            </div>

            <div id="tab15" class="tab-content"> <section class="space-y-7">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">💧 수분 섭취 트래커</h3>
                    <div>
                        <label for="waterIntakeGoal" class="block text-md font-semibold text-gray-800 mb-2">일일 목표 섭취량 (ml)</label>
                        <input type="number" id="waterIntakeGoal" class="w-full p-3 border border-gray-300 rounded-lg" value="2000">
                    </div>
                    <div class="flex items-center gap-4">
                        <input type="number" id="waterIntakeAmount" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="섭취량 (ml)" value="250">
                        <button id="logWaterIntakeButton" class="py-3 px-6 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg whitespace-nowrap">
                            <i class="fas fa-plus mr-2"></i>기록
                        </button>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div id="waterIntakeProgress" class="bg-blue-500 h-6 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: 0%">0%</div>
                        </div>
                        <p class="text-sm text-gray-600 mt-1 text-center">오늘 마신 물: <span id="currentWaterIntake">0</span> ml / <span id="waterGoalDisplay">2000</span> ml</p>
                    </div>
                     <div id="waterIntakeResultWrapper" class="hidden"> <div id="waterIntakeResult" class="content-card"></div>
                    </div>
                </section>
            </div>

            <div id="tab16" class="tab-content"> <section class="space-y-7">
                     <h3 class="text-xl font-bold text-indigo-600 mb-4">💡 오늘의 다이어트 꿀팁</h3>
                    <button id="getDietTipButton" class="action-button w-full bg-pink-500 hover:bg-pink-600 text-white">
                        <i class="fas fa-seedling mr-2"></i>새로운 꿀팁 보기
                    </button>
                    <div id="dietTipResultWrapper" class="hidden">
                        <div id="dietTipResult" class="content-card"></div>
                    </div>
                </section>
            </div>


        </div>
        
        <div id="loadingIndicator" class="my-10 text-indigo-600 hidden flex flex-col items-center justify-center text-lg">
            <svg class="spinner w-12 h-12 mr-3 border-indigo-500 rounded-full" viewBox="0 0 24 24"></svg>
            <p id="loadingText" class="mt-4 font-semibold text-gray-700">AI 셰프가 열심히 요리 중...</p>
        </div>

        <section id="recipeOutputSection" class="hidden">
             <div class="content-card">
                <h2 id="recipeOutputTitle" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 text-center">AI 셰프의 답변</h2>
                <div id="recipeDisplay" class="w-full min-h-[100px] space-y-6"> 
                    <p class="text-gray-500 italic text-center py-8">결과가 여기에 표시됩니다.</p>
                </div>
                <div id="additionalActionsSection" class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row flex-wrap justify-center gap-3 sm:gap-4 hidden">
                    <button id="generateShoppingListButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-list-check mr-2"></i> 장보기 목록 생성
                    </button>
                    <button id="substituteIngredientButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-exchange-alt mr-2"></i> 재료 대체 추천
                    </button>
                    <button id="analyzeNutritionButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-chart-pie mr-2"></i> 영양 정보 분석
                    </button>
                    <button id="saveToRecipeBookButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> 레시피북에 저장
                    </button>
                </div>
                <div id="shoppingListResult" class="hidden"> </div>
                <div id="nutritionAnalysisResult" class="hidden"> </div>
             </div>
        </section>
    </div>

    <div id="substituteModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full mx-auto transform transition-all duration-300 ease-out scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">재료 대체 추천 요청</h3>
                <button id="closeSubstituteModal" class="text-gray-400 hover:text-gray-600 transition-colors text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-600 text-sm">현재 보고 계신 레시피에서 바꾸고 싶은 재료를 알려주세요. AI가 적절한 대체 재료를 추천해 드립니다.</p>
                <div>
                    <label for="ingredientToSubstitute" class="block text-sm font-medium text-gray-700 mb-1">바꾸고 싶은 재료 이름:</label>
                    <input type="text" id="ingredientToSubstitute" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 우유, 돼지고기 목살">
                </div>
                 <div>
                    <label for="substitutionReason" class="block text-sm font-medium text-gray-700 mb-1">대체 이유 (선택 사항):</label>
                    <input type="text" id="substitutionReason" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="예: 알레르기, 채식, 집에 없어서">
                </div>
            </div>
            <div class="mt-8 text-right">
                <button id="confirmSubstituteButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2.5 px-6 rounded-lg transition-colors text-sm shadow-md hover:shadow-lg">
                    AI에게 추천 요청
                </button>
            </div>
        </div>
    </div>


    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-auto transform transition-all duration-300 ease-out scale-95 opacity-0" 
             data-modal-state="closed">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold text-red-600 flex items-center"><i class="fas fa-exclamation-triangle mr-3"></i>오류 발생</h3>
                <button id="closeErrorModal" class="text-gray-400 hover:text-gray-600 transition-colors text-2xl">&times;</button>
            </div>
            <p id="errorMessage" class="text-gray-700 mb-8 text-md leading-relaxed">오류 메시지가 여기에 표시됩니다.</p>
            <div class="text-right">
                <button id="confirmErrorModal" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-6 rounded-lg transition-colors text-sm shadow-md hover:shadow-lg">
                    확인
                </button>
            </div>
        </div>
    </div>

    <textarea id="clipboardHelper" style="position: absolute; left: -9999px; top: -9999px;"></textarea>


    <script>
    // 전역 변수
    let currentRecipeFullText = ""; 
    let currentRecipeTitle = ""; 

    // DOM 요소들을 저장할 객체
    const UIElements = {};

    document.addEventListener('DOMContentLoaded', () => {
        // 주요 UI 요소들 가져오기
        UIElements.tabButtons = document.querySelectorAll('.tab-button');
        UIElements.tabContents = document.querySelectorAll('.tab-content');
        UIElements.mobileMoreMenuButton = document.getElementById('mobileMoreMenuButton');
        UIElements.coreTabsContainer = document.getElementById('coreTabs'); 
        UIElements.additionalTabsContainer = document.getElementById('additionalTabs'); 

        UIElements.dietaryPreferencesInput = document.getElementById('dietaryPreferences');
        UIElements.cuisineStyleInput = document.getElementById('cuisineStyle');
        UIElements.generateRecipeButton = document.getElementById('generateRecipeButton');
        UIElements.whatToEatKeywordsInput = document.getElementById('whatToEatKeywords');
        UIElements.recommendDishButton = document.getElementById('recommendDishButton');
        UIElements.recommendationDisplayWrapper = document.getElementById('recommendationDisplayWrapper');
        UIElements.recommendationDisplay = document.getElementById('recommendationDisplay');
        UIElements.specificDishNameInput = document.getElementById('specificDishName');
        UIElements.searchSpecificDishButton = document.getElementById('searchSpecificDishButton');
        UIElements.leftoverIngredientsInput = document.getElementById('leftoverIngredients');
        UIElements.leftoverCuisineStyleInput = document.getElementById('leftoverCuisineStyle');
        UIElements.generateLeftoverRecipeButton = document.getElementById('generateLeftoverRecipeButton');
        UIElements.mealPlanPreferencesInput = document.getElementById('mealPlanPreferences');
        UIElements.generateMealPlanButton = document.getElementById('generateMealPlanButton');
        UIElements.mealPlanDisplayWrapper = document.getElementById('mealPlanDisplayWrapper');
        UIElements.mealPlanDisplay = document.getElementById('mealPlanDisplay');
        UIElements.themeKeywordsInput = document.getElementById('themeKeywords');
        UIElements.generateThemedRecipesButton = document.getElementById('generateThemedRecipesButton');
        UIElements.themedRecipesDisplayWrapper = document.getElementById('themedRecipesDisplayWrapper');
        UIElements.themedRecipesDisplay = document.getElementById('themedRecipesDisplay');
        
        // 헬스 플래너 UI 요소
        UIElements.calorieFoodNameInput = document.getElementById('calorieFoodName');
        UIElements.calorieMealTypeSelect = document.getElementById('calorieMealType');
        UIElements.analyzeAndLogCalorieButton = document.getElementById('analyzeAndLogCalorieButton');
        UIElements.calorieTrackerResultWrapper = document.getElementById('calorieTrackerResultWrapper');
        UIElements.calorieTrackerResult = document.getElementById('calorieTrackerResult');
        UIElements.dailyCalorieLogDiv = document.getElementById('dailyCalorieLog');
        UIElements.totalDailyCaloriesSpan = document.getElementById('totalDailyCalories');

        UIElements.dietGoalSelect = document.getElementById('dietGoal');
        UIElements.activityLevelSelect = document.getElementById('activityLevel');
        UIElements.dietDurationInput = document.getElementById('dietDuration');
        UIElements.dietPreferencesPlannerInput = document.getElementById('dietPreferencesPlanner');
        UIElements.generateDietPlanButton = document.getElementById('generateDietPlanButton');
        UIElements.dietPlannerResultWrapper = document.getElementById('dietPlannerResultWrapper');
        UIElements.dietPlannerResult = document.getElementById('dietPlannerResult');
        
        UIElements.exerciseTypeInput = document.getElementById('exerciseType');
        UIElements.exerciseDurationInput = document.getElementById('exerciseDuration');
        UIElements.calculateExerciseCaloriesButton = document.getElementById('calculateExerciseCaloriesButton');
        UIElements.exerciseTrackerResultWrapper = document.getElementById('exerciseTrackerResultWrapper');
        UIElements.exerciseTrackerResult = document.getElementById('exerciseTrackerResult');
        UIElements.dailyExerciseLogDiv = document.getElementById('dailyExerciseLog');
        UIElements.totalDailyExerciseCaloriesSpan = document.getElementById('totalDailyExerciseCalories');

        UIElements.waterIntakeGoalInput = document.getElementById('waterIntakeGoal');
        UIElements.waterIntakeAmountInput = document.getElementById('waterIntakeAmount');
        UIElements.logWaterIntakeButton = document.getElementById('logWaterIntakeButton');
        UIElements.waterIntakeProgressDiv = document.getElementById('waterIntakeProgress');
        UIElements.currentWaterIntakeSpan = document.getElementById('currentWaterIntake');
        UIElements.waterGoalDisplaySpan = document.getElementById('waterGoalDisplay');
        UIElements.waterIntakeResultWrapper = document.getElementById('waterIntakeResultWrapper'); // AI 답변용
        UIElements.waterIntakeResult = document.getElementById('waterIntakeResult'); // AI 답변용

        UIElements.getDietTipButton = document.getElementById('getDietTipButton');
        UIElements.dietTipResultWrapper = document.getElementById('dietTipResultWrapper');
        UIElements.dietTipResult = document.getElementById('dietTipResult');


        UIElements.beverageDishNameInput = document.getElementById('beverageDishName');
        UIElements.getBeveragePairingButton = document.getElementById('getBeveragePairingButton');
        UIElements.beveragePairingResultWrapper = document.getElementById('beveragePairingResultWrapper');
        UIElements.beveragePairingResult = document.getElementById('beveragePairingResult');

        UIElements.cookingTermInput = document.getElementById('cookingTerm');
        UIElements.searchCookingTermButton = document.getElementById('searchCookingTermButton');
        UIElements.cookingTermResultWrapper = document.getElementById('cookingTermResultWrapper');
        UIElements.cookingTermResult = document.getElementById('cookingTermResult');
        
        UIElements.unitValueInput = document.getElementById('unitValue');
        UIElements.fromUnitInput = document.getElementById('fromUnit');
        UIElements.toUnitInput = document.getElementById('toUnit');
        UIElements.convertUnitButton = document.getElementById('convertUnitButton');
        UIElements.unitConversionResultWrapper = document.getElementById('unitConversionResultWrapper');
        UIElements.unitConversionResult = document.getElementById('unitConversionResult');

        UIElements.seasonInput = document.getElementById('seasonInput');
        UIElements.getSeasonalRecipesButton = document.getElementById('getSeasonalRecipesButton');
        UIElements.seasonalRecipeResultWrapper = document.getElementById('seasonalRecipeResultWrapper');
        UIElements.seasonalRecipeResult = document.getElementById('seasonalRecipeResult');

        UIElements.savedRecipesListDiv = document.getElementById('savedRecipesList');
        UIElements.saveToRecipeBookButton = document.getElementById('saveToRecipeBookButton');


        UIElements.loadingIndicator = document.getElementById('loadingIndicator');
        UIElements.loadingText = document.getElementById('loadingText');
        UIElements.recipeOutputSection = document.getElementById('recipeOutputSection');
        UIElements.recipeOutputTitle = document.getElementById('recipeOutputTitle');
        UIElements.recipeDisplay = document.getElementById('recipeDisplay');
        UIElements.additionalActionsSection = document.getElementById('additionalActionsSection');
        UIElements.generateShoppingListButton = document.getElementById('generateShoppingListButton'); 
        UIElements.shoppingListResultDiv = document.getElementById('shoppingListResult'); 
        UIElements.substituteIngredientButton = document.getElementById('substituteIngredientButton');
        UIElements.analyzeNutritionButton = document.getElementById('analyzeNutritionButton'); 
        UIElements.nutritionAnalysisResultDiv = document.getElementById('nutritionAnalysisResult'); 
        UIElements.substituteModal = document.getElementById('substituteModal');
        UIElements.substituteModalContent = UIElements.substituteModal ? UIElements.substituteModal.querySelector('div > div') : null;
        UIElements.closeSubstituteModalButton = document.getElementById('closeSubstituteModal');
        UIElements.ingredientToSubstituteInput = document.getElementById('ingredientToSubstitute');
        UIElements.substitutionReasonInput = document.getElementById('substitutionReason');
        UIElements.confirmSubstituteButton = document.getElementById('confirmSubstituteButton');
        UIElements.errorModal = document.getElementById('errorModal');
        UIElements.errorModalContentEl = UIElements.errorModal ? UIElements.errorModal.querySelector('div[data-modal-state]') : null;
        UIElements.errorMessageElement = document.getElementById('errorMessage');
        UIElements.closeErrorModalButton = document.getElementById('closeErrorModal');
        UIElements.confirmErrorModalButton = document.getElementById('confirmErrorModal');
        UIElements.clipboardHelper = document.getElementById('clipboardHelper');

        // 모바일 "더보기" 메뉴 토글
        if (UIElements.mobileMoreMenuButton && UIElements.additionalTabsContainer) {
            UIElements.mobileMoreMenuButton.addEventListener('click', () => {
                const isHidden = UIElements.additionalTabsContainer.classList.contains('hidden');
                const buttonTextEl = UIElements.mobileMoreMenuButton.querySelector('#mobileMoreMenuButtonText');
                const iconEl = UIElements.mobileMoreMenuButton.querySelector('#mobileMoreMenuIcon');

                if (isHidden) {
                    UIElements.additionalTabsContainer.classList.remove('hidden');
                    UIElements.additionalTabsContainer.classList.add('grid', 'grid-cols-3', 'sm:grid-cols-4', 'gap-x-1', 'gap-y-2', 'mt-2', 'py-2', 'border-t', 'border-gray-200');
                    if(buttonTextEl) buttonTextEl.textContent = "메뉴 접기";
                    if(iconEl) iconEl.classList.replace('fa-chevron-down', 'fa-chevron-up');
                } else {
                    UIElements.additionalTabsContainer.classList.add('hidden');
                    UIElements.additionalTabsContainer.classList.remove('grid', 'grid-cols-3', 'sm:grid-cols-4', 'gap-x-1', 'gap-y-2', 'mt-2', 'py-2', 'border-t', 'border-gray-200');
                    if(buttonTextEl) buttonTextEl.textContent = "더 많은 메뉴 보기";
                    if(iconEl) iconEl.classList.replace('fa-chevron-up', 'fa-chevron-down');
                }
            });
        }


        // 탭 기능 초기화
        if (UIElements.tabButtons && UIElements.tabContents) {
            UIElements.tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    UIElements.tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    UIElements.tabContents.forEach(content => content.classList.remove('active'));
                    const activeTabContent = document.getElementById(button.dataset.tab);
                    if (activeTabContent) activeTabContent.classList.add('active');
                    
                    if(UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                    [UIElements.recommendationDisplayWrapper, UIElements.mealPlanDisplayWrapper, UIElements.themedRecipesDisplayWrapper, 
                     UIElements.beveragePairingResultWrapper, UIElements.cookingTermResultWrapper, UIElements.unitConversionResultWrapper,
                     UIElements.seasonalRecipeResultWrapper, UIElements.calorieTrackerResultWrapper, UIElements.dietPlannerResultWrapper,
                     UIElements.exerciseTrackerResultWrapper, UIElements.waterIntakeResultWrapper, UIElements.dietTipResultWrapper
                    ].forEach(wrapper => {
                        if (wrapper) wrapper.classList.add('hidden');
                    });

                    if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden'); 
                    if(UIElements.nutritionAnalysisResultDiv) {
                        UIElements.nutritionAnalysisResultDiv.classList.add('hidden');
                        UIElements.nutritionAnalysisResultDiv.innerHTML = ''; 
                    }
                    if(UIElements.shoppingListResultDiv) {
                        UIElements.shoppingListResultDiv.classList.add('hidden');
                        UIElements.shoppingListResultDiv.innerHTML = '';
                    }
                    currentRecipeFullText = ""; 
                    currentRecipeTitle = "";

                    if (button.dataset.tab === 'tab11' && UIElements.savedRecipesListDiv) {
                        loadAndDisplaySavedRecipes();
                    }
                    if (button.dataset.tab === 'tab12' && UIElements.dailyCalorieLogDiv) {
                        loadDailyCalorieLog();
                    }
                     if (button.dataset.tab === 'tab14' && UIElements.dailyExerciseLogDiv) {
                        loadDailyExerciseLog();
                    }
                    if (button.dataset.tab === 'tab15' && UIElements.waterIntakeProgressDiv) {
                        loadAndUpdateWaterIntakeProgress();
                    }


                    // 모바일에서 추가 메뉴의 탭 선택 후 "더보기" 메뉴 닫기
                    if (window.innerWidth < 768 && UIElements.additionalTabsContainer && !UIElements.additionalTabsContainer.classList.contains('hidden') && button.classList.contains('additional-tab')) {
                        UIElements.additionalTabsContainer.classList.add('hidden');
                        UIElements.additionalTabsContainer.classList.remove('grid', 'grid-cols-3', 'sm:grid-cols-4', 'gap-x-1', 'gap-y-2', 'mt-2', 'py-2', 'border-t', 'border-gray-200');
                        const buttonTextEl = UIElements.mobileMoreMenuButton.querySelector('#mobileMoreMenuButtonText');
                        const iconEl = UIElements.mobileMoreMenuButton.querySelector('#mobileMoreMenuIcon');
                        if(buttonTextEl) buttonTextEl.textContent = "더 많은 메뉴 보기";
                        if(iconEl) iconEl.classList.replace('fa-chevron-up', 'fa-chevron-down');
                    }
                });
            });
        }
        
        function showError(message) {
            if(UIElements.errorMessageElement) UIElements.errorMessageElement.textContent = message;
            if(UIElements.errorModal) UIElements.errorModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                if(UIElements.errorModalContentEl) {
                    UIElements.errorModalContentEl.classList.remove('scale-95', 'opacity-0');
                    UIElements.errorModalContentEl.classList.add('scale-100', 'opacity-100');
                }
            });
        }
        function hideErrorModal() {
            if(UIElements.errorModalContentEl){
                UIElements.errorModalContentEl.classList.add('scale-95', 'opacity-0');
                UIElements.errorModalContentEl.classList.remove('scale-100', 'opacity-100');
            }
            if(UIElements.errorModal) {
                setTimeout(() => UIElements.errorModal.classList.add('hidden'), 300);
            }
        }
        if(UIElements.closeErrorModalButton) UIElements.closeErrorModalButton.addEventListener('click', hideErrorModal);
        if(UIElements.confirmErrorModalButton) UIElements.confirmErrorModalButton.addEventListener('click', hideErrorModal);

        function showSubstituteModal() {
            if(UIElements.ingredientToSubstituteInput) UIElements.ingredientToSubstituteInput.value = ''; 
            if(UIElements.substitutionReasonInput) UIElements.substitutionReasonInput.value = '';
            if(UIElements.substituteModal) UIElements.substituteModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                if(UIElements.substituteModalContent){
                    UIElements.substituteModalContent.classList.remove('scale-95', 'opacity-0');
                    UIElements.substituteModalContent.classList.add('scale-100', 'opacity-100');
                }
            });
        }
        function hideSubstituteModal() {
             if(UIElements.substituteModalContent){
                UIElements.substituteModalContent.classList.add('scale-95', 'opacity-0');
                UIElements.substituteModalContent.classList.remove('scale-100', 'opacity-100');
            }
            if(UIElements.substituteModal) {
                setTimeout(() => UIElements.substituteModal.classList.add('hidden'), 300);
            }
        }
        if(UIElements.substituteIngredientButton) UIElements.substituteIngredientButton.addEventListener('click', showSubstituteModal);
        if(UIElements.closeSubstituteModalButton) UIElements.closeSubstituteModalButton.addEventListener('click', hideSubstituteModal);

        function setLoading(isLoading, message = "AI 셰프가 열심히 요리 중...") {
            const allActionButtons = [
                UIElements.generateRecipeButton, UIElements.recommendDishButton, UIElements.searchSpecificDishButton, 
                UIElements.generateLeftoverRecipeButton, UIElements.generateMealPlanButton, UIElements.generateThemedRecipesButton, 
                UIElements.confirmSubstituteButton, UIElements.analyzeNutritionButton, UIElements.generateShoppingListButton,
                UIElements.getBeveragePairingButton, UIElements.searchCookingTermButton, UIElements.convertUnitButton,
                UIElements.getSeasonalRecipesButton, UIElements.saveToRecipeBookButton,
                UIElements.analyzeAndLogCalorieButton, UIElements.generateDietPlanButton, UIElements.calculateExerciseCaloriesButton,
                UIElements.logWaterIntakeButton, UIElements.getDietTipButton
            ];
            if (isLoading) {
                if(UIElements.loadingIndicator) UIElements.loadingIndicator.classList.remove('hidden');
                if(UIElements.loadingText) UIElements.loadingText.textContent = message;
                allActionButtons.forEach(btn => { if(btn) {btn.disabled = true; btn.classList.add('opacity-70', 'cursor-not-allowed');} });
            } else {
                if(UIElements.loadingIndicator) UIElements.loadingIndicator.classList.add('hidden');
                allActionButtons.forEach(btn => { if(btn) {btn.disabled = false; btn.classList.remove('opacity-70', 'cursor-not-allowed');} });
            }
        }

        async function callGeminiAPI(prompt, isAuxiliaryAction = false) {
            setLoading(true, isAuxiliaryAction ? "AI가 정보를 처리 중입니다..." : "최고의 레시피를 구상 중...");
            
            const API_ENDPOINT = "https://magenta-morning-find.glitch.me/generate"; 
            const payload = { message: prompt };
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });

                if (!response.ok) {
                    let errorDetails = `서버 응답: ${response.statusText || '알 수 없는 오류'}`; 
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.message || errorData.error || (typeof errorData === 'object' ? JSON.stringify(errorData) : String(errorData));
                        if (!errorDetails || errorDetails === '{}' || errorDetails.trim() === "") { 
                           errorDetails = `서버 응답: ${response.statusText || '오류 내용 없음'}`; 
                        }
                    } catch (jsonError) {
                        console.warn("API 오류 응답이 JSON이 아니므로 텍스트로 읽기를 시도합니다.", jsonError);
                        try {
                            const errorText = await response.text();
                            errorDetails = errorText.trim() || `서버 응답: ${response.statusText || '오류 내용 없음'}`;
                        } catch (textError) {
                            console.error("API 오류 응답을 텍스트로 읽는 데 실패했습니다.", textError);
                            errorDetails = `서버 응답: ${response.statusText || '알 수 없는 오류'}, 응답 본문 읽기 실패`;
                        }
                    }
                    const errorMsg = `API 요청 실패 (${response.status}): ${errorDetails}`;
                    console.error("API Error Details:", errorDetails); 
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                
                if (result.text) { 
                    return result.text;
                } else if (result.generated_text) { 
                    return result.generated_text;
                } else if (result.reply) { 
                    return result.reply;
                } else if (typeof result === 'string') { 
                    return result;
                }
                else if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) { // Gemini 표준 응답 형식
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("API 응답에서 텍스트를 추출할 수 없거나, 예상치 못한 구조입니다:", result);
                    throw new Error('AI로부터 유효한 텍스트 응답을 받지 못했습니다.');
                }
            } catch (error) { 
                console.error("API 호출 중 예외 발생:", error.name, error.message, error.stack); 
                showError(error.message || "API 통신 중 문제가 발생했습니다. 네트워크 연결을 확인하거나 잠시 후 다시 시도해주세요.");
                return null;
            } finally {
                setLoading(false);
            }
        }
        
        function applyBoldMarkdown(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }
        
        function extractRecipeTitle(recipeText) {
            if (!recipeText) return "제목 없는 레시피";
            let title = "제목 없는 레시피";
            const patterns = [
                /^\s*(?:(?:##\s*)?\*\*(?:요리\s*)?이름:\*\*|##\s*(?:요리\s*)?이름:)\s*(.+)/im, 
                /^\s*\*\*(?:요리\s*)?이름:\*\*\s*(.+)/im,                                
                /^\s*(?:요리\s*)?이름:\s*(.+)/im,                                       
                /^\s*##\s*(?!.*\*\*이름:\*\*)(.+)/im, 
                /^\s*\*\*(?!이름:\s*)(.+?)\*\*/im,      
                /^\s*([^#*:\n][^:\n]*)/im 
            ];
            for (const pattern of patterns) {
                const match = recipeText.match(pattern);
                if (match && match[1] && match[1].trim() !== "") {
                    title = match[1].trim();
                    break; 
                }
            }
            return title.replace(/✨/g, '').replace(/\*\*/g, '').replace(/##/g, '').trim().substring(0, 50) || "제목 없는 레시피";
        }


        function displayFormattedText(rawText, containerElement, title, outputType = "recipe") {
            if (!(containerElement instanceof HTMLElement)) {
                console.error(`displayFormattedText: containerElement (${containerElement ? containerElement.id : 'N/A'})가 유효한 HTML 요소가 아닙니다. Title: "${title}"`);
                showError(`콘텐츠를 표시할 내부 영역을 찾을 수 없습니다: ${title}`);
                return;
            }

            if (!rawText || rawText.trim() === "") {
                containerElement.innerHTML = `<p class="text-gray-500 italic text-center py-8">표시할 내용이 없습니다.</p>`;
                if (UIElements.recipeOutputSection && (outputType === "recipe" || outputType === "substitution")) {
                    UIElements.recipeOutputSection.classList.remove('hidden'); 
                } else if (UIElements[outputType + "ResultWrapper"]) { 
                    UIElements[outputType + "ResultWrapper"].classList.remove('hidden');
                }
                if (outputType === "recipe" && UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden');
                return;
            }

            containerElement.innerHTML = ''; 
            
            let cleanBaseTitle = title.replace(/✨/g, '').trim();

            if (outputType === "recipe" || outputType === "substitution") {
                if (outputType === "recipe") { 
                    currentRecipeFullText = rawText; 
                    currentRecipeTitle = extractRecipeTitle(rawText); 
                    cleanBaseTitle = `"${currentRecipeTitle}" 레시피`; 
                    if(UIElements.recipeOutputTitle) UIElements.recipeOutputTitle.textContent = cleanBaseTitle;

                    if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.remove('hidden'); 
                    if(UIElements.nutritionAnalysisResultDiv) {
                        UIElements.nutritionAnalysisResultDiv.classList.add('hidden');
                        UIElements.nutritionAnalysisResultDiv.innerHTML = ''; 
                    }
                    if(UIElements.shoppingListResultDiv) {
                        UIElements.shoppingListResultDiv.classList.add('hidden');
                        UIElements.shoppingListResultDiv.innerHTML = '';
                    }
                } else if (outputType === "substitution") { 
                     if(UIElements.recipeOutputTitle) UIElements.recipeOutputTitle.textContent = cleanBaseTitle;
                    if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.remove('hidden'); 
                }
            }

            const lines = rawText.split('\n');
            let currentList = null; 
            let isFirstTitleInCard = true; 

            lines.forEach(line => {
                let processedLine = line.trim();
                if (!processedLine) return; 

                const buttonPatternRegex = /(?:->\s*)?(?:\[|\uFF3B)([^\]\uFF3D]+?)(?:\]|\uFF3D)\s*전체 레시피 보기/;
                if ((outputType === "recommendation" || outputType === "themedRecipes" || outputType === "seasonalRecipe") && buttonPatternRegex.test(processedLine)) {
                    const dishNameMatch = processedLine.match(buttonPatternRegex);
                    if (dishNameMatch && dishNameMatch[1]) {
                        const dishName = dishNameMatch[1].trim();
                        const pButton = document.createElement('p');
                        pButton.classList.add('mt-6', 'text-center'); 
                        const button = document.createElement('button');
                        button.innerHTML = `<i class="fas fa-utensils mr-2"></i> ${applyBoldMarkdown(dishName)} 레시피 보기`;
                        button.classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'text-white', 'font-semibold', 'py-3', 'px-6', 'rounded-lg', 'shadow-md', 'hover:shadow-lg', 'transition-all', 'duration-150', 'text-base', 'inline-flex', 'items-center');
                        button.onclick = () => {
                            if(UIElements.specificDishNameInput) UIElements.specificDishNameInput.value = dishName; 
                            if (UIElements.tabButtons && UIElements.tabContents && UIElements.searchSpecificDishButton) {
                                UIElements.tabButtons.forEach(btn => btn.classList.remove('active')); 
                                const tab3Button = document.querySelector('button[data-tab="tab3"]');
                                if(tab3Button) tab3Button.classList.add('active'); 
                                UIElements.tabContents.forEach(content => content.classList.remove('active')); 
                                const tab3Content = document.getElementById('tab3');
                                if(tab3Content) tab3Content.classList.add('active'); 
                                [UIElements.recommendationDisplayWrapper, UIElements.themedRecipesDisplayWrapper, UIElements.seasonalRecipeResultWrapper].forEach(wrapper => {
                                    if(wrapper) wrapper.classList.add('hidden');
                                });
                                UIElements.searchSpecificDishButton.click(); 
                            }
                        };
                        pButton.appendChild(button);
                        containerElement.appendChild(pButton);
                        return; 
                    }
                }
                
                if (outputType === "mealPlan" && /^(월요일|화요일|수요일|목요일|금요일|토요일|일요일)\s*:/i.test(processedLine)) {
                    if (currentList) { containerElement.appendChild(currentList); currentList = null; } 
                    const parts = processedLine.split(/:(.+)/); 
                    const day = parts[0].trim();
                    const mealDesc = parts[1] ? parts[1].trim() : "추천 메뉴 정보 없음";
                    
                    const mealItemDiv = document.createElement('div');
                    mealItemDiv.classList.add('meal-plan-item');
                    
                    const dayStrong = document.createElement('strong');
                    dayStrong.textContent = day + ": ";
                    mealItemDiv.appendChild(dayStrong);
                    
                    const descSpan = document.createElement('span');
                    const mealNameMatch = mealDesc.match(/^([^-(]+)/);
                    const mealNameForButton = mealNameMatch ? mealNameMatch[1].trim() : mealDesc.substring(0,15); 

                    descSpan.innerHTML = applyBoldMarkdown(mealDesc); 
                    mealItemDiv.appendChild(descSpan);

                    const searchRecipeBtn = document.createElement('button');
                    searchRecipeBtn.innerHTML = `<i class="fas fa-search mr-1"></i> "${mealNameForButton}" 레시피 검색`;
                    searchRecipeBtn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700', 'font-medium', 'py-1', 'px-2', 'rounded', 'text-xs', 'block', 'mt-2');
                    searchRecipeBtn.onclick = () => {
                        if(UIElements.specificDishNameInput) UIElements.specificDishNameInput.value = mealNameForButton;
                        if (UIElements.tabButtons && UIElements.tabContents && UIElements.searchSpecificDishButton) {
                            UIElements.tabButtons.forEach(btn => btn.classList.remove('active'));
                            const tab3Button = document.querySelector('button[data-tab="tab3"]');
                            if(tab3Button) tab3Button.classList.add('active');
                            UIElements.tabContents.forEach(content => content.classList.remove('active'));
                            const tab3Content = document.getElementById('tab3');
                            if(tab3Content) tab3Content.classList.add('active');
                            if(UIElements.mealPlanDisplayWrapper) UIElements.mealPlanDisplayWrapper.classList.add('hidden');
                            UIElements.searchSpecificDishButton.click();
                        }
                    };
                    mealItemDiv.appendChild(searchRecipeBtn);
                    containerElement.appendChild(mealItemDiv);
                    return; 
                }
                
                 if ((outputType === "themedRecipes" || outputType === "seasonalRecipe") && /^\d+\.\s*([^:]+):\s*(.+)/.test(processedLine)) {
                     if (currentList) { containerElement.appendChild(currentList); currentList = null; }
                    const itemMatch = processedLine.match(/^\d+\.\s*([^:]+):\s*(.+)/);
                    const recipeName = itemMatch[1].trim();
                    const recipeDesc = itemMatch[2].trim();

                    const themedItemDiv = document.createElement('div');
                    themedItemDiv.classList.add(outputType === "themedRecipes" ? 'themed-recipe-item' : 'seasonal-recipe-item'); // 클래스 구분

                    const nameStrong = document.createElement('strong');
                    nameStrong.textContent = recipeName;
                    themedItemDiv.appendChild(nameStrong);

                    const descP = document.createElement('p');
                    descP.textContent = recipeDesc;
                    descP.classList.add('text-sm', 'text-gray-600', 'mt-1');
                    themedItemDiv.appendChild(descP);
                    
                    const pButton = document.createElement('p');
                    pButton.classList.add('mt-2'); 
                    const button = document.createElement('button');
                    button.innerHTML = `<i class="fas fa-utensils mr-2"></i> ${applyBoldMarkdown(recipeName)} 레시피 보기`;
                    button.classList.add('bg-indigo-100', 'hover:bg-indigo-200', 'text-indigo-700', 'font-medium', 'py-1', 'px-2', 'rounded', 'text-xs');

                    button.onclick = () => {
                        if(UIElements.specificDishNameInput) UIElements.specificDishNameInput.value = recipeName; 
                        if (UIElements.tabButtons && UIElements.tabContents && UIElements.searchSpecificDishButton) {
                            UIElements.tabButtons.forEach(btn => btn.classList.remove('active')); 
                            const tab3Button = document.querySelector('button[data-tab="tab3"]');
                            if(tab3Button) tab3Button.classList.add('active'); 
                            UIElements.tabContents.forEach(content => content.classList.remove('active')); 
                            const tab3Content = document.getElementById('tab3');
                            if(tab3Content) tab3Content.classList.add('active'); 
                            if(UIElements.themedRecipesDisplayWrapper) UIElements.themedRecipesDisplayWrapper.classList.add('hidden');
                            if(UIElements.seasonalRecipeResultWrapper) UIElements.seasonalRecipeResultWrapper.classList.add('hidden');
                            UIElements.searchSpecificDishButton.click(); 
                        }
                    };
                    pButton.appendChild(button);
                    themedItemDiv.appendChild(pButton);
                    containerElement.appendChild(themedItemDiv);
                    return;
                }

                // 제목 처리 로직 개선
                let headingLevel = 0;
                let titleText = processedLine;
                let isSectionHeader = false; 

                const sectionHeaderColonMatch = processedLine.match(/^(\*\*.+?:\*\*|[^#\n*]+?:)\s*(.*)/);
                if (sectionHeaderColonMatch && !processedLine.match(/^(\d+\.|\*|-)\s/)) { 
                    if (currentList) { containerElement.appendChild(currentList); currentList = null; }
                    const headerP = document.createElement('p');
                    headerP.classList.add('text-gray-800', 'mb-2');
                    if (!isFirstTitleInCard) headerP.classList.add('mt-4');
                    
                    let labelPart = sectionHeaderColonMatch[1].trim();
                    let contentPart = sectionHeaderColonMatch[2] ? sectionHeaderColonMatch[2].trim() : "";
                    
                    headerP.innerHTML = `${applyBoldMarkdown(labelPart)} ${applyBoldMarkdown(contentPart)}`;
                    containerElement.appendChild(headerP);
                    isFirstTitleInCard = false;
                    isSectionHeader = true;
                } else {
                    if (processedLine.startsWith('## ')) { headingLevel = 2; titleText = processedLine.substring(3).trim(); }
                    else if (processedLine.startsWith('### ')) { headingLevel = 3; titleText = processedLine.substring(4).trim(); }
                    else if (processedLine.startsWith('#### ')) { headingLevel = 4; titleText = processedLine.substring(5).trim(); }

                    if (headingLevel > 0) {
                        if (currentList) { containerElement.appendChild(currentList); currentList = null; }
                        const hTag = document.createElement(`h${headingLevel}`);
                        
                        hTag.innerHTML = applyBoldMarkdown(titleText); 
                        
                        if (headingLevel === 2) hTag.classList.add('text-2xl', 'font-bold', 'text-indigo-700', 'mb-4', 'pb-2', 'border-b', 'border-indigo-200');
                        else if (headingLevel === 3) hTag.classList.add('text-xl', 'font-semibold', 'text-indigo-600', 'mb-3', 'pb-1', 'border-b', 'border-indigo-100');
                        else if (headingLevel === 4) hTag.classList.add('text-lg', 'font-medium', 'text-indigo-500', 'mb-2');
                        
                        if (isFirstTitleInCard) { hTag.classList.add('mt-0'); isFirstTitleInCard = false; } 
                        else { hTag.classList.add('mt-6'); }
                        containerElement.appendChild(hTag);
                        isSectionHeader = true; 
                    }
                }

                if (isSectionHeader) return; 

                const listItemRegex = /^(\d+\.|\*|-)\s*(.*)/;
                const listItemMatch = processedLine.match(listItemRegex);
                if (listItemMatch) {
                    const listMarker = listItemMatch[1]; 
                    let listItemText = listItemMatch[2]; 
                    const isOrdered = listMarker.match(/^\d+\./); 

                    if (!currentList || (isOrdered && currentList.tagName !== 'OL') || (!isOrdered && currentList.tagName !== 'UL')) {
                        if (currentList) containerElement.appendChild(currentList); 
                        currentList = document.createElement(isOrdered ? 'ol' : 'ul'); 
                        currentList.classList.add('list-inside', 'space-y-1', 'mb-3', 'text-gray-700', 'pl-4'); 
                        if(isOrdered) currentList.classList.add('list-decimal'); else currentList.classList.add('list-disc');
                    }
                    const li = document.createElement('li');
                    li.innerHTML = applyBoldMarkdown(listItemText); 
                    currentList.appendChild(li);
                    return; 
                }
                
                if (currentList) { containerElement.appendChild(currentList); currentList = null; } 
                const p = document.createElement('p');
                p.innerHTML = applyBoldMarkdown(processedLine); 
                p.classList.add('text-gray-700', 'leading-relaxed', 'mb-3'); 
                containerElement.appendChild(p);
            });

            if (currentList) { containerElement.appendChild(currentList); } 
            
            if (UIElements[outputType + "ResultWrapper"]) { 
                UIElements[outputType + "ResultWrapper"].classList.remove('hidden');
            } else if (UIElements[outputType + "DisplayWrapper"]) { 
                 UIElements[outputType + "DisplayWrapper"].classList.remove('hidden');
            } else if ((outputType === "recipe" || outputType === "substitution") && UIElements.recipeOutputSection) { 
                 UIElements.recipeOutputSection.classList.remove('hidden');
            } else if (outputType === "nutrition" && UIElements.nutritionAnalysisResultDiv) {
                 UIElements.nutritionAnalysisResultDiv.classList.remove('hidden');
                 if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden'); 
            } else if (outputType === "shoppingList" && UIElements.shoppingListResultDiv) {
                 UIElements.shoppingListResultDiv.classList.remove('hidden');
                 if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden'); 
            }
            
            let scrollTarget = containerElement;
            if (UIElements.recipeOutputSection && UIElements.recipeOutputSection.contains(containerElement)) {
                scrollTarget = UIElements.recipeOutputSection;
            } else if (UIElements[outputType + "ResultWrapper"] && UIElements[outputType + "ResultWrapper"].contains(containerElement)) {
                scrollTarget = UIElements[outputType + "ResultWrapper"];
            } else if (UIElements[outputType + "DisplayWrapper"] && UIElements[outputType + "DisplayWrapper"].contains(containerElement)) {
                scrollTarget = UIElements[outputType + "DisplayWrapper"];
            }
            if (scrollTarget) {
                scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- 기존 기능 이벤트 리스너 ---
        if (UIElements.generateRecipeButton) {
            UIElements.generateRecipeButton.addEventListener('click', async () => {
                const dietaryPreferencesVal = UIElements.dietaryPreferencesInput ? UIElements.dietaryPreferencesInput.value.trim() : '특별한 제한 없음';
                const cuisineStyleVal = UIElements.cuisineStyleInput ? UIElements.cuisineStyleInput.value.trim() : '모든 스타일 환영';

                if (dietaryPreferencesVal === '특별한 제한 없음' && cuisineStyleVal === '모든 스타일 환영') {
                     showError('레시피를 추천받으려면 식단 선호도 또는 요리 스타일 중 하나 이상을 입력해주세요.');
                     return;
                }
                
                const prompt = `
당신은 사용자의 입력을 기반으로 맞춤형 레시피를 생성하는 AI 요리 전문가입니다.
사용자 입력:
* 식단 선호도/제한사항: ${dietaryPreferencesVal}
* 선호 요리 스타일: ${cuisineStyleVal}

요청:
위 정보를 바탕으로, 사용자가 입력한 선호도와 스타일에 맞는 요리를 추천하고 해당 요리에 필요한 모든 재료 목록을 포함하여 레시피 1개를 제안해주세요.

**요리 이름:**
[AI가 제안하는 요리 이름]

**간단 설명:**
[요리에 대한 매력적인 2-3문장 설명]

**난이도:**
[예: 초급 / 중급 / 고급]

**예상 소요 시간:**
준비: [X분] | 조리: [Y분]

**분량:**
[Z인분]

**필요한 재료:**
* [재료 1] - [양] (예: 양파 - 1개)
* [재료 2] - [양] (예: 다진 마늘 - 1큰술)
* ... (모든 필요 재료 명시)

**만드는 방법:**
1. [조리 단계 1 상세 설명]
2. [조리 단계 2 상세 설명]
3. ...

**꿀팁 (선택 사항):**
* [요리를 더 맛있게 만들거나 변형할 수 있는 팁]

결과는 한국어로, 모든 섹션을 포함하여 명확하고 따라하기 쉽게 작성해주세요. 각 섹션 제목은 **굵은 글씨**와 함께 콜론(:)으로 끝나도록 해주세요. (예: **요리 이름:**). 리스트 항목 내에서도 **굵은 글씨** 마크다운을 사용할 수 있습니다.
                `;
                const recipeText = await callGeminiAPI(prompt);
                if (recipeText && UIElements.recipeDisplay) displayFormattedText(recipeText, UIElements.recipeDisplay, "AI 추천 레시피", "recipe");
            });
        }

        if (UIElements.recommendDishButton) {
            UIElements.recommendDishButton.addEventListener('click', async () => {
                const keywordsVal = UIElements.whatToEatKeywordsInput ? (UIElements.whatToEatKeywordsInput.value.trim() || "특별한 조건 없음") : "특별한 조건 없음";
                let recommendationPromptPart;
                if (keywordsVal === "특별한 조건 없음") {
                    recommendationPromptPart = `사용자가 "오늘 뭐 먹지?" 고민을 하고 있지만 특별한 키워드는 입력하지 않았습니다. 사용자를 위해 창의적이고 흥미로운 요리 1가지와 그 요리를 추천하는 간단한 이유를 자유롭게 제안해주세요.`;
                } else {
                    recommendationPromptPart = `사용자가 "오늘 뭐 먹지?" 고민을 하고 있습니다. 다음 키워드를 참고하여, 창의적이고 흥미로운 요리 1가지와 그 요리를 추천하는 간단한 이유를 제안해주세요.\n* 사용자 키워드: ${keywordsVal}`;
                }
                
                const prompt = `
${recommendationPromptPart}

응답 형식:
**추천 요리:** [요리 이름]
**추천 이유:** [2-3문장으로 된 매력적인 추천 이유]
그리고 다음 줄에 정확히 "-> [요리 이름] 전체 레시피 보기" 형식으로 해당 요리의 레시피를 볼 수 있는 버튼 자리표시자를 만들어주세요. 대괄호 안에는 추천한 요리 이름을 정확히 넣어주세요. 이 버튼 자리표시자는 다른 텍스트 없이 단독 라인으로 제공해주세요.

결과는 한국어로 작성해주세요. 각 제목은 **굵은 글씨**와 함께 콜론(:)으로 끝나도록 해주세요.
                `;
                const recommendationText = await callGeminiAPI(prompt, true);
                if (recommendationText && UIElements.recommendationDisplay) displayFormattedText(recommendationText, UIElements.recommendationDisplay, "오늘의 추천", "recommendation");
            });
        }

        if (UIElements.searchSpecificDishButton) {
            UIElements.searchSpecificDishButton.addEventListener('click', async () => {
                const dishNameVal = UIElements.specificDishNameInput ? UIElements.specificDishNameInput.value.trim() : "";

                if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                if (UIElements.recipeDisplay) UIElements.recipeDisplay.innerHTML = '<p class="text-gray-500 italic text-center py-8">결과가 여기에 표시됩니다.</p>';
                if (UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden');
                if (UIElements.nutritionAnalysisResultDiv) {
                    UIElements.nutritionAnalysisResultDiv.classList.add('hidden');
                    UIElements.nutritionAnalysisResultDiv.innerHTML = '';
                }
                if (UIElements.shoppingListResultDiv) {
                    UIElements.shoppingListResultDiv.classList.add('hidden');
                    UIElements.shoppingListResultDiv.innerHTML = '';
                }
                currentRecipeFullText = "";
                currentRecipeTitle = "";


                if (!dishNameVal) {
                    showError('검색할 요리 이름을 입력해주세요.');
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden'); 
                    return;
                }
                
                const prompt = `
사용자가 "${dishNameVal}" 요리의 레시피를 찾고 있습니다.
이 요리에 대한 상세한 레시피를 다음 형식에 맞춰 제공해주세요.

**요리 이름:**
${dishNameVal} (또는 AI가 판단한 정확한 요리 이름)

**간단 설명:**
[요리에 대한 매력적인 2-3문장 설명]

**난이도:**
[예: 초급 / 중급 / 고급]

**예상 소요 시간:**
준비: [X분] | 조리: [Y분]

**분량:**
[Z인분]

**필요한 재료:**
* [재료 1] - [양]
* [재료 2] - [양]
* ...

**만드는 방법:**
1. [조리 단계 1 상세 설명]
2. [조리 단계 2 상세 설명]
3. ...

**꿀팁 (선택 사항):**
* [요리를 더 맛있게 만들거나 변형할 수 있는 팁]

결과는 한국어로, 모든 섹션을 포함하여 명확하고 따라하기 쉽게 작성해주세요. 각 섹션 제목은 **굵은 글씨**와 함께 콜론(:)으로 끝나도록 해주세요. 리스트 항목 내에서도 **굵은 글씨** 마크다운을 사용할 수 있습니다.
                `;
                const recipeText = await callGeminiAPI(prompt);

                if (recipeText && recipeText.trim() !== "" && UIElements.recipeDisplay) {
                    displayFormattedText(recipeText, UIElements.recipeDisplay, `"${dishNameVal}" 레시피`, "recipe");
                } else if (recipeText === null) { 
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                } else { 
                    showError(`"${dishNameVal}"에 대한 레시피를 찾을 수 없거나 AI 응답이 비어있습니다. 다른 검색어를 사용하거나 잠시 후 다시 시도해 주세요.`);
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                }
            });
        }
        
        if (UIElements.generateLeftoverRecipeButton) {
            UIElements.generateLeftoverRecipeButton.addEventListener('click', async () => {
                const ingredientsVal = UIElements.leftoverIngredientsInput ? UIElements.leftoverIngredientsInput.value.trim() : "";
                const cuisineStyleVal = UIElements.leftoverCuisineStyleInput ? UIElements.leftoverCuisineStyleInput.value.trim() : "상관 없음";

                if (!ingredientsVal) {
                    showError('냉장고 속 재료를 하나 이상 입력해주세요!');
                    return;
                }
                
                const prompt = `
당신은 사용자가 제공한 '냉장고 속 재료'를 최대한 활용하여 맛있는 요리를 만드는 AI 요리사입니다. 추가 재료는 최소화하거나, 필요 없을 수도 있습니다.
사용자 입력:
* 냉장고 속 재료: ${ingredientsVal}
* 선호 요리 스타일 (선택 사항): ${cuisineStyleVal}

요청:
위 '냉장고 속 재료'를 중심으로 하는 레시피 1개를 제안해주세요. 다음 형식을 따라주세요.

**요리 이름:**
[AI가 제안하는 요리 이름]

**간단 설명:**
[냉장고 속 재료를 어떻게 활용했는지 강조하는 2-3문장 설명]

**난이도:**
[예: 초급 / 중급 / 고급]

**예상 소요 시간:**
준비: [X분] | 조리: [Y분]

**분량:**
[Z인분]

**필요한 재료:**
(주로 '냉장고 속 재료'를 사용하며, 만약 아주 약간의 추가 양념/재료가 필요하다면 명시)
* [재료 1] - [양]
* ...

**만드는 방법:**
1. [조리 단계 1 상세 설명]
2. [조리 단계 2 상세 설명]
3. ...

**활용 팁 (선택 사항):**
* [남은 재료를 다르게 활용하거나, 요리를 더 맛있게 하는 팁]

결과는 한국어로, 모든 섹션을 포함하여 명확하고 따라하기 쉽게 작성해주세요. 각 섹션 제목은 **굵은 글씨**와 함께 콜론(:)으로 끝나도록 해주세요. 리스트 항목 내에서도 **굵은 글씨** 마크다운을 사용할 수 있습니다.
                `;
                const recipeText = await callGeminiAPI(prompt);
                if (recipeText && UIElements.recipeDisplay) displayFormattedText(recipeText, UIElements.recipeDisplay, "냉장고 파먹기 레시피", "recipe");
            });
        }

        if (UIElements.generateMealPlanButton) {
            UIElements.generateMealPlanButton.addEventListener('click', async () => {
                const preferences = UIElements.mealPlanPreferencesInput ? UIElements.mealPlanPreferencesInput.value.trim() : "균형 잡힌 일반적인 식단";
                const prompt = `
사용자의 다음 요청에 따라 7일치 저녁 식단 아이디어를 요일별(월요일부터 일요일까지)로 제안해주세요.
각 아이디어는 **"요일: 요리 이름 - 간단한 설명 (1~2줄)"** 형식으로 한 줄에 하나씩 작성해주세요.
예시:
월요일: 닭갈비 - 매콤한 양념에 볶아 온 가족이 즐기기 좋은 메뉴
화요일: 된장찌개 - 구수하고 든든한 한국인의 소울푸드

사용자 요청: "${preferences}"
`;
                const mealPlanText = await callGeminiAPI(prompt, true);
                if (mealPlanText && UIElements.mealPlanDisplay) {
                    displayFormattedText(mealPlanText, UIElements.mealPlanDisplay, "AI 추천 주간 식단", "mealPlan");
                }
            });
        }
        
        if (UIElements.generateThemedRecipesButton) {
            UIElements.generateThemedRecipesButton.addEventListener('click', async () => {
                const theme = UIElements.themeKeywordsInput ? UIElements.themeKeywordsInput.value.trim() : "";
                if (!theme) {
                    showError('원하는 테마나 상황을 입력해주세요. (예: 생일 파티, 캠핑 요리)');
                    return;
                }
                const prompt = `
사용자가 다음 테마 또는 상황에 맞는 요리 아이디어 2~3가지를 찾고 있습니다: "${theme}"
각 요리 아이디어에 대해 **"번호. 요리 이름: 간단한 설명 (1~2줄)"** 형식으로 제안해주세요.
각 요리 이름 뒤에는 해당 레시피를 검색할 수 있도록 "-> [요리 이름] 전체 레시피 보기" 형식의 버튼 자리표시자를 추가해주세요.

예시:
테마: "비 오는 날"
1. 김치전: 바삭하고 매콤한 맛이 일품인 한국의 대표적인 비 오는 날 음식입니다. -> [김치전] 전체 레시피 보기
2. 해물 칼국수: 따끈하고 시원한 국물에 해물이 듬뿍 들어간 칼국수입니다. -> [해물 칼국수] 전체 레시피 보기

결과는 한국어로 작성해주세요.
`;
                const themedRecipesText = await callGeminiAPI(prompt, true);
                if (themedRecipesText && UIElements.themedRecipesDisplay) {
                    displayFormattedText(themedRecipesText, UIElements.themedRecipesDisplay, `"${theme}" 테마 요리 추천`, "themedRecipes");
                }
            });
        }

        if (UIElements.confirmSubstituteButton) {
            UIElements.confirmSubstituteButton.addEventListener('click', async () => {
                const ingredientToSub = UIElements.ingredientToSubstituteInput ? UIElements.ingredientToSubstituteInput.value.trim() : "";
                const reasonForSub = UIElements.substitutionReasonInput ? UIElements.substitutionReasonInput.value.trim() : "";

                if (!ingredientToSub) {
                    showError("대체하고 싶은 재료 이름을 입력해주세요."); 
                    return;
                }
                if (!currentRecipeFullText) {
                    showError("먼저 레시피를 조회해주세요.");
                    hideSubstituteModal();
                    return;
                }

                hideSubstituteModal(); 
                
                let reasonText = "";
                if (reasonForSub) {
                    reasonText = `대체하려는 이유는 다음과 같습니다: "${reasonForSub}". `;
                }

                const prompt = `
현재 사용자는 다음 레시피를 보고 있습니다:
--- 레시피 시작 ---
${currentRecipeFullText}
--- 레시피 끝 ---

이 레시피에서 "${ingredientToSub}" 재료를 대체할 만한 다른 재료 2~3가지를 추천해주세요. ${reasonText}각 대체 재료에 대해, 사용량은 어떻게 조절해야 하는지, 그리고 대체 시 특별히 주의할 점이나 맛의 변화가 있다면 함께 설명해주세요. 결과는 명확하고 간결하게 목록 형태로 제공해주세요.

예시:
**"${ingredientToSub}" 대체 재료 추천:**
* **[대체 재료 1]:** [설명, 양 조절 팁, 주의사항 등]
* **[대체 재료 2]:** [설명, 양 조절 팁, 주의사항 등]
`;
                const substitutionText = await callGeminiAPI(prompt, true);
                if (substitutionText && UIElements.recipeDisplay) {
                    displayFormattedText(substitutionText, UIElements.recipeDisplay, `"${ingredientToSub}" 재료 대체 추천`, "substitution");
                }
            });
        }

        if (UIElements.analyzeNutritionButton) {
            UIElements.analyzeNutritionButton.addEventListener('click', async () => {
                if (!currentRecipeFullText) {
                    showError("먼저 레시피를 조회하여 영양 정보를 분석할 내용을 준비해주세요.");
                    return;
                }
                 if (!UIElements.nutritionAnalysisResultDiv) { 
                    console.error("Error: nutritionAnalysisResultDiv is not a valid HTMLElement or is null/undefined.");
                    showError("영양 정보를 표시할 영역을 찾을 수 없습니다. (앱 내부 오류)");
                    return;
                }
                const prompt = `
다음 레시피의 주요 영양 정보를 1인분 기준으로 분석해주세요. (만약 레시피에 분량 정보가 있다면 그것을 참고하고, 없다면 일반적인 1인분 기준으로 가정해주세요.)
예상되는 총 칼로리, 탄수화물(g), 단백질(g), 지방(g) 함량을 알려주고, 가능하다면 나트륨(mg) 정보도 간략히 포함해주세요.
결과는 명확한 목록 형태로, 각 항목과 수치를 함께 보여주세요. (예: **총 칼로리:** 약 XXX kcal). 각 영양소 뒤에는 단위를 명시해주세요.

--- 레시피 내용 ---
${currentRecipeFullText}
--- 레시피 내용 끝 ---
`;
                const nutritionText = await callGeminiAPI(prompt, true);
                if (nutritionText) {
                    UIElements.nutritionAnalysisResultDiv.innerHTML = ''; 
                    displayFormattedText(nutritionText, UIElements.nutritionAnalysisResultDiv, "영양 정보 분석 결과 (1인분 기준)", "nutrition"); 
                }
            });
        }

        if (UIElements.generateShoppingListButton) {
            UIElements.generateShoppingListButton.addEventListener('click', () => {
                if (!currentRecipeFullText) {
                    showError("먼저 레시피를 조회하여 장보기 목록을 생성할 내용을 준비해주세요.");
                    return;
                }
                if (!UIElements.shoppingListResultDiv) { 
                    console.error("Error: shoppingListResultDiv is not a valid HTMLElement or is null/undefined.");
                    showError("장보기 목록을 표시할 영역을 찾을 수 없습니다. (앱 내부 오류)");
                    return;
                }

                const ingredientsSectionRegex = /\*\*필요한 재료:\*\*\s*([\s\S]*?)(?=\n\*\*|$)/i;
                const match = currentRecipeFullText.match(ingredientsSectionRegex);

                if (match && match[1]) {
                    const ingredientsText = match[1].trim();
                    const ingredientsArray = ingredientsText.split('\n').map(item => item.replace(/^\s*\*\s*/, '').trim()).filter(item => item); 
                    
                    if (ingredientsArray.length > 0) {
                        UIElements.shoppingListResultDiv.innerHTML = `
                            <h3 class="text-lg font-semibold text-indigo-600 mb-3">🛒 장보기 목록</h3>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                ${ingredientsArray.map(item => `<li>${applyBoldMarkdown(item)}</li>`).join('')}
                            </ul>
                            <button id="copyShoppingListButton" class="action-button mt-4 text-sm">
                                <i class="fas fa-copy mr-2"></i> 목록 복사하기
                            </button>
                        `;
                        UIElements.shoppingListResultDiv.classList.remove('hidden');
                        if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden');


                        const copyButton = document.getElementById('copyShoppingListButton');
                        if(copyButton && UIElements.clipboardHelper) { 
                            copyButton.addEventListener('click', () => {
                                const listToCopy = ingredientsArray.join('\n');
                                UIElements.clipboardHelper.value = listToCopy;
                                UIElements.clipboardHelper.select();
                                try {
                                    document.execCommand('copy');
                                    showError('장보기 목록이 클립보드에 복사되었습니다!'); 
                                } catch (err) {
                                    console.error('클립보드 복사 실패:', err);
                                    showError('클립보드 복사에 실패했습니다. 수동으로 복사해주세요.');
                                }
                                if (window.getSelection) {
                                    window.getSelection().removeAllRanges();
                                } else if (document.selection) {
                                    document.selection.empty();
                                }
                            });
                        } else if (!UIElements.clipboardHelper) {
                             console.warn("clipboardHelper 요소를 찾을 수 없어 복사 기능이 제한됩니다.");
                        }

                    } else {
                        UIElements.shoppingListResultDiv.innerHTML = '<p class="text-gray-500 italic">레시피에서 재료 정보를 추출하지 못했습니다.</p>';
                        UIElements.shoppingListResultDiv.classList.remove('hidden');
                        if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden');
                    }
                } else {
                    UIElements.shoppingListResultDiv.innerHTML = '<p class="text-gray-500 italic">"필요한 재료" 섹션을 찾을 수 없습니다.</p>';
                    UIElements.shoppingListResultDiv.classList.remove('hidden');
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden');
                }
            });
        }

        // --- 새로운 기능 이벤트 리스너 ---
        if (UIElements.getBeveragePairingButton) {
            UIElements.getBeveragePairingButton.addEventListener('click', async () => {
                const dishName = UIElements.beverageDishNameInput ? UIElements.beverageDishNameInput.value.trim() : "";
                if (!dishName) {
                    showError("음료를 추천받을 요리 이름을 입력해주세요.");
                    return;
                }
                if (UIElements.beveragePairingResultWrapper) UIElements.beveragePairingResultWrapper.classList.add('hidden');
                const prompt = `"${dishName}" 요리와 잘 어울리는 음료(와인, 맥주, 전통주, 논알콜 음료 등)를 3가지 추천해주고, 각 음료에 대한 간단한 페어링 이유를 설명해주세요. 결과는 목록 형태로 제공해주세요. 각 추천 항목은 **음료 이름:** 으로 시작하고, 설명은 일반 텍스트로 작성해주세요.`;
                const resultText = await callGeminiAPI(prompt, true);
                if (resultText && UIElements.beveragePairingResult) {
                    displayFormattedText(resultText, UIElements.beveragePairingResult, `"${dishName}" 음료 페어링 추천`, "beveragePairing");
                }
            });
        }

        if (UIElements.searchCookingTermButton) {
            UIElements.searchCookingTermButton.addEventListener('click', async () => {
                const term = UIElements.cookingTermInput ? UIElements.cookingTermInput.value.trim() : "";
                if (!term) {
                    showError("검색할 요리 용어를 입력해주세요.");
                    return;
                }
                if (UIElements.cookingTermResultWrapper) UIElements.cookingTermResultWrapper.classList.add('hidden');
                const prompt = `요리 용어 "${term}"에 대한 쉽고 자세한 설명을 해주세요. 필요한 경우 예시도 함께 들어주세요.`;
                const resultText = await callGeminiAPI(prompt, true);
                if (resultText && UIElements.cookingTermResult) {
                    displayFormattedText(resultText, UIElements.cookingTermResult, `"${term}" 용어 설명`, "cookingTerm");
                }
            });
        }

        if (UIElements.convertUnitButton) {
            UIElements.convertUnitButton.addEventListener('click', async () => {
                const value = UIElements.unitValueInput ? UIElements.unitValueInput.value.trim() : "";
                const fromUnit = UIElements.fromUnitInput ? UIElements.fromUnitInput.value.trim() : "";
                const toUnit = UIElements.toUnitInput ? UIElements.toUnitInput.value.trim() : "";

                if (!value || !fromUnit || !toUnit) {
                    showError("변환할 값, 현재 단위, 변환할 단위를 모두 입력해주세요.");
                    return;
                }
                if (UIElements.unitConversionResultWrapper) UIElements.unitConversionResultWrapper.classList.add('hidden');
                const prompt = `요리 계량 단위 변환 요청입니다. ${value} ${fromUnit}은(는) 몇 ${toUnit}인가요? 숫자와 단위만 간결하게 알려주세요. (예: 15 ml)`;
                const resultText = await callGeminiAPI(prompt, true);
                if (resultText && UIElements.unitConversionResult) {
                    displayFormattedText(resultText, UIElements.unitConversionResult, `단위 변환 결과: ${value} ${fromUnit} → ${toUnit}`, "unitConversion");
                }
            });
        }
        
        if (UIElements.getSeasonalRecipesButton) {
            UIElements.getSeasonalRecipesButton.addEventListener('click', async () => {
                const season = UIElements.seasonInput ? UIElements.seasonInput.value.trim() : "";
                if (!season) {
                    showError("월 또는 계절을 입력해주세요 (예: 7월, 여름).");
                    return;
                }
                if (UIElements.seasonalRecipeResultWrapper) UIElements.seasonalRecipeResultWrapper.classList.add('hidden');
                const prompt = `"${season}"에 즐기기 좋은 제철 재료를 활용한 특별한 레시피 2~3가지를 추천해주세요. 각 레시피는 이름과 간단한 설명, 그리고 해당 레시피를 검색할 수 있는 버튼 자리표시자 ("-> [요리 이름] 전체 레시피 보기")를 포함해야 합니다. 각 추천은 "번호. **요리 이름:** 설명" 형식으로 시작해주세요.`;
                const resultText = await callGeminiAPI(prompt, true);
                if (resultText && UIElements.seasonalRecipeResult) {
                    displayFormattedText(resultText, UIElements.seasonalRecipeResult, `"${season}" 제철 요리 추천`, "seasonalRecipe");
                }
            });
        }

        // "내 레시피북에 저장" 버튼 기능
        if (UIElements.saveToRecipeBookButton) {
            UIElements.saveToRecipeBookButton.addEventListener('click', () => {
                if (!currentRecipeFullText || !currentRecipeTitle) {
                    showError("저장할 레시피 내용이 없습니다. 먼저 레시피를 조회해주세요.");
                    return;
                }
                saveRecipeToBook(currentRecipeTitle, currentRecipeFullText);
            });
        }

        // --- 내 레시피북 (localStorage) 관련 함수 ---
        function getSavedRecipes() {
            const recipes = localStorage.getItem('myRecipeBook');
            return recipes ? JSON.parse(recipes) : [];
        }

        function saveRecipeToBook(title, fullText) {
            if (!title || !fullText) {
                showError("레시피 제목 또는 내용이 없어 저장할 수 없습니다.");
                return;
            }
            const recipes = getSavedRecipes();
            const newRecipe = {
                id: Date.now(), // 간단한 ID 생성
                title: title,
                fullText: fullText
            };
            // 중복 저장 방지 (제목 기준)
            if (recipes.some(recipe => recipe.title === newRecipe.title)) {
                showError(`"${newRecipe.title}" 레시피는 이미 레시피북에 저장되어 있습니다.`);
                return;
            }
            recipes.push(newRecipe);
            localStorage.setItem('myRecipeBook', JSON.stringify(recipes));
            showError(`"${title}" 레시피가 내 레시피북에 저장되었습니다!`);
            // 레시피북 탭이 활성화되어 있다면 목록 새로고침
            const activeTabButton = document.querySelector('.tab-button.active');
            if (activeTabButton && activeTabButton.dataset.tab === 'tab11') {
                loadAndDisplaySavedRecipes();
            }
        }
        
        function loadAndDisplaySavedRecipes() {
            if (!UIElements.savedRecipesListDiv) return;
            const recipes = getSavedRecipes();
            UIElements.savedRecipesListDiv.innerHTML = ''; // 기존 목록 초기화

            if (recipes.length === 0) {
                UIElements.savedRecipesListDiv.innerHTML = '<p class="text-gray-500 italic text-center">아직 저장된 레시피가 없습니다.</p>';
                return;
            }

            recipes.forEach(recipe => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('saved-recipe-item', 'flex', 'justify-between', 'items-center');
                
                const titleSpan = document.createElement('span');
                titleSpan.classList.add('font-semibold', 'text-lg', 'text-indigo-700', 'cursor-pointer', 'hover:underline');
                titleSpan.textContent = recipe.title; // 저장된 순수 제목 표시
                titleSpan.onclick = () => { // 제목 클릭 시 레시피 보기
                     if (UIElements.recipeDisplay && UIElements.recipeOutputSection && UIElements.recipeOutputTitle) {
                        currentRecipeFullText = recipe.fullText; 
                        currentRecipeTitle = recipe.title; 
                        displayFormattedText(recipe.fullText, UIElements.recipeDisplay, `"${recipe.title}" 레시피 (보관함)`, "recipe");
                        UIElements.recipeOutputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
                itemDiv.appendChild(titleSpan);

                const buttonGroup = document.createElement('div');
                buttonGroup.classList.add('button-group');

                const viewButton = document.createElement('button');
                viewButton.innerHTML = '<i class="fas fa-eye mr-1"></i> 보기';
                viewButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-1', 'px-2', 'rounded', 'text-xs');
                viewButton.onclick = () => {
                    if (UIElements.recipeDisplay && UIElements.recipeOutputSection && UIElements.recipeOutputTitle) {
                        currentRecipeFullText = recipe.fullText; 
                        currentRecipeTitle = recipe.title; 
                        displayFormattedText(recipe.fullText, UIElements.recipeDisplay, `"${recipe.title}" 레시피 (보관함)`, "recipe");
                         UIElements.recipeOutputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
                buttonGroup.appendChild(viewButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> 삭제';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded', 'text-xs', 'ml-2');
                deleteButton.onclick = (event) => { // 이벤트 버블링 방지
                    event.stopPropagation(); 
                    deleteRecipeFromBook(recipe.id);
                };
                buttonGroup.appendChild(deleteButton);
                itemDiv.appendChild(buttonGroup);
                UIElements.savedRecipesListDiv.appendChild(itemDiv);
            });
        }

        function deleteRecipeFromBook(recipeId) {
            let recipes = getSavedRecipes();
            const recipeToDelete = recipes.find(r => r.id === recipeId);
            if (recipeToDelete) {
                // 사용자에게 정말 삭제할 것인지 한 번 더 확인하는 로직 (간단한 alert 사용, 실제 앱에서는 커스텀 모달 권장)
                // if (confirm(`"${recipeToDelete.title}" 레시피를 정말 삭제하시겠습니까?`)) {
                    recipes = recipes.filter(recipe => recipe.id !== recipeId);
                    localStorage.setItem('myRecipeBook', JSON.stringify(recipes));
                    loadAndDisplaySavedRecipes(); 
                    showError(`"${recipeToDelete.title}" 레시피가 삭제되었습니다.`);

                    if (UIElements.recipeOutputTitle && UIElements.recipeOutputTitle.textContent.includes(recipeToDelete.title) && UIElements.recipeDisplay) {
                        UIElements.recipeDisplay.innerHTML = '<p class="text-gray-500 italic text-center py-8">결과가 여기에 표시됩니다.</p>';
                        if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden');
                        currentRecipeFullText = "";
                        currentRecipeTitle = "";
                    }
                // }
            } else {
                showError("삭제할 레시피를 찾지 못했습니다.");
            }
        }
        
        // 초기 로드 시 "오늘의 추천" 탭 활성화
        const defaultInitialTabId = 'tab2';
        // 이전에 선언된 initialActiveTabButton 변수를 재사용하지 않도록 let 또는 const를 다시 사용하지 않습니다.
        let initialActiveTabButtonForLoad = document.querySelector(`.tab-button[data-tab="${defaultInitialTabId}"]`);
        let initialActiveTabContentForLoad = document.getElementById(defaultInitialTabId);

        // 모든 탭에서 'active' 클래스 먼저 제거
        if (UIElements.tabButtons) {
            UIElements.tabButtons.forEach(btn => btn.classList.remove('active'));
        }
        if (UIElements.tabContents) {
            UIElements.tabContents.forEach(content => content.classList.remove('active'));
        }

        if (initialActiveTabButtonForLoad && initialActiveTabContentForLoad) {
            initialActiveTabButtonForLoad.classList.add('active');
            initialActiveTabContentForLoad.classList.add('active');
        } else if (UIElements.tabButtons && UIElements.tabButtons.length > 0) { // Fallback: 첫 번째 탭 활성화
            UIElements.tabButtons[0].classList.add('active');
            const fallbackTabId = UIElements.tabButtons[0].dataset.tab;
            const fallbackContent = document.getElementById(fallbackTabId);
            if (fallbackContent) {
                fallbackContent.classList.add('active');
                initialActiveTabButtonForLoad = UIElements.tabButtons[0]; 
            }
        }
        
        // 초기 활성화된 탭에 따른 데이터 로드 (initialActiveTabButtonForLoad 변수 사용)
        if (initialActiveTabButtonForLoad) { 
            const activeTab = initialActiveTabButtonForLoad.dataset.tab;
            if (activeTab === 'tab11') loadAndDisplaySavedRecipes();
            if (activeTab === 'tab12') loadDailyCalorieLog();
            if (activeTab === 'tab14') loadDailyExerciseLog();
            if (activeTab === 'tab15') loadAndUpdateWaterIntakeProgress();
        }


        // --- 헬스 플래너 기능들 ---
        if(UIElements.analyzeAndLogCalorieButton) {
            UIElements.analyzeAndLogCalorieButton.addEventListener('click', async () => {
                const foodName = UIElements.calorieFoodNameInput.value.trim();
                const mealType = UIElements.calorieMealTypeSelect.value;
                if (!foodName) {
                    showError("칼로리를 분석하고 기록할 음식/재료 이름을 입력해주세요.");
                    return;
                }
                if (UIElements.calorieTrackerResultWrapper) UIElements.calorieTrackerResultWrapper.classList.add('hidden');

                const prompt = `음식 "${foodName}"의 예상 칼로리와 주요 영양 성분(탄수화물, 단백질, 지방)을 알려주세요. 결과는 명확한 목록 형태로 제공해주세요. (예: **총 칼로리:** 약 XXX kcal)`;
                const analysisResult = await callGeminiAPI(prompt, true);

                if (analysisResult && UIElements.calorieTrackerResult) {
                    displayFormattedText(analysisResult, UIElements.calorieTrackerResult, `"${foodName}" 분석 결과`, "calorieTracker");
                    // 로컬 스토리지에 기록 (간단화된 버전)
                    const calorieMatch = analysisResult.match(/총 칼로리:\s*약\s*(\d+)\s*kcal/i);
                    const calories = calorieMatch ? parseInt(calorieMatch[1], 10) : 0;
                    saveCalorieLog({ foodName, mealType, calories, details: analysisResult });
                    loadDailyCalorieLog();
                }
            });
        }
        
        if(UIElements.generateDietPlanButton) {
            UIElements.generateDietPlanButton.addEventListener('click', async () => {
                const goal = UIElements.dietGoalSelect.value;
                const level = UIElements.activityLevelSelect.value;
                const duration = UIElements.dietDurationInput.value.trim();
                const preferences = UIElements.dietPreferencesPlannerInput.value.trim() || "특별한 제한 없음";

                if (!duration || isNaN(parseInt(duration)) || parseInt(duration) <=0) {
                    showError("올바른 목표 기간을 입력해주세요 (숫자, 1 이상).");
                    return;
                }
                if (UIElements.dietPlannerResultWrapper) UIElements.dietPlannerResultWrapper.classList.add('hidden');
                const prompt = `사용자의 다이어트 목표는 "${goal}", 활동량 수준은 "${level}", 목표 기간은 ${duration}일, 식단 선호/제한 사항은 "${preferences}" 입니다. 이를 바탕으로 ${duration}일치 맞춤형 다이어트 식단 계획을 세워주세요. 각 날짜별 아침, 점심, 저녁 메뉴와 간단한 레시피 아이디어를 포함해주세요.`;
                const resultText = await callGeminiAPI(prompt, true);
                 if (resultText && UIElements.dietPlannerResult) {
                    displayFormattedText(resultText, UIElements.dietPlannerResult, "AI 맞춤 다이어트 식단", "dietPlanner");
                }
            });
        }

        if(UIElements.calculateExerciseCaloriesButton) {
            UIElements.calculateExerciseCaloriesButton.addEventListener('click', async () => {
                const type = UIElements.exerciseTypeInput.value.trim();
                const duration = UIElements.exerciseDurationInput.value.trim();
                if(!type || !duration || isNaN(parseInt(duration)) || parseInt(duration) <=0){
                    showError("운동 종류와 시간을 올바르게 입력해주세요.");
                    return;
                }
                if(UIElements.exerciseTrackerResultWrapper) UIElements.exerciseTrackerResultWrapper.classList.add('hidden');
                const prompt = `"${type}" 운동을 ${duration}분 동안 했을 때 예상되는 소모 칼로리를 계산해주세요. 결과는 "예상 소모 칼로리: 약 XXX kcal" 형식으로 알려주세요.`;
                const resultText = await callGeminiAPI(prompt, true);
                if(resultText && UIElements.exerciseTrackerResult){
                    displayFormattedText(resultText, UIElements.exerciseTrackerResult, `"${type}" (${duration}분) 소모 칼로리`, "exerciseTracker");
                    const calorieMatch = resultText.match(/약\s*(\d+)\s*kcal/i);
                    const caloriesBurned = calorieMatch ? parseInt(calorieMatch[1], 10) : 0;
                    saveExerciseLog({ type, duration, caloriesBurned });
                    loadDailyExerciseLog();
                }
            });
        }

        if(UIElements.logWaterIntakeButton){
            UIElements.logWaterIntakeButton.addEventListener('click', () => {
                const amount = parseInt(UIElements.waterIntakeAmountInput.value, 10);
                if(isNaN(amount) || amount <= 0) {
                    showError("올바른 섭취량을 입력해주세요.");
                    return;
                }
                logWater(amount);
                loadAndUpdateWaterIntakeProgress();
                UIElements.waterIntakeAmountInput.value = "250"; // 기본값으로 리셋
            });
        }
        if(UIElements.waterIntakeGoalInput){
             UIElements.waterIntakeGoalInput.addEventListener('change', loadAndUpdateWaterIntakeProgress);
        }


        if(UIElements.getDietTipButton){
            UIElements.getDietTipButton.addEventListener('click', async () => {
                if(UIElements.dietTipResultWrapper) UIElements.dietTipResultWrapper.classList.add('hidden');
                const prompt = "오늘의 다이어트 꿀팁을 하나 알려주세요. 짧고 실용적인 내용으로 부탁합니다.";
                const resultText = await callGeminiAPI(prompt, true);
                if(resultText && UIElements.dietTipResult){
                    displayFormattedText(resultText, UIElements.dietTipResult, "오늘의 다이어트 꿀팁", "dietTip");
                }
            });
        }
        
        // 칼로리 기록 관련 함수
        function getTodaysDateString() { return new Date().toISOString().split('T')[0]; }

        function saveCalorieLog(entry) {
            const today = getTodaysDateString();
            let logs = JSON.parse(localStorage.getItem(`calorieLog_${today}`)) || [];
            logs.push({...entry, time: new Date().toLocaleTimeString()});
            localStorage.setItem(`calorieLog_${today}`, JSON.stringify(logs));
        }

        function loadDailyCalorieLog() {
            if(!UIElements.dailyCalorieLogDiv || !UIElements.totalDailyCaloriesSpan) return;
            const today = getTodaysDateString();
            const logs = JSON.parse(localStorage.getItem(`calorieLog_${today}`)) || [];
            UIElements.dailyCalorieLogDiv.innerHTML = '';
            let totalCalories = 0;
            if (logs.length === 0) {
                UIElements.dailyCalorieLogDiv.innerHTML = '<p class="text-gray-500 italic">아직 기록된 내용이 없습니다.</p>';
            } else {
                logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.classList.add('calorie-log-item', 'text-sm');
                    logItem.innerHTML = `<strong>${log.mealType}:</strong> ${log.foodName} - 약 ${log.calories} kcal <i>(${log.time})</i>`;
                    UIElements.dailyCalorieLogDiv.appendChild(logItem);
                    totalCalories += log.calories;
                });
            }
            UIElements.totalDailyCaloriesSpan.textContent = totalCalories;
        }
        
        // 운동 기록 관련 함수
        function saveExerciseLog(entry) {
            const today = getTodaysDateString();
            let logs = JSON.parse(localStorage.getItem(`exerciseLog_${today}`)) || [];
            logs.push({...entry, time: new Date().toLocaleTimeString()});
            localStorage.setItem(`exerciseLog_${today}`, JSON.stringify(logs));
        }

        function loadDailyExerciseLog() {
            if(!UIElements.dailyExerciseLogDiv || !UIElements.totalDailyExerciseCaloriesSpan) return;
            const today = getTodaysDateString();
            const logs = JSON.parse(localStorage.getItem(`exerciseLog_${today}`)) || [];
            UIElements.dailyExerciseLogDiv.innerHTML = '';
            let totalCaloriesBurned = 0;
            if (logs.length === 0) {
                UIElements.dailyExerciseLogDiv.innerHTML = '<p class="text-gray-500 italic">아직 기록된 운동이 없습니다.</p>';
            } else {
                logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.classList.add('exercise-log-item', 'text-sm');
                    logItem.innerHTML = `<strong>${log.type}</strong> (${log.duration}분) - 약 ${log.caloriesBurned} kcal 소모 <i>(${log.time})</i>`;
                    UIElements.dailyExerciseLogDiv.appendChild(logItem);
                    totalCaloriesBurned += log.caloriesBurned;
                });
            }
            UIElements.totalDailyExerciseCaloriesSpan.textContent = totalCaloriesBurned;
        }

        // 수분 섭취 관련 함수
        function logWater(amount) {
            const today = getTodaysDateString();
            let currentIntake = parseInt(localStorage.getItem(`waterIntake_${today}`), 10) || 0;
            currentIntake += amount;
            localStorage.setItem(`waterIntake_${today}`, currentIntake);
        }

        function loadAndUpdateWaterIntakeProgress() {
            if(!UIElements.waterIntakeProgressDiv || !UIElements.currentWaterIntakeSpan || !UIElements.waterGoalDisplaySpan || !UIElements.waterIntakeGoalInput) return;
            const today = getTodaysDateString();
            const currentIntake = parseInt(localStorage.getItem(`waterIntake_${today}`), 10) || 0;
            const goal = parseInt(UIElements.waterIntakeGoalInput.value, 10) || 2000;
            
            UIElements.currentWaterIntakeSpan.textContent = currentIntake;
            UIElements.waterGoalDisplaySpan.textContent = goal;
            
            const percentage = Math.min((currentIntake / goal) * 100, 100);
            UIElements.waterIntakeProgressDiv.style.width = `${percentage}%`;
            UIElements.waterIntakeProgressDiv.textContent = `${Math.round(percentage)}%`;

            if (percentage >= 100) {
                UIElements.waterIntakeProgressDiv.classList.replace('bg-blue-500', 'bg-green-500');
            } else {
                UIElements.waterIntakeProgressDiv.classList.replace('bg-green-500', 'bg-blue-500');
            }
        }
    });
    </script>
</body>
</html>

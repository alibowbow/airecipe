<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë ˆì‹œí”¼ ì…°í”„ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: #f8f9fc; 
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f0f2f5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #d1d9e6; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #b0b8c9; }
        
        .spinner {
            border-width: 3px;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4); 
            border-color: #6366f1;
        }
        .tab-button {
            transition: all 0.25s ease-in-out;
            border-bottom: 3px solid transparent; /* ê¸°ë³¸ ë°‘ì¤„ì€ íˆ¬ëª… */
            padding-top: 0.6rem;
            padding-bottom: 0.6rem; /* ê¸°ë³¸ í•˜ë‹¨ íŒ¨ë”© */
            padding-left: 0.5rem;
            padding-right: 0.5rem; 
            white-space: nowrap; 
            display: inline-flex; 
            align-items: center;
            font-size: 0.8rem; 
            line-height: 1.2; /* í…ìŠ¤íŠ¸ì™€ ë°‘ì¤„ ì‚¬ì´ ê°„ê²© ì¡°ì •ì„ ìœ„í•´ ì¶”ê°€ */
        }
        @media (min-width: 768px) { 
            .tab-button {
                padding-top: 0.85rem;
                padding-bottom: 0.85rem; /* ë°ìŠ¤í¬íƒ‘ ê¸°ë³¸ í•˜ë‹¨ íŒ¨ë”© */
                padding-left: 0.7rem;
                padding-right: 0.7rem;
                font-size: 0.875rem; 
            }
        }

        .tab-button i { 
            margin-right: 0.25rem; 
        }
        .tab-button.active {
            color: #4f46e5; 
            border-bottom-color: #4f46e5; /* í™œì„± íƒ­ ë°‘ì¤„ ìƒ‰ìƒ */
            font-weight: 700;
            /* ë°‘ì¤„ì´ í…ìŠ¤íŠ¸ì— ë” ê°€ê¹ê²Œ ë³´ì´ë„ë¡ íŒ¨ë”© ì¡°ì • */
            /* padding-bottom ê°’ì—ì„œ border-bottom-width (3px) ë§Œí¼ ë¹¼ì¤ë‹ˆë‹¤. */
            /* Tailwindì˜ ê¸°ë³¸ íŒ¨ë”© ê°’ê³¼ ê³„ì‚°ì„ ë§ì¶”ê¸° ìœ„í•´ calc ì‚¬ìš© ëŒ€ì‹  ì§ì ‘ ê°’ì„ ì¡°ì •í•©ë‹ˆë‹¤. */
            /* ì˜ˆ: 0.6rem (9.6px) - 3px = 6.6px. TailwindëŠ” rem ë‹¨ìœ„ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, 
               ì •í™•í•œ ê³„ì‚°ë³´ë‹¤ëŠ” ì‹œê°ì ìœ¼ë¡œ ì¡°ì •í•˜ëŠ” ê²ƒì´ ë‚˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
               ë˜ëŠ”, borderë¥¼ box-shadowë¡œ ëŒ€ì²´í•˜ëŠ” ë°©ë²•ë„ ìˆìŠµë‹ˆë‹¤.
               ì—¬ê¸°ì„œëŠ” padding-bottomì„ ì§ì ‘ ì¡°ì •í•©ë‹ˆë‹¤. */
        }
         /* í™œì„± íƒ­ì˜ í•˜ë‹¨ íŒ¨ë”©ì„ ë” ì¤„ì—¬ ë°‘ì¤„ì„ ì˜¬ë¦½ë‹ˆë‹¤. */
        .tab-button.active {
            padding-bottom: calc(0.6rem - 3px); /* ëª¨ë°”ì¼: ê¸°ë³¸ íŒ¨ë”© - ë°‘ì¤„ ë‘ê»˜ */
        }
        @media (min-width: 768px) {
            .tab-button.active {
                padding-bottom: calc(0.85rem - 3px); /* ë°ìŠ¤í¬íƒ‘: ê¸°ë³¸ íŒ¨ë”© - ë°‘ì¤„ ë‘ê»˜ */
            }
        }


        .tab-button:not(.active):hover {
            color: #3730a3; 
            background-color: #f0f2ff; 
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card {
            background-color: white;
            border-radius: 18px; 
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.06); 
            padding: 1.5rem 2rem; 
            margin-top: 1.5rem; 
        }
        @media (min-width: 768px) { 
            .content-card {
                padding: 2rem 2.5rem; 
                margin-top: 2rem; 
            }
        }

        .content-card h3.card-title { 
            font-size: 1.4rem; 
            font-weight: 700;
            color: #3730a3; 
            margin-bottom: 1.2rem;
            padding-bottom: 0.7rem;
            border-bottom: 1px solid #e5e7eb; 
        }
         .content-card ul, .content-card ol {
            padding-left: 1.4rem;
        }
        .content-card li {
            margin-bottom: 0.7rem;
            line-height: 1.8;
            color: #4b5563; 
        }
        .content-card strong {
            font-weight: 700;
            color: #1f2937; 
        }
        .content-card p {
            color: #4b5563;
            line-height: 1.8;
            margin-bottom: 0.85rem;
        }
        .action-button { 
            font-size: 1.05rem;
            padding-top: 0.9rem;
            padding-bottom: 0.9rem;
        }
        button#substituteIngredientButton, button#analyzeNutritionButton, button#generateShoppingListButton, button#saveToRecipeBookButton { 
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.2rem;
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
            transition: all 0.15s ease-in-out;
            margin-top: 0.5rem;
        }
        button#substituteIngredientButton:hover, button#analyzeNutritionButton:hover, button#generateShoppingListButton:hover, button#saveToRecipeBookButton:hover {
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); 
        }

        button#substituteIngredientButton { background-color: #f59e0b; } 
        button#substituteIngredientButton:hover { background-color: #d97706; } 
        button#analyzeNutritionButton { background-color: #10b981; } 
        button#analyzeNutritionButton:hover { background-color: #059669; } 
        button#generateShoppingListButton { background-color: #3b82f6; } 
        button#generateShoppingListButton:hover { background-color: #2563eb; } 
        button#saveToRecipeBookButton { background-color: #8b5cf6; } /* Violet-500 */
        button#saveToRecipeBookButton:hover { background-color: #7c3aed; } /* Violet-600 */


        .meal-plan-item, .themed-recipe-item, .saved-recipe-item, .calorie-log-item, .exercise-log-item, .water-log-item { 
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background-color: #f9fafb;
        }
        .meal-plan-item strong, .themed-recipe-item strong, .saved-recipe-item strong, .calorie-log-item strong, .exercise-log-item strong {
            color: #4f46e5;
        }
        .meal-plan-item button, .themed-recipe-item button, .saved-recipe-item button, .calorie-log-item button, .exercise-log-item button {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            margin-top: 0.5rem;
        }
        .saved-recipe-item .button-group button, .calorie-log-item .button-group button, .exercise-log-item .button-group button {
            margin-left: 0.5rem;
        }
        #nutritionAnalysisResult, #shoppingListResult, #beveragePairingResult, #cookingTermResult, #unitConversionResult, #seasonalRecipeResult, 
        #calorieTrackerResult, #dietPlannerResult, #exerciseTrackerResult, #waterIntakeResult, #dietTipResult { 
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px dashed #cbd5e1; 
        }
        #copyShoppingListButton {
            background-color: #6b7280; 
            color: white;
            margin-top: 1rem;
        }
        #copyShoppingListButton:hover {
            background-color: #4b5563; 
        }
        /* ë„¤ë¹„ê²Œì´ì…˜ ê·¸ë£¹ ì œëª© ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .nav-group-title {
            font-size: 0.8rem; 
            color: #4b5563; 
            text-align: left; 
            padding-left: 0.5rem; 
            margin-top: 0.75rem; /* ê·¸ë£¹ ê°„ ìƒë‹¨ ê°„ê²© */
            margin-bottom: 0.25rem; 
            font-weight: 600; 
        }
        #mainNavContainer > .nav-group-title:first-of-type { /* ì²«ë²ˆì§¸ ê·¸ë£¹ ì œëª©ì˜ ìƒë‹¨ ë§ˆì§„ ì œê±° */
             margin-top: 0;
        }
        #additionalTabs > .nav-group-title { /* ì¶”ê°€ íƒ­ ë‚´ì˜ ê·¸ë£¹ ì œëª© ìƒë‹¨ ë§ˆì§„ */
            margin-top: 0.75rem; /* md:mt-3 ì™€ ìœ ì‚¬í•˜ê²Œ */
        }
         #additionalTabs > .nav-group-title:first-child { /* ì¶”ê°€ íƒ­ ë‚´ì˜ ì²« ê·¸ë£¹ ì œëª© ìƒë‹¨ ë§ˆì§„ë„ ë™ì¼í•˜ê²Œ */
            margin-top: 0.75rem;
        }


    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

    <div class="container mx-auto max-w-5xl w-full">
        <header class="text-center my-8 md:my-10 lg:my-14">
            <h1 class="text-3xl sm:text-4xl lg:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-purple-500 to-pink-500">
                AI ë ˆì‹œí”¼ ì…°í”„
            </h1>
            <p class="text-base sm:text-lg lg:text-xl text-gray-600 mt-3 sm:mt-5">AIì™€ í•¨ê»˜, ë§¤ì¼ë§¤ì¼ íŠ¹ë³„í•œ ë¯¸ì‹ ê²½í—˜ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
        </header>

        <nav class="mb-8 md:mb-10">
            <div class="md:hidden text-center mb-3">
                <button id="mobileMoreMenuButton" class="py-2 px-4 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 text-sm font-medium w-full sm:w-auto">
                    <span id="mobileMoreMenuButtonText">ë” ë§ì€ ë©”ë‰´ ë³´ê¸°</span> <i id="mobileMoreMenuIcon" class="fas fa-chevron-down ml-1 transition-transform duration-200"></i>
                </button>
            </div>

            <div id="mainNavContainer" class="border-b border-gray-200 pb-1 md:pb-2">
                <div class="nav-group-title">ë ˆì‹œí”¼ íƒìƒ‰</div>
                <div id="coreTabs" class="flex flex-wrap justify-center md:justify-start items-center gap-x-1 gap-y-1 md:gap-y-2">
                    <button data-tab="tab2" class="tab-button core-tab active"> 
                        <i class="fas fa-hat-chef"></i>ì˜¤ëŠ˜ì˜ ì¶”ì²œ
                    </button>
                    <button data-tab="tab1" class="tab-button core-tab">
                        <i class="fas fa-cogs"></i>ë§ì¶¤ ë ˆì‹œí”¼
                    </button>
                    <button data-tab="tab3" class="tab-button core-tab">
                        <i class="fas fa-book-sparkles"></i>ìš”ë¦¬ ê²€ìƒ‰
                    </button>
                     <button data-tab="tab6" class="tab-button core-tab md:additional-tab"> <i class="fas fa-gifts"></i>í…Œë§ˆë³„ ìš”ë¦¬
                    </button>
                    <button data-tab="tab10" class="tab-button core-tab md:additional-tab">
                        <i class="fas fa-leaf"></i>ì œì²  ìš”ë¦¬
                    </button>
                </div>

                <div id="additionalTabs" class="hidden md:block"> 
                    <div class="nav-group-title">ì£¼ë°© ë„êµ¬</div>
                    <div class="flex flex-wrap justify-center md:justify-start items-center gap-x-1 gap-y-1 md:gap-y-2">
                        <button data-tab="tab4" class="tab-button additional-tab">
                            <i class="fas fa-carrot"></i>ëƒ‰ì¥ê³  íŒŒë¨¹ê¸°
                        </button>
                        <button data-tab="tab7" class="tab-button additional-tab">
                            <i class="fas fa-wine-glass"></i>ìŒë£Œ ì¶”ì²œ
                        </button>
                        <button data-tab="tab8" class="tab-button additional-tab">
                            <i class="fas fa-book-open"></i>ìš”ë¦¬ ìš©ì–´
                        </button>
                        <button data-tab="tab9" class="tab-button additional-tab">
                            <i class="fas fa-balance-scale"></i>ë‹¨ìœ„ ë³€í™˜
                        </button>
                    </div>
                    
                    <div class="nav-group-title">í—¬ìŠ¤ í”Œë˜ë„ˆ(ë² íƒ€)</div>
                    <div class="flex flex-wrap justify-center md:justify-start items-center gap-x-1 gap-y-1 md:gap-y-2">
                         <button data-tab="tab12" class="tab-button additional-tab">
                            <i class="fas fa-calculator"></i>ì¹¼ë¡œë¦¬ íŠ¸ë˜ì»¤
                        </button>
                        <button data-tab="tab13" class="tab-button additional-tab">
                            <i class="fas fa-utensils"></i>AI ë‹¤ì´ì–´íŠ¸ í”Œëœ
                        </button>
                        <button data-tab="tab14" class="tab-button additional-tab">
                            <i class="fas fa-dumbbell"></i>ìš´ë™ ë„ìš°ë¯¸
                        </button>
                        <button data-tab="tab15" class="tab-button additional-tab">
                            <i class="fas fa-tint"></i>ìˆ˜ë¶„ íŠ¸ë˜ì»¤
                        </button>
                        <button data-tab="tab16" class="tab-button additional-tab">
                            <i class="fas fa-lightbulb"></i>ì˜¤ëŠ˜ì˜ ë‹¤ì´ì–´íŠ¸ íŒ
                        </button>
                    </div>

                    <div class="nav-group-title">ë‚˜ì˜ ê³µê°„</div>
                    <div class="flex flex-wrap justify-center md:justify-start items-center gap-x-1 gap-y-1 md:gap-y-2">
                        <button data-tab="tab5" class="tab-button additional-tab">
                            <i class="fas fa-calendar-alt"></i>AI ì£¼ê°„ ì‹ë‹¨
                        </button>
                        <button data-tab="tab11" class="tab-button additional-tab">
                            <i class="fas fa-bookmark"></i>ë‚´ ë ˆì‹œí”¼ë¶
                        </button>
                    </div>
                </div>
            </div>
        </nav>


        <div class="bg-white p-6 sm:p-10 rounded-xl shadow-xl relative">
            <div id="tab1" class="tab-content">
                <section class="space-y-7">
                    <p class="text-md text-gray-700 mb-4">ì›í•˜ëŠ” ìš”ë¦¬ ìŠ¤íƒ€ì¼ê³¼ ì‹ë‹¨ ì„ í˜¸ë„ë¥¼ ì•Œë ¤ì£¼ì‹œë©´, AIê°€ ì™„ë²½í•œ ë ˆì‹œí”¼ì™€ í•¨ê»˜ í•„ìš”í•œ ëª¨ë“  ì¬ë£Œë¥¼ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤!</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-7">
                        <div>
                            <label for="dietaryPreferences" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ¥— ì‹ë‹¨ ì„ í˜¸ë„/ì œí•œ (ì„ íƒ ì‚¬í•­)</label>
                            <input type="text" id="dietaryPreferences" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ì €íƒ„ìˆ˜í™”ë¬¼, ë¹„ê±´, ê²¬ê³¼ë¥˜ ì œì™¸">
                        </div>
                        <div>
                            <label for="cuisineStyle" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸœ ì„ í˜¸ ìš”ë¦¬ ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­)</label>
                            <input type="text" id="cuisineStyle" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ì´íƒˆë¦¬ì•ˆ, í“¨ì „ í•œì‹, ì´ˆê°„ë‹¨">
                        </div>
                    </div>
                    <button id="generateRecipeButton" class="action-button w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-wand-magic-sparkles mr-3"></i>AI ì¶”ì²œ ë ˆì‹œí”¼ ìƒì„±
                    </button>
                </section>
            </div>

            <div id="tab2" class="tab-content active"> 
                 <section class="space-y-7">
                    <div>
                        <label for="whatToEatKeywords" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ’¡ ì›í•˜ëŠ” ìš”ë¦¬ ëŠë‚Œ (ì„ íƒ ì‚¬í•­)</label>
                        <input type="text" id="whatToEatKeywords" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ë“ ë“ í•œ í•œ ë¼, ì™€ì¸ê³¼ ì–´ìš¸ë¦¬ëŠ”, ë§¤ì½¤í•œ ë„ì „">
                        <p class="text-xs text-gray-500 mt-1.5">AIì—ê²Œ ììœ ë¡œìš´ ì¶”ì²œì„ ë§¡ê²¨ë³´ì„¸ìš”! (ë¹„ì›Œë‘ì…”ë„ ì¢‹ìŠµë‹ˆë‹¤)</p>
                    </div>
                    <button id="recommendDishButton" class="action-button w-full bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-lightbulb-on mr-3"></i>ì˜¤ëŠ˜ì˜ ìš”ë¦¬ ì¶”ì²œë°›ê¸°
                    </button>
                    <div id="recommendationDisplayWrapper" class="hidden">
                        <div id="recommendationDisplay" class="content-card">
                            </div>
                    </div>
                </section>
            </div>

            <div id="tab3" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="specificDishName" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ³ ì°¾ê³  ì‹¶ì€ ìš”ë¦¬ ì´ë¦„</label>
                        <input type="text" id="specificDishName" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ë´‰ê³¨ë ˆ íŒŒìŠ¤íƒ€, ë‹­ë³¶ìŒíƒ•">
                    </div>
                    <button id="searchSpecificDishButton" class="action-button w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-book-open-reader mr-3"></i>ë ˆì‹œí”¼ ê²€ìƒ‰
                    </button>
                </section>
            </div>
            
            <div id="tab4" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="leftoverIngredients" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ¥• ëƒ‰ì¥ê³  ì† ì¬ë£Œ ì…ë ¥</label>
                        <textarea id="leftoverIngredients" rows="4" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ë‚¨ì€ ì‚¼ê²¹ì‚´ ì¡°ê¸ˆ, ì‹œê¸ˆì¹˜ ë°˜ ë‹¨, ë‘ë¶€ ë°˜ ëª¨, ì–‘íŒŒ 1/4ê°œ"></textarea>
                        <p class="text-xs text-gray-500 mt-1.5">ê°€ì§€ê³  ìˆëŠ” ì¬ë£Œë“¤ì„ ìµœëŒ€í•œ í™œìš©í•˜ëŠ” ë ˆì‹œí”¼ë¥¼ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤!</p>
                    </div>
                     <div>
                        <label for="leftoverCuisineStyle" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸœ ì„ í˜¸ ìš”ë¦¬ ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­)</label>
                        <input type="text" id="leftoverCuisineStyle" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: í•œì‹, ê°„ë‹¨í•œ ë³¶ìŒ, êµ­ë¬¼ ìš”ë¦¬">
                    </div>
                    <button id="generateLeftoverRecipeButton" class="action-button w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-recycle mr-3"></i>ëƒ‰ì¥ê³  íŒŒë¨¹ê¸° ë ˆì‹œí”¼ ìƒì„±!
                    </button>
                </section>
            </div>

            <div id="tab5" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="mealPlanPreferences" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ“… ì£¼ê°„ ì‹ë‹¨ ìš”ì²­ì‚¬í•­</label>
                        <input type="text" id="mealPlanPreferences" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ê³ ë‹¨ë°± ìœ„ì£¼, ì±„ì‹ìœ¼ë¡œ ì¼ì£¼ì¼, ê°„ë‹¨í•œ ì €ë… ë©”ë‰´ë“¤">
                        <p class="text-xs text-gray-500 mt-1.5">AIê°€ 7ì¼ì¹˜ ì €ë… ì‹ë‹¨ ì•„ì´ë””ì–´ë¥¼ ì œì•ˆí•´ ë“œë¦½ë‹ˆë‹¤.</p>
                    </div>
                    <button id="generateMealPlanButton" class="action-button w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-calendar-check mr-3"></i>AI ì£¼ê°„ ì‹ë‹¨ ìƒì„±!
                    </button>
                     <div id="mealPlanDisplayWrapper" class="hidden">
                        <div id="mealPlanDisplay" class="content-card">
                            </div>
                    </div>
                </section>
            </div>

            <div id="tab6" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="themeKeywords" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ‰ ì›í•˜ëŠ” í…Œë§ˆ/ìƒí™© ì…ë ¥</label>
                        <input type="text" id="themeKeywords" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ìƒì¼ íŒŒí‹°, ìº í•‘ ìš”ë¦¬, ë¹„ ì˜¤ëŠ” ë‚ , ì†ë‹˜ ì´ˆëŒ€">
                        <p class="text-xs text-gray-500 mt-1.5">AIê°€ í…Œë§ˆì— ë§ëŠ” íŠ¹ë³„í•œ ìš”ë¦¬ë“¤ì„ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.</p>
                    </div>
                    <button id="generateThemedRecipesButton" class="action-button w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-gifts mr-3"></i>í…Œë§ˆ ìš”ë¦¬ ì¶”ì²œë°›ê¸°!
                    </button>
                     <div id="themedRecipesDisplayWrapper" class="hidden">
                        <div id="themedRecipesDisplay" class="content-card">
                            </div>
                    </div>
                </section>
            </div>

            <div id="tab7" class="tab-content"> <section class="space-y-7">
                    <div>
                        <label for="beverageDishName" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ· í˜ì–´ë§í•  ìš”ë¦¬ ì´ë¦„</label>
                        <input type="text" id="beverageDishName" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ìŠ¤í…Œì´í¬, ë´‰ê³¨ë ˆ íŒŒìŠ¤íƒ€">
                    </div>
                    <button id="getBeveragePairingButton" class="action-button w-full bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-glass-cheers mr-3"></i>ì–´ìš¸ë¦¬ëŠ” ìŒë£Œ ì¶”ì²œë°›ê¸°
                    </button>
                    <div id="beveragePairingResultWrapper" class="hidden">
                        <div id="beveragePairingResult" class="content-card"></div>
                    </div>
                </section>
            </div>

            <div id="tab8" class="tab-content"> <section class="space-y-7">
                    <div>
                        <label for="cookingTerm" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ“– ê¶ê¸ˆí•œ ìš”ë¦¬ ìš©ì–´</label>
                        <input type="text" id="cookingTerm" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ë¸”ë‘ìŠ, ì¤„ë¦¬ì—”">
                    </div>
                    <button id="searchCookingTermButton" class="action-button w-full bg-gradient-to-r from-sky-500 to-cyan-500 hover:from-sky-600 hover:to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-search-plus mr-3"></i>ìš©ì–´ ëœ» ê²€ìƒ‰í•˜ê¸°
                    </button>
                    <div id="cookingTermResultWrapper" class="hidden">
                        <div id="cookingTermResult" class="content-card"></div>
                    </div>
                </section>
            </div>

            <div id="tab9" class="tab-content"> <section class="space-y-7">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="unitValue" class="block text-sm font-medium text-gray-700">ê°’</label>
                            <input type="number" id="unitValue" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: 100">
                        </div>
                        <div>
                            <label for="fromUnit" class="block text-sm font-medium text-gray-700">í˜„ì¬ ë‹¨ìœ„</label>
                            <input type="text" id="fromUnit" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: g, ml, ì»µ">
                        </div>
                        <div>
                            <label for="toUnit" class="block text-sm font-medium text-gray-700">ë³€í™˜í•  ë‹¨ìœ„</label>
                            <input type="text" id="toUnit" class="mt-1 w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: oz, tsp, í°ìˆ ">
                        </div>
                    </div>
                    <button id="convertUnitButton" class="action-button w-full bg-gradient-to-r from-lime-500 to-green-500 hover:from-lime-600 hover:to-green-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-exchange-alt mr-3"></i>ë‹¨ìœ„ ë³€í™˜í•˜ê¸°
                    </button>
                    <div id="unitConversionResultWrapper" class="hidden">
                        <div id="unitConversionResult" class="content-card"></div>
                    </div>
                </section>
            </div>

            <div id="tab10" class="tab-content"> <section class="space-y-7">
                    <div>
                        <label for="seasonInput" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸŒ¿ ì›” ë˜ëŠ” ê³„ì ˆ ì…ë ¥</label>
                        <input type="text" id="seasonInput" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: 3ì›”, ì—¬ë¦„">
                    </div>
                    <button id="getSeasonalRecipesButton" class="action-button w-full bg-gradient-to-r from-yellow-500 to-amber-500 hover:from-yellow-600 hover:to-amber-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-pepper-hot mr-3"></i>ì œì²  ë ˆì‹œí”¼ ì¶”ì²œë°›ê¸°
                    </button>
                    <div id="seasonalRecipeResultWrapper" class="hidden">
                        <div id="seasonalRecipeResult" class="content-card"></div>
                    </div>
                </section>
            </div>
            
            <div id="tab11" class="tab-content"> <section class="space-y-7">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ“– ë‚˜ë§Œì˜ ë ˆì‹œí”¼ë¶</h3>
                    <div id="savedRecipesList" class="space-y-4">
                        <p class="text-gray-500 italic text-center">ì•„ì§ ì €ì¥ëœ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </section>
            </div>

             <div id="tab12" class="tab-content"> <section class="space-y-7">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">ğŸ“ ìŠ¤ë§ˆíŠ¸ ì¹¼ë¡œë¦¬ íŠ¸ë˜ì»¤</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="calorieFoodName" class="block text-md font-semibold text-gray-800 mb-2">ìŒì‹/ì¬ë£Œ ì´ë¦„</label>
                            <input type="text" id="calorieFoodName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ë‹­ê°€ìŠ´ì‚´ 100g, ì‚¬ê³¼ 1ê°œ">
                        </div>
                        <div>
                            <label for="calorieMealType" class="block text-md font-semibold text-gray-800 mb-2">ì‹ì‚¬ ì¢…ë¥˜</label>
                            <select id="calorieMealType" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="breakfast">ì•„ì¹¨</option>
                                <option value="lunch">ì ì‹¬</option>
                                <option value="dinner">ì €ë…</option>
                                <option value="snack">ê°„ì‹</option>
                            </select>
                        </div>
                    </div>
                    <button id="analyzeAndLogCalorieButton" class="action-button w-full bg-green-500 hover:bg-green-600 text-white">
                        <i class="fas fa-calculator mr-2"></i>ì¹¼ë¡œë¦¬ ë¶„ì„ ë° ê¸°ë¡
                    </button>
                    <div id="calorieTrackerResultWrapper" class="hidden">
                        <div id="calorieTrackerResult" class="content-card"></div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3">ì˜¤ëŠ˜ì˜ ì„­ì·¨ ê¸°ë¡</h4>
                        <div id="dailyCalorieLog" class="space-y-2">
                            <p class="text-gray-500 italic">ì•„ì§ ê¸°ë¡ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                        <p class="text-right font-semibold text-gray-800 mt-3">ì´ ì„­ì·¨ ì¹¼ë¡œë¦¬: <span id="totalDailyCalories">0</span> kcal</p>
                    </div>
                </section>
            </div>

            <div id="tab13" class="tab-content"> <section class="space-y-7">
                     <h3 class="text-xl font-bold text-indigo-600 mb-4">ğŸ½ï¸ AI ë§ì¶¤ ë‹¤ì´ì–´íŠ¸ í”Œë˜ë„ˆ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="dietGoal" class="block text-md font-semibold text-gray-800 mb-2">ë‹¤ì´ì–´íŠ¸ ëª©í‘œ</label>
                            <select id="dietGoal" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="loss">ì²´ì¤‘ ê°ëŸ‰</option>
                                <option value="maintenance">ì²´ì¤‘ ìœ ì§€</option>
                                <option value="gain">ê·¼ìœ¡ ì¦ê°€</option>
                            </select>
                        </div>
                        <div>
                            <label for="activityLevel" class="block text-md font-semibold text-gray-800 mb-2">í‰ì†Œ í™œë™ëŸ‰</label>
                            <select id="activityLevel" class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="low">ë‚®ìŒ (ì£¼ë¡œ ì•‰ì•„ì„œ ìƒí™œ)</option>
                                <option value="moderate">ë³´í†µ (ê°€ë²¼ìš´ í™œë™ ë˜ëŠ” ì£¼ 1-2íšŒ ìš´ë™)</option>
                                <option value="high">ë†’ìŒ (ê·œì¹™ì ì¸ ìš´ë™ ë˜ëŠ” í™œë™ì ì¸ ì§ì—…)</option>
                            </select>
                        </div>
                         <div>
                            <label for="dietDuration" class="block text-md font-semibold text-gray-800 mb-2">ëª©í‘œ ê¸°ê°„ (ì¼)</label>
                            <input type="number" id="dietDuration" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: 30">
                        </div>
                        <div>
                            <label for="dietPreferences" class="block text-md font-semibold text-gray-800 mb-2">ì‹ë‹¨ ì„ í˜¸/ì œí•œ (ì„ íƒ)</label>
                            <input type="text" id="dietPreferencesPlanner" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ì €íƒ„ìˆ˜í™”ë¬¼, ê¸€ë£¨í… í”„ë¦¬">
                        </div>
                    </div>
                    <button id="generateDietPlanButton" class="action-button w-full bg-purple-500 hover:bg-purple-600 text-white">
                        <i class="fas fa-magic mr-2"></i>AI ë§ì¶¤ ì‹ë‹¨ ìƒì„±
                    </button>
                    <div id="dietPlannerResultWrapper" class="hidden">
                        <div id="dietPlannerResult" class="content-card"></div>
                    </div>
                </section>
            </div>
             <div id="tab14" class="tab-content"> <section class="space-y-7">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">ğŸ’ª ìš´ë™ ë„ìš°ë¯¸ & ì†Œëª¨ ì¹¼ë¡œë¦¬ ê³„ì‚°</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="exerciseType" class="block text-md font-semibold text-gray-800 mb-2">ìš´ë™ ì¢…ë¥˜</label>
                            <input type="text" id="exerciseType" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ê±·ê¸°, ì¡°ê¹…, ìˆ˜ì˜">
                        </div>
                        <div>
                            <label for="exerciseDuration" class="block text-md font-semibold text-gray-800 mb-2">ìš´ë™ ì‹œê°„ (ë¶„)</label>
                            <input type="number" id="exerciseDuration" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: 30">
                        </div>
                    </div>
                    <button id="calculateExerciseCaloriesButton" class="action-button w-full bg-blue-500 hover:bg-blue-600 text-white">
                        <i class="fas fa-fire mr-2"></i>ì†Œëª¨ ì¹¼ë¡œë¦¬ ê³„ì‚° ë° ê¸°ë¡
                    </button>
                    <div id="exerciseTrackerResultWrapper" class="hidden">
                        <div id="exerciseTrackerResult" class="content-card"></div>
                    </div>
                     <div>
                        <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3">ì˜¤ëŠ˜ì˜ ìš´ë™ ê¸°ë¡</h4>
                        <div id="dailyExerciseLog" class="space-y-2">
                            <p class="text-gray-500 italic">ì•„ì§ ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                        <p class="text-right font-semibold text-gray-800 mt-3">ì´ ì†Œëª¨ ì¹¼ë¡œë¦¬: <span id="totalDailyExerciseCalories">0</span> kcal</p>
                    </div>
                </section>
            </div>

            <div id="tab15" class="tab-content"> <section class="space-y-7">
                    <h3 class="text-xl font-bold text-indigo-600 mb-4">ğŸ’§ ìˆ˜ë¶„ ì„­ì·¨ íŠ¸ë˜ì»¤</h3>
                    <div>
                        <label for="waterIntakeGoal" class="block text-md font-semibold text-gray-800 mb-2">ì¼ì¼ ëª©í‘œ ì„­ì·¨ëŸ‰ (ml)</label>
                        <input type="number" id="waterIntakeGoal" class="w-full p-3 border border-gray-300 rounded-lg" value="2000">
                    </div>
                    <div class="flex items-center gap-4">
                        <input type="number" id="waterIntakeAmount" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì„­ì·¨ëŸ‰ (ml)" value="250">
                        <button id="logWaterIntakeButton" class="py-3 px-6 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg whitespace-nowrap">
                            <i class="fas fa-plus mr-2"></i>ê¸°ë¡
                        </button>
                    </div>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div id="waterIntakeProgress" class="bg-blue-500 h-6 rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: 0%">0%</div>
                        </div>
                        <p class="text-sm text-gray-600 mt-1 text-center">ì˜¤ëŠ˜ ë§ˆì‹  ë¬¼: <span id="currentWaterIntake">0</span> ml / <span id="waterGoalDisplay">2000</span> ml</p>
                    </div>
                     <div id="waterIntakeResultWrapper" class="hidden"> <div id="waterIntakeResult" class="content-card"></div>
                    </div>
                </section>
            </div>

            <div id="tab16" class="tab-content"> <section class="space-y-7">
                     <h3 class="text-xl font-bold text-indigo-600 mb-4">ğŸ’¡ ì˜¤ëŠ˜ì˜ ë‹¤ì´ì–´íŠ¸ ê¿€íŒ</h3>
                    <button id="getDietTipButton" class="action-button w-full bg-pink-500 hover:bg-pink-600 text-white">
                        <i class="fas fa-seedling mr-2"></i>ìƒˆë¡œìš´ ê¿€íŒ ë³´ê¸°
                    </button>
                    <div id="dietTipResultWrapper" class="hidden">
                        <div id="dietTipResult" class="content-card"></div>
                    </div>
                </section>
            </div>


        </div>
        
        <div id="loadingIndicator" class="my-10 text-indigo-600 hidden flex flex-col items-center justify-center text-lg">
            <svg class="spinner w-12 h-12 mr-3 border-indigo-500 rounded-full" viewBox="0 0 24 24"></svg>
            <p id="loadingText" class="mt-4 font-semibold text-gray-700">AI ì…°í”„ê°€ ì—´ì‹¬íˆ ìš”ë¦¬ ì¤‘...</p>
        </div>

        <section id="recipeOutputSection" class="hidden">
             <div class="content-card">
                <h2 id="recipeOutputTitle" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 text-center">AI ì…°í”„ì˜ ë‹µë³€</h2>
                <div id="recipeDisplay" class="w-full min-h-[100px] space-y-6"> 
                    <p class="text-gray-500 italic text-center py-8">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
                <div id="additionalActionsSection" class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row flex-wrap justify-center gap-3 sm:gap-4 hidden">
                    <button id="generateShoppingListButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-list-check mr-2"></i> ì¥ë³´ê¸° ëª©ë¡ ìƒì„±
                    </button>
                    <button id="substituteIngredientButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-exchange-alt mr-2"></i> ì¬ë£Œ ëŒ€ì²´ ì¶”ì²œ
                    </button>
                    <button id="analyzeNutritionButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-chart-pie mr-2"></i> ì˜ì–‘ ì •ë³´ ë¶„ì„
                    </button>
                    <button id="saveToRecipeBookButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i> ë ˆì‹œí”¼ë¶ì— ì €ì¥
                    </button>
                </div>
                <div id="shoppingListResult" class="hidden"> </div>
                <div id="nutritionAnalysisResult" class="hidden"> </div>
             </div>
        </section>
    </div>

    <div id="substituteModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full mx-auto transform transition-all duration-300 ease-out scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">ì¬ë£Œ ëŒ€ì²´ ì¶”ì²œ ìš”ì²­</h3>
                <button id="closeSubstituteModal" class="text-gray-400 hover:text-gray-600 transition-colors text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-600 text-sm">í˜„ì¬ ë³´ê³  ê³„ì‹  ë ˆì‹œí”¼ì—ì„œ ë°”ê¾¸ê³  ì‹¶ì€ ì¬ë£Œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. AIê°€ ì ì ˆí•œ ëŒ€ì²´ ì¬ë£Œë¥¼ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.</p>
                <div>
                    <label for="ingredientToSubstitute" class="block text-sm font-medium text-gray-700 mb-1">ë°”ê¾¸ê³  ì‹¶ì€ ì¬ë£Œ ì´ë¦„:</label>
                    <input type="text" id="ingredientToSubstitute" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ìš°ìœ , ë¼ì§€ê³ ê¸° ëª©ì‚´">
                </div>
                 <div>
                    <label for="substitutionReason" class="block text-sm font-medium text-gray-700 mb-1">ëŒ€ì²´ ì´ìœ  (ì„ íƒ ì‚¬í•­):</label>
                    <input type="text" id="substitutionReason" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ì•Œë ˆë¥´ê¸°, ì±„ì‹, ì§‘ì— ì—†ì–´ì„œ">
                </div>
            </div>
            <div class="mt-8 text-right">
                <button id="confirmSubstituteButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2.5 px-6 rounded-lg transition-colors text-sm shadow-md hover:shadow-lg">
                    AIì—ê²Œ ì¶”ì²œ ìš”ì²­
                </button>
            </div>
        </div>
    </div>


    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-auto transform transition-all duration-300 ease-out scale-95 opacity-0" 
             data-modal-state="closed">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold text-red-600 flex items-center"><i class="fas fa-exclamation-triangle mr-3"></i>ì˜¤ë¥˜ ë°œìƒ</h3>
                <button id="closeErrorModal" class="text-gray-400 hover:text-gray-600 transition-colors text-2xl">&times;</button>
            </div>
            <p id="errorMessage" class="text-gray-700 mb-8 text-md leading-relaxed">ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            <div class="text-right">
                <button id="confirmErrorModal" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-6 rounded-lg transition-colors text-sm shadow-md hover:shadow-lg">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <textarea id="clipboardHelper" style="position: absolute; left: -9999px; top: -9999px;"></textarea>


    <script>
    // ì „ì—­ ë³€ìˆ˜
    let currentRecipeFullText = ""; 
    let currentRecipeTitle = ""; 

    // DOM ìš”ì†Œë“¤ì„ ì €ì¥í•  ê°ì²´
    const UIElements = {};

    document.addEventListener('DOMContentLoaded', () => {
        // ì£¼ìš” UI ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
        UIElements.tabButtons = document.querySelectorAll('.tab-button');
        UIElements.tabContents = document.querySelectorAll('.tab-content');
        UIElements.mobileMoreMenuButton = document.getElementById('mobileMoreMenuButton');
        UIElements.coreTabsContainer = document.getElementById('coreTabs'); 
        UIElements.additionalTabsContainer = document.getElementById('additionalTabs'); 

        UIElements.dietaryPreferencesInput = document.getElementById('dietaryPreferences');
        UIElements.cuisineStyleInput = document.getElementById('cuisineStyle');
        UIElements.generateRecipeButton = document.getElementById('generateRecipeButton');
        UIElements.whatToEatKeywordsInput = document.getElementById('whatToEatKeywords');
        UIElements.recommendDishButton = document.getElementById('recommendDishButton');
        UIElements.recommendationDisplayWrapper = document.getElementById('recommendationDisplayWrapper');
        UIElements.recommendationDisplay = document.getElementById('recommendationDisplay');
        UIElements.specificDishNameInput = document.getElementById('specificDishName');
        UIElements.searchSpecificDishButton = document.getElementById('searchSpecificDishButton');
        UIElements.leftoverIngredientsInput = document.getElementById('leftoverIngredients');
        UIElements.leftoverCuisineStyleInput = document.getElementById('leftoverCuisineStyle');
        UIElements.generateLeftoverRecipeButton = document.getElementById('generateLeftoverRecipeButton');
        UIElements.mealPlanPreferencesInput = document.getElementById('mealPlanPreferences');
        UIElements.generateMealPlanButton = document.getElementById('generateMealPlanButton');
        UIElements.mealPlanDisplayWrapper = document.getElementById('mealPlanDisplayWrapper');
        UIElements.mealPlanDisplay = document.getElementById('mealPlanDisplay');
        UIElements.themeKeywordsInput = document.getElementById('themeKeywords');
        UIElements.generateThemedRecipesButton = document.getElementById('generateThemedRecipesButton');
        UIElements.themedRecipesDisplayWrapper = document.getElementById('themedRecipesDisplayWrapper');
        UIElements.themedRecipesDisplay = document.getElementById('themedRecipesDisplay');
        
        // í—¬ìŠ¤ í”Œë˜ë„ˆ UI ìš”ì†Œ
        UIElements.calorieFoodNameInput = document.getElementById('calorieFoodName');
        UIElements.calorieMealTypeSelect = document.getElementById('calorieMealType');
        UIElements.analyzeAndLogCalorieButton = document.getElementById('analyzeAndLogCalorieButton');
        UIElements.calorieTrackerResultWrapper = document.getElementById('calorieTrackerResultWrapper');
        UIElements.calorieTrackerResult = document.getElementById('calorieTrackerResult');
        UIElements.dailyCalorieLogDiv = document.getElementById('dailyCalorieLog');
        UIElements.totalDailyCaloriesSpan = document.getElementById('totalDailyCalories');

        UIElements.dietGoalSelect = document.getElementById('dietGoal');
        UIElements.activityLevelSelect = document.getElementById('activityLevel');
        UIElements.dietDurationInput = document.getElementById('dietDuration');
        UIElements.dietPreferencesPlannerInput = document.getElementById('dietPreferencesPlanner');
        UIElements.generateDietPlanButton = document.getElementById('generateDietPlanButton');
        UIElements.dietPlannerResultWrapper = document.getElementById('dietPlannerResultWrapper');
        UIElements.dietPlannerResult = document.getElementById('dietPlannerResult');
        
        UIElements.exerciseTypeInput = document.getElementById('exerciseType');
        UIElements.exerciseDurationInput = document.getElementById('exerciseDuration');
        UIElements.calculateExerciseCaloriesButton = document.getElementById('calculateExerciseCaloriesButton');
        UIElements.exerciseTrackerResultWrapper = document.getElementById('exerciseTrackerResultWrapper');
        UIElements.exerciseTrackerResult = document.getElementById('exerciseTrackerResult');
        UIElements.dailyExerciseLogDiv = document.getElementById('dailyExerciseLog');
        UIElements.totalDailyExerciseCaloriesSpan = document.getElementById('totalDailyExerciseCalories');

        UIElements.waterIntakeGoalInput = document.getElementById('waterIntakeGoal');
        UIElements.waterIntakeAmountInput = document.getElementById('waterIntakeAmount');
        UIElements.logWaterIntakeButton = document.getElementById('logWaterIntakeButton');
        UIElements.waterIntakeProgressDiv = document.getElementById('waterIntakeProgress');
        UIElements.currentWaterIntakeSpan = document.getElementById('currentWaterIntake');
        UIElements.waterGoalDisplaySpan = document.getElementById('waterGoalDisplay');
        UIElements.waterIntakeResultWrapper = document.getElementById('waterIntakeResultWrapper'); // AI ë‹µë³€ìš©
        UIElements.waterIntakeResult = document.getElementById('waterIntakeResult'); // AI ë‹µë³€ìš©

        UIElements.getDietTipButton = document.getElementById('getDietTipButton');
        UIElements.dietTipResultWrapper = document.getElementById('dietTipResultWrapper');
        UIElements.dietTipResult = document.getElementById('dietTipResult');


        UIElements.beverageDishNameInput = document.getElementById('beverageDishName');
        UIElements.getBeveragePairingButton = document.getElementById('getBeveragePairingButton');
        UIElements.beveragePairingResultWrapper = document.getElementById('beveragePairingResultWrapper');
        UIElements.beveragePairingResult = document.getElementById('beveragePairingResult');

        UIElements.cookingTermInput = document.getElementById('cookingTerm');
        UIElements.searchCookingTermButton = document.getElementById('searchCookingTermButton');
        UIElements.cookingTermResultWrapper = document.getElementById('cookingTermResultWrapper');
        UIElements.cookingTermResult = document.getElementById('cookingTermResult');
        
        UIElements.unitValueInput = document.getElementById('unitValue');
        UIElements.fromUnitInput = document.getElementById('fromUnit');
        UIElements.toUnitInput = document.getElementById('toUnit');
        UIElements.convertUnitButton = document.getElementById('convertUnitButton');
        UIElements.unitConversionResultWrapper = document.getElementById('unitConversionResultWrapper');
        UIElements.unitConversionResult = document.getElementById('unitConversionResult');

        UIElements.seasonInput = document.getElementById('seasonInput');
        UIElements.getSeasonalRecipesButton = document.getElementById('getSeasonalRecipesButton');
        UIElements.seasonalRecipeResultWrapper = document.getElementById('seasonalRecipeResultWrapper');
        UIElements.seasonalRecipeResult = document.getElementById('seasonalRecipeResult');

        UIElements.savedRecipesListDiv = document.getElementById('savedRecipesList');
        UIElements.saveToRecipeBookButton = document.getElementById('saveToRecipeBookButton');


        UIElements.loadingIndicator = document.getElementById('loadingIndicator');
        UIElements.loadingText = document.getElementById('loadingText');
        UIElements.recipeOutputSection = document.getElementById('recipeOutputSection');
        UIElements.recipeOutputTitle = document.getElementById('recipeOutputTitle');
        UIElements.recipeDisplay = document.getElementById('recipeDisplay');
        UIElements.additionalActionsSection = document.getElementById('additionalActionsSection');
        UIElements.generateShoppingListButton = document.getElementById('generateShoppingListButton'); 
        UIElements.shoppingListResultDiv = document.getElementById('shoppingListResult'); 
        UIElements.substituteIngredientButton = document.getElementById('substituteIngredientButton');
        UIElements.analyzeNutritionButton = document.getElementById('analyzeNutritionButton'); 
        UIElements.nutritionAnalysisResultDiv = document.getElementById('nutritionAnalysisResult'); 
        UIElements.substituteModal = document.getElementById('substituteModal');
        UIElements.substituteModalContent = UIElements.substituteModal ? UIElements.substituteModal.querySelector('div > div') : null;
        UIElements.closeSubstituteModalButton = document.getElementById('closeSubstituteModal');
        UIElements.ingredientToSubstituteInput = document.getElementById('ingredientToSubstitute');
        UIElements.substitutionReasonInput = document.getElementById('substitutionReason');
        UIElements.confirmSubstituteButton = document.getElementById('confirmSubstituteButton');
        UIElements.errorModal = document.getElementById('errorModal');
        UIElements.errorModalContentEl = UIElements.errorModal ? UIElements.errorModal.querySelector('div[data-modal-state]') : null;
        UIElements.errorMessageElement = document.getElementById('errorMessage');
        UIElements.closeErrorModalButton = document.getElementById('closeErrorModal');
        UIElements.confirmErrorModalButton = document.getElementById('confirmErrorModal');
        UIElements.clipboardHelper = document.getElementById('clipboardHelper');

        // ëª¨ë°”ì¼ "ë”ë³´ê¸°" ë©”ë‰´ í† ê¸€
        if (UIElements.mobileMoreMenuButton && UIElements.additionalTabsContainer) {
            UIElements.mobileMoreMenuButton.addEventListener('click', () => {
                const isHidden = UIElements.additionalTabsContainer.classList.contains('hidden');
                const buttonTextEl = UIElements.mobileMoreMenuButton.querySelector('#mobileMoreMenuButtonText');
                const iconEl = UIElements.mobileMoreMenuButton.querySelector('#mobileMoreMenuIcon');

                if (isHidden) {
                    UIElements.additionalTabsContainer.classList.remove('hidden');
                    UIElements.additionalTabsContainer.classList.add('grid', 'grid-cols-3', 'sm:grid-cols-4', 'gap-x-1', 'gap-y-2', 'mt-2', 'py-2', 'border-t', 'border-gray-200');
                    if(buttonTextEl) buttonTextEl.textContent = "ë©”ë‰´ ì ‘ê¸°";
                    if(iconEl) iconEl.classList.replace('fa-chevron-down', 'fa-chevron-up');
                } else {
                    UIElements.additionalTabsContainer.classList.add('hidden');
                    UIElements.additionalTabsContainer.classList.remove('grid', 'grid-cols-3', 'sm:grid-cols-4', 'gap-x-1', 'gap-y-2', 'mt-2', 'py-2', 'border-t', 'border-gray-200');
                    if(buttonTextEl) buttonTextEl.textContent = "ë” ë§ì€ ë©”ë‰´ ë³´ê¸°";
                    if(iconEl) iconEl.classList.replace('fa-chevron-up', 'fa-chevron-down');
                }
            });
        }


        // íƒ­ ê¸°ëŠ¥ ì´ˆê¸°í™”
        if (UIElements.tabButtons && UIElements.tabContents) {
            UIElements.tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    UIElements.tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    UIElements.tabContents.forEach(content => content.classList.remove('active'));
                    const activeTabContent = document.getElementById(button.dataset.tab);
                    if (activeTabContent) activeTabContent.classList.add('active');
                    
                    if(UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                    [UIElements.recommendationDisplayWrapper, UIElements.mealPlanDisplayWrapper, UIElements.themedRecipesDisplayWrapper, 
                     UIElements.beveragePairingResultWrapper, UIElements.cookingTermResultWrapper, UIElements.unitConversionResultWrapper,
                     UIElements.seasonalRecipeResultWrapper, UIElements.calorieTrackerResultWrapper, UIElements.dietPlannerResultWrapper,
                     UIElements.exerciseTrackerResultWrapper, UIElements.waterIntakeResultWrapper, UIElements.dietTipResultWrapper
                    ].forEach(wrapper => {
                        if (wrapper) wrapper.classList.add('hidden');
                    });

                    if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden'); 
                    if(UIElements.nutritionAnalysisResultDiv) {
                        UIElements.nutritionAnalysisResultDiv.classList.add('hidden');
                        UIElements.nutritionAnalysisResultDiv.innerHTML = ''; 
                    }
                    if(UIElements.shoppingListResultDiv) {
                        UIElements.shoppingListResultDiv.classList.add('hidden');
                        UIElements.shoppingListResultDiv.innerHTML = '';
                    }
                    currentRecipeFullText = ""; 
                    currentRecipeTitle = "";

                    if (button.dataset.tab === 'tab11' && UIElements.savedRecipesListDiv) {
                        loadAndDisplaySavedRecipes();
                    }
                    if (button.dataset.tab === 'tab12' && UIElements.dailyCalorieLogDiv) {
                        loadDailyCalorieLog();
                    }
                     if (button.dataset.tab === 'tab14' && UIElements.dailyExerciseLogDiv) {
                        loadDailyExerciseLog();
                    }
                    if (button.dataset.tab === 'tab15' && UIElements.waterIntakeProgressDiv) {
                        loadAndUpdateWaterIntakeProgress();
                    }


                    // ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ë©”ë‰´ì˜ íƒ­ ì„ íƒ í›„ "ë”ë³´ê¸°" ë©”ë‰´ ë‹«ê¸°
                    if (window.innerWidth < 768 && UIElements.additionalTabsContainer && !UIElements.additionalTabsContainer.classList.contains('hidden') && button.classList.contains('additional-tab')) {
                        UIElements.additionalTabsContainer.classList.add('hidden');
                        UIElements.additionalTabsContainer.classList.remove('grid', 'grid-cols-3', 'sm:grid-cols-4', 'gap-x-1', 'gap-y-2', 'mt-2', 'py-2', 'border-t', 'border-gray-200');
                        const buttonTextEl = UIElements.mobileMoreMenuButton.querySelector('#mobileMoreMenuButtonText');
                        const iconEl = UIElements.mobileMoreMenuButton.querySelector('#mobileMoreMenuIcon');
                        if(buttonTextEl) buttonTextEl.textContent = "ë” ë§ì€ ë©”ë‰´ ë³´ê¸°";
                        if(iconEl) iconEl.classList.replace('fa-chevron-up', 'fa-chevron-down');
                    }
                });
            });
        }
        
        function showError(message) {
            if(UIElements.errorMessageElement) UIElements.errorMessageElement.textContent = message;
            if(UIElements.errorModal) UIElements.errorModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                if(UIElements.errorModalContentEl) {
                    UIElements.errorModalContentEl.classList.remove('scale-95', 'opacity-0');
                    UIElements.errorModalContentEl.classList.add('scale-100', 'opacity-100');
                }
            });
        }
        function hideErrorModal() {
            if(UIElements.errorModalContentEl){
                UIElements.errorModalContentEl.classList.add('scale-95', 'opacity-0');
                UIElements.errorModalContentEl.classList.remove('scale-100', 'opacity-100');
            }
            if(UIElements.errorModal) {
                setTimeout(() => UIElements.errorModal.classList.add('hidden'), 300);
            }
        }
        if(UIElements.closeErrorModalButton) UIElements.closeErrorModalButton.addEventListener('click', hideErrorModal);
        if(UIElements.confirmErrorModalButton) UIElements.confirmErrorModalButton.addEventListener('click', hideErrorModal);

        function showSubstituteModal() {
            if(UIElements.ingredientToSubstituteInput) UIElements.ingredientToSubstituteInput.value = ''; 
            if(UIElements.substitutionReasonInput) UIElements.substitutionReasonInput.value = '';
            if(UIElements.substituteModal) UIElements.substituteModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                if(UIElements.substituteModalContent){
                    UIElements.substituteModalContent.classList.remove('scale-95', 'opacity-0');
                    UIElements.substituteModalContent.classList.add('scale-100', 'opacity-100');
                }
            });
        }
        function hideSubstituteModal() {
             if(UIElements.substituteModalContent){
                UIElements.substituteModalContent.classList.add('scale-95', 'opacity-0');
                UIElements.substituteModalContent.classList.remove('scale-100', 'opacity-100');
            }
            if(UIElements.substituteModal) {
                setTimeout(() => UIElements.substituteModal.classList.add('hidden'), 300);
            }
        }
        if(UIElements.substituteIngredientButton) UIElements.substituteIngredientButton.addEventListener('click', showSubstituteModal);
        if(UIElements.closeSubstituteModalButton) UIElements.closeSubstituteModalButton.addEventListener('click', hideSubstituteModal);

        function setLoading(isLoading, message = "AI ì…°í”„ê°€ ì—´ì‹¬íˆ ìš”ë¦¬ ì¤‘...") {
            const allActionButtons = [
                UIElements.generateRecipeButton, UIElements.recommendDishButton, UIElements.searchSpecificDishButton, 
                UIElements.generateLeftoverRecipeButton, UIElements.generateMealPlanButton, UIElements.generateThemedRecipesButton, 
                UIElements.confirmSubstituteButton, UIElements.analyzeNutritionButton, UIElements.generateShoppingListButton,
                UIElements.getBeveragePairingButton, UIElements.searchCookingTermButton, UIElements.convertUnitButton,
                UIElements.getSeasonalRecipesButton, UIElements.saveToRecipeBookButton,
                UIElements.analyzeAndLogCalorieButton, UIElements.generateDietPlanButton, UIElements.calculateExerciseCaloriesButton,
                UIElements.logWaterIntakeButton, UIElements.getDietTipButton
            ];
            if (isLoading) {
                if(UIElements.loadingIndicator) UIElements.loadingIndicator.classList.remove('hidden');
                if(UIElements.loadingText) UIElements.loadingText.textContent = message;
                allActionButtons.forEach(btn => { if(btn) {btn.disabled = true; btn.classList.add('opacity-70', 'cursor-not-allowed');} });
            } else {
                if(UIElements.loadingIndicator) UIElements.loadingIndicator.classList.add('hidden');
                allActionButtons.forEach(btn => { if(btn) {btn.disabled = false; btn.classList.remove('opacity-70', 'cursor-not-allowed');} });
            }
        }

        async function callGeminiAPI(prompt, isAuxiliaryAction = false) {
            setLoading(true, isAuxiliaryAction ? "AIê°€ ì •ë³´ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..." : "ìµœê³ ì˜ ë ˆì‹œí”¼ë¥¼ êµ¬ìƒ ì¤‘...");
            
            const API_ENDPOINT = "https://magenta-morning-find.glitch.me/generate"; 
            const payload = { message: prompt };
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });

                if (!response.ok) {
                    let errorDetails = `ì„œë²„ ì‘ë‹µ: ${response.statusText || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`; 
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.message || errorData.error || (typeof errorData === 'object' ? JSON.stringify(errorData) : String(errorData));
                        if (!errorDetails || errorDetails === '{}' || errorDetails.trim() === "") { 
                           errorDetails = `ì„œë²„ ì‘ë‹µ: ${response.statusText || 'ì˜¤ë¥˜ ë‚´ìš© ì—†ìŒ'}`; 
                        }
                    } catch (jsonError) {
                        console.warn("API ì˜¤ë¥˜ ì‘ë‹µì´ JSONì´ ì•„ë‹ˆë¯€ë¡œ í…ìŠ¤íŠ¸ë¡œ ì½ê¸°ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.", jsonError);
                        try {
                            const errorText = await response.text();
                            errorDetails = errorText.trim() || `ì„œë²„ ì‘ë‹µ: ${response.statusText || 'ì˜¤ë¥˜ ë‚´ìš© ì—†ìŒ'}`;
                        } catch (textError) {
                            console.error("API ì˜¤ë¥˜ ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", textError);
                            errorDetails = `ì„œë²„ ì‘ë‹µ: ${response.statusText || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}, ì‘ë‹µ ë³¸ë¬¸ ì½ê¸° ì‹¤íŒ¨`;
                        }
                    }
                    const errorMsg = `API ìš”ì²­ ì‹¤íŒ¨ (${response.status}): ${errorDetails}`;
                    console.error("API Error Details:", errorDetails); 
                    throw new Error(errorMsg);
                }

                const result = await response.json();
                
                if (result.text) { 
                    return result.text;
                } else if (result.generated_text) { 
                    return result.generated_text;
                } else if (result.reply) { 
                    return result.reply;
                } else if (typeof result === 'string') { 
                    return result;
                }
                else if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) { // Gemini í‘œì¤€ ì‘ë‹µ í˜•ì‹
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("API ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ê±°ë‚˜, ì˜ˆìƒì¹˜ ëª»í•œ êµ¬ì¡°ì…ë‹ˆë‹¤:", result);
                    throw new Error('AIë¡œë¶€í„° ìœ íš¨í•œ í…ìŠ¤íŠ¸ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) { 
                console.error("API í˜¸ì¶œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error.name, error.message, error.stack); 
                showError(error.message || "API í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return null;
            } finally {
                setLoading(false);
            }
        }
        
        function applyBoldMarkdown(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }
        
        function extractRecipeTitle(recipeText) {
            if (!recipeText) return "ì œëª© ì—†ëŠ” ë ˆì‹œí”¼";
            let title = "ì œëª© ì—†ëŠ” ë ˆì‹œí”¼";
            const patterns = [
                /^\s*(?:(?:##\s*)?\*\*(?:ìš”ë¦¬\s*)?ì´ë¦„:\*\*|##\s*(?:ìš”ë¦¬\s*)?ì´ë¦„:)\s*(.+)/im, 
                /^\s*\*\*(?:ìš”ë¦¬\s*)?ì´ë¦„:\*\*\s*(.+)/im,                                
                /^\s*(?:ìš”ë¦¬\s*)?ì´ë¦„:\s*(.+)/im,                                       
                /^\s*##\s*(?!.*\*\*ì´ë¦„:\*\*)(.+)/im, 
                /^\s*\*\*(?!ì´ë¦„:\s*)(.+?)\*\*/im,      
                /^\s*([^#*:\n][^:\n]*)/im 
            ];
            for (const pattern of patterns) {
                const match = recipeText.match(pattern);
                if (match && match[1] && match[1].trim() !== "") {
                    title = match[1].trim();
                    break; 
                }
            }
            return title.replace(/âœ¨/g, '').replace(/\*\*/g, '').replace(/##/g, '').trim().substring(0, 50) || "ì œëª© ì—†ëŠ” ë ˆì‹œí”¼";
        }


        function displayFormattedText(rawText, containerElement, title, outputType = "recipe") {
            if (!(containerElement instanceof HTMLElement)) {
                console.error(`displayFormattedText: containerElement (${containerElement ? containerElement.id : 'N/A'})ê°€ ìœ íš¨í•œ HTML ìš”ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤. Title: "${title}"`);
                showError(`ì½˜í…ì¸ ë¥¼ í‘œì‹œí•  ë‚´ë¶€ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${title}`);
                return;
            }

            if (!rawText || rawText.trim() === "") {
                containerElement.innerHTML = `<p class="text-gray-500 italic text-center py-8">í‘œì‹œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                if (UIElements.recipeOutputSection && (outputType === "recipe" || outputType === "substitution")) {
                    UIElements.recipeOutputSection.classList.remove('hidden'); 
                } else if (UIElements[outputType + "ResultWrapper"]) { 
                    UIElements[outputType + "ResultWrapper"].classList.remove('hidden');
                }
                if (outputType === "recipe" && UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden');
                return;
            }

            containerElement.innerHTML = ''; 
            
            let cleanBaseTitle = title.replace(/âœ¨/g, '').trim();

            if (outputType === "recipe" || outputType === "substitution") {
                if (outputType === "recipe") { 
                    currentRecipeFullText = rawText; 
                    currentRecipeTitle = extractRecipeTitle(rawText); 
                    cleanBaseTitle = `"${currentRecipeTitle}" ë ˆì‹œí”¼`; 
                    if(UIElements.recipeOutputTitle) UIElements.recipeOutputTitle.textContent = cleanBaseTitle;

                    if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.remove('hidden'); 
                    if(UIElements.nutritionAnalysisResultDiv) {
                        UIElements.nutritionAnalysisResultDiv.classList.add('hidden');
                        UIElements.nutritionAnalysisResultDiv.innerHTML = ''; 
                    }
                    if(UIElements.shoppingListResultDiv) {
                        UIElements.shoppingListResultDiv.classList.add('hidden');
                        UIElements.shoppingListResultDiv.innerHTML = '';
                    }
                } else if (outputType === "substitution") { 
                     if(UIElements.recipeOutputTitle) UIElements.recipeOutputTitle.textContent = cleanBaseTitle;
                    if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.remove('hidden'); 
                }
            }

            const lines = rawText.split('\n');
            let currentList = null; 
            let isFirstTitleInCard = true; 

            lines.forEach(line => {
                let processedLine = line.trim();
                if (!processedLine) return; 

                const buttonPatternRegex = /(?:->\s*)?(?:\[|\uFF3B)([^\]\uFF3D]+?)(?:\]|\uFF3D)\s*ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°/;
                if ((outputType === "recommendation" || outputType === "themedRecipes" || outputType === "seasonalRecipe") && buttonPatternRegex.test(processedLine)) {
                    const dishNameMatch = processedLine.match(buttonPatternRegex);
                    if (dishNameMatch && dishNameMatch[1]) {
                        const dishName = dishNameMatch[1].trim();
                        const pButton = document.createElement('p');
                        pButton.classList.add('mt-6', 'text-center'); 
                        const button = document.createElement('button');
                        button.innerHTML = `<i class="fas fa-utensils mr-2"></i> ${applyBoldMarkdown(dishName)} ë ˆì‹œí”¼ ë³´ê¸°`;
                        button.classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'text-white', 'font-semibold', 'py-3', 'px-6', 'rounded-lg', 'shadow-md', 'hover:shadow-lg', 'transition-all', 'duration-150', 'text-base', 'inline-flex', 'items-center');
                        button.onclick = () => {
                            if(UIElements.specificDishNameInput) UIElements.specificDishNameInput.value = dishName; 
                            if (UIElements.tabButtons && UIElements.tabContents && UIElements.searchSpecificDishButton) {
                                UIElements.tabButtons.forEach(btn => btn.classList.remove('active')); 
                                const tab3Button = document.querySelector('button[data-tab="tab3"]');
                                if(tab3Button) tab3Button.classList.add('active'); 
                                UIElements.tabContents.forEach(content => content.classList.remove('active')); 
                                const tab3Content = document.getElementById('tab3');
                                if(tab3Content) tab3Content.classList.add('active'); 
                                [UIElements.recommendationDisplayWrapper, UIElements.themedRecipesDisplayWrapper, UIElements.seasonalRecipeResultWrapper].forEach(wrapper => {
                                    if(wrapper) wrapper.classList.add('hidden');
                                });
                                UIElements.searchSpecificDishButton.click(); 
                            }
                        };
                        pButton.appendChild(button);
                        containerElement.appendChild(pButton);
                        return; 
                    }
                }
                
                if (outputType === "mealPlan" && /^(ì›”ìš”ì¼|í™”ìš”ì¼|ìˆ˜ìš”ì¼|ëª©ìš”ì¼|ê¸ˆìš”ì¼|í† ìš”ì¼|ì¼ìš”ì¼)\s*:/i.test(processedLine)) {
                    if (currentList) { containerElement.appendChild(currentList); currentList = null; } 
                    const parts = processedLine.split(/:(.+)/); 
                    const day = parts[0].trim();
                    const mealDesc = parts[1] ? parts[1].trim() : "ì¶”ì²œ ë©”ë‰´ ì •ë³´ ì—†ìŒ";
                    
                    const mealItemDiv = document.createElement('div');
                    mealItemDiv.classList.add('meal-plan-item');
                    
                    const dayStrong = document.createElement('strong');
                    dayStrong.textContent = day + ": ";
                    mealItemDiv.appendChild(dayStrong);
                    
                    const descSpan = document.createElement('span');
                    const mealNameMatch = mealDesc.match(/^([^-(]+)/);
                    const mealNameForButton = mealNameMatch ? mealNameMatch[1].trim() : mealDesc.substring(0,15); 

                    descSpan.innerHTML = applyBoldMarkdown(mealDesc); 
                    mealItemDiv.appendChild(descSpan);

                    const searchRecipeBtn = document.createElement('button');
                    searchRecipeBtn.innerHTML = `<i class="fas fa-search mr-1"></i> "${mealNameForButton}" ë ˆì‹œí”¼ ê²€ìƒ‰`;
                    searchRecipeBtn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700', 'font-medium', 'py-1', 'px-2', 'rounded', 'text-xs', 'block', 'mt-2');
                    searchRecipeBtn.onclick = () => {
                        if(UIElements.specificDishNameInput) UIElements.specificDishNameInput.value = mealNameForButton;
                        if (UIElements.tabButtons && UIElements.tabContents && UIElements.searchSpecificDishButton) {
                            UIElements.tabButtons.forEach(btn => btn.classList.remove('active'));
                            const tab3Button = document.querySelector('button[data-tab="tab3"]');
                            if(tab3Button) tab3Button.classList.add('active');
                            UIElements.tabContents.forEach(content => content.classList.remove('active'));
                            const tab3Content = document.getElementById('tab3');
                            if(tab3Content) tab3Content.classList.add('active');
                            if(UIElements.mealPlanDisplayWrapper) UIElements.mealPlanDisplayWrapper.classList.add('hidden');
                            UIElements.searchSpecificDishButton.click();
                        }
                    };
                    mealItemDiv.appendChild(searchRecipeBtn);
                    containerElement.appendChild(mealItemDiv);
                    return; 
                }
                
                 if ((outputType === "themedRecipes" || outputType === "seasonalRecipe") && /^\d+\.\s*([^:]+):\s*(.+)/.test(processedLine)) {
                     if (currentList) { containerElement.appendChild(currentList); currentList = null; }
                    const itemMatch = processedLine.match(/^\d+\.\s*([^:]+):\s*(.+)/);
                    const recipeName = itemMatch[1].trim();
                    const recipeDesc = itemMatch[2].trim();

                    const themedItemDiv = document.createElement('div');
                    themedItemDiv.classList.add(outputType === "themedRecipes" ? 'themed-recipe-item' : 'seasonal-recipe-item'); // í´ë˜ìŠ¤ êµ¬ë¶„

                    const nameStrong = document.createElement('strong');
                    nameStrong.textContent = recipeName;
                    themedItemDiv.appendChild(nameStrong);

                    const descP = document.createElement('p');
                    descP.textContent = recipeDesc;
                    descP.classList.add('text-sm', 'text-gray-600', 'mt-1');
                    themedItemDiv.appendChild(descP);
                    
                    const pButton = document.createElement('p');
                    pButton.classList.add('mt-2'); 
                    const button = document.createElement('button');
                    button.innerHTML = `<i class="fas fa-utensils mr-2"></i> ${applyBoldMarkdown(recipeName)} ë ˆì‹œí”¼ ë³´ê¸°`;
                    button.classList.add('bg-indigo-100', 'hover:bg-indigo-200', 'text-indigo-700', 'font-medium', 'py-1', 'px-2', 'rounded', 'text-xs');

                    button.onclick = () => {
                        if(UIElements.specificDishNameInput) UIElements.specificDishNameInput.value = recipeName; 
                        if (UIElements.tabButtons && UIElements.tabContents && UIElements.searchSpecificDishButton) {
                            UIElements.tabButtons.forEach(btn => btn.classList.remove('active')); 
                            const tab3Button = document.querySelector('button[data-tab="tab3"]');
                            if(tab3Button) tab3Button.classList.add('active'); 
                            UIElements.tabContents.forEach(content => content.classList.remove('active')); 
                            const tab3Content = document.getElementById('tab3');
                            if(tab3Content) tab3Content.classList.add('active'); 
                            if(UIElements.themedRecipesDisplayWrapper) UIElements.themedRecipesDisplayWrapper.classList.add('hidden');
                            if(UIElements.seasonalRecipeResultWrapper) UIElements.seasonalRecipeResultWrapper.classList.add('hidden');
                            UIElements.searchSpecificDishButton.click(); 
                        }
                    };
                    pButton.appendChild(button);
                    themedItemDiv.appendChild(pButton);
                    containerElement.appendChild(themedItemDiv);
                    return;
                }

                // ì œëª© ì²˜ë¦¬ ë¡œì§ ê°œì„ 
                let headingLevel = 0;
                let titleText = processedLine;
                let isSectionHeader = false; 

                const sectionHeaderColonMatch = processedLine.match(/^(\*\*.+?:\*\*|[^#\n*]+?:)\s*(.*)/);
                if (sectionHeaderColonMatch && !processedLine.match(/^(\d+\.|\*|-)\s/)) { 
                    if (currentList) { containerElement.appendChild(currentList); currentList = null; }
                    const headerP = document.createElement('p');
                    headerP.classList.add('text-gray-800', 'mb-2');
                    if (!isFirstTitleInCard) headerP.classList.add('mt-4');
                    
                    let labelPart = sectionHeaderColonMatch[1].trim();
                    let contentPart = sectionHeaderColonMatch[2] ? sectionHeaderColonMatch[2].trim() : "";
                    
                    headerP.innerHTML = `${applyBoldMarkdown(labelPart)} ${applyBoldMarkdown(contentPart)}`;
                    containerElement.appendChild(headerP);
                    isFirstTitleInCard = false;
                    isSectionHeader = true;
                } else {
                    if (processedLine.startsWith('## ')) { headingLevel = 2; titleText = processedLine.substring(3).trim(); }
                    else if (processedLine.startsWith('### ')) { headingLevel = 3; titleText = processedLine.substring(4).trim(); }
                    else if (processedLine.startsWith('#### ')) { headingLevel = 4; titleText = processedLine.substring(5).trim(); }

                    if (headingLevel > 0) {
                        if (currentList) { containerElement.appendChild(currentList); currentList = null; }
                        const hTag = document.createElement(`h${headingLevel}`);
                        
                        hTag.innerHTML = applyBoldMarkdown(titleText); 
                        
                        if (headingLevel === 2) hTag.classList.add('text-2xl', 'font-bold', 'text-indigo-700', 'mb-4', 'pb-2', 'border-b', 'border-indigo-200');
                        else if (headingLevel === 3) hTag.classList.add('text-xl', 'font-semibold', 'text-indigo-600', 'mb-3', 'pb-1', 'border-b', 'border-indigo-100');
                        else if (headingLevel === 4) hTag.classList.add('text-lg', 'font-medium', 'text-indigo-500', 'mb-2');
                        
                        if (isFirstTitleInCard) { hTag.classList.add('mt-0'); isFirstTitleInCard = false; } 
                        else { hTag.classList.add('mt-6'); }
                        containerElement.appendChild(hTag);
                        isSectionHeader = true; 
                    }
                }

                if (isSectionHeader) return; 

                const listItemRegex = /^(\d+\.|\*|-)\s*(.*)/;
                const listItemMatch = processedLine.match(listItemRegex);
                if (listItemMatch) {
                    const listMarker = listItemMatch[1]; 
                    let listItemText = listItemMatch[2]; 
                    const isOrdered = listMarker.match(/^\d+\./); 

                    if (!currentList || (isOrdered && currentList.tagName !== 'OL') || (!isOrdered && currentList.tagName !== 'UL')) {
                        if (currentList) containerElement.appendChild(currentList); 
                        currentList = document.createElement(isOrdered ? 'ol' : 'ul'); 
                        currentList.classList.add('list-inside', 'space-y-1', 'mb-3', 'text-gray-700', 'pl-4'); 
                        if(isOrdered) currentList.classList.add('list-decimal'); else currentList.classList.add('list-disc');
                    }
                    const li = document.createElement('li');
                    li.innerHTML = applyBoldMarkdown(listItemText); 
                    currentList.appendChild(li);
                    return; 
                }
                
                if (currentList) { containerElement.appendChild(currentList); currentList = null; } 
                const p = document.createElement('p');
                p.innerHTML = applyBoldMarkdown(processedLine); 
                p.classList.add('text-gray-700', 'leading-relaxed', 'mb-3'); 
                containerElement.appendChild(p);
            });

            if (currentList) { containerElement.appendChild(currentList); } 
            
            if (UIElements[outputType + "ResultWrapper"]) { 
                UIElements[outputType + "ResultWrapper"].classList.remove('hidden');
            } else if (UIElements[outputType + "DisplayWrapper"]) { 
                 UIElements[outputType + "DisplayWrapper"].classList.remove('hidden');
            } else if ((outputType === "recipe" || outputType === "substitution") && UIElements.recipeOutputSection) { 
                 UIElements.recipeOutputSection.classList.remove('hidden');
            } else if (outputType === "nutrition" && UIElements.nutritionAnalysisResultDiv) {
                 UIElements.nutritionAnalysisResultDiv.classList.remove('hidden');
                 if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden'); 
            } else if (outputType === "shoppingList" && UIElements.shoppingListResultDiv) {
                 UIElements.shoppingListResultDiv.classList.remove('hidden');
                 if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden'); 
            }
            
            let scrollTarget = containerElement;
            if (UIElements.recipeOutputSection && UIElements.recipeOutputSection.contains(containerElement)) {
                scrollTarget = UIElements.recipeOutputSection;
            } else if (UIElements[outputType + "ResultWrapper"] && UIElements[outputType + "ResultWrapper"].contains(containerElement)) {
                scrollTarget = UIElements[outputType + "ResultWrapper"];
            } else if (UIElements[outputType + "DisplayWrapper"] && UIElements[outputType + "DisplayWrapper"].contains(containerElement)) {
                scrollTarget = UIElements[outputType + "DisplayWrapper"];
            }
            if (scrollTarget) {
                scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- ê¸°ì¡´ ê¸°ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        if (UIElements.generateRecipeButton) {
            UIElements.generateRecipeButton.addEventListener('click', async () => {
                const dietaryPreferencesVal = UIElements.dietaryPreferencesInput ? UIElements.dietaryPreferencesInput.value.trim() : 'íŠ¹ë³„í•œ ì œí•œ ì—†ìŒ';
                const cuisineStyleVal = UIElements.cuisineStyleInput ? UIElements.cuisineStyleInput.value.trim() : 'ëª¨ë“  ìŠ¤íƒ€ì¼ í™˜ì˜';

                if (dietaryPreferencesVal === 'íŠ¹ë³„í•œ ì œí•œ ì—†ìŒ' && cuisineStyleVal === 'ëª¨ë“  ìŠ¤íƒ€ì¼ í™˜ì˜') {
                     showError('ë ˆì‹œí”¼ë¥¼ ì¶”ì²œë°›ìœ¼ë ¤ë©´ ì‹ë‹¨ ì„ í˜¸ë„ ë˜ëŠ” ìš”ë¦¬ ìŠ¤íƒ€ì¼ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                     return;
                }
                
                const prompt = `
ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì…ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ë§ì¶¤í˜• ë ˆì‹œí”¼ë¥¼ ìƒì„±í•˜ëŠ” AI ìš”ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ì ì…ë ¥:
* ì‹ë‹¨ ì„ í˜¸ë„/ì œí•œì‚¬í•­: ${dietaryPreferencesVal}
* ì„ í˜¸ ìš”ë¦¬ ìŠ¤íƒ€ì¼: ${cuisineStyleVal}

ìš”ì²­:
ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì„ í˜¸ë„ì™€ ìŠ¤íƒ€ì¼ì— ë§ëŠ” ìš”ë¦¬ë¥¼ ì¶”ì²œí•˜ê³  í•´ë‹¹ ìš”ë¦¬ì— í•„ìš”í•œ ëª¨ë“  ì¬ë£Œ ëª©ë¡ì„ í¬í•¨í•˜ì—¬ ë ˆì‹œí”¼ 1ê°œë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.

**ìš”ë¦¬ ì´ë¦„:**
[AIê°€ ì œì•ˆí•˜ëŠ” ìš”ë¦¬ ì´ë¦„]

**ê°„ë‹¨ ì„¤ëª…:**
[ìš”ë¦¬ì— ëŒ€í•œ ë§¤ë ¥ì ì¸ 2-3ë¬¸ì¥ ì„¤ëª…]

**ë‚œì´ë„:**
[ì˜ˆ: ì´ˆê¸‰ / ì¤‘ê¸‰ / ê³ ê¸‰]

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:**
ì¤€ë¹„: [Xë¶„] | ì¡°ë¦¬: [Yë¶„]

**ë¶„ëŸ‰:**
[Zì¸ë¶„]

**í•„ìš”í•œ ì¬ë£Œ:**
* [ì¬ë£Œ 1] - [ì–‘] (ì˜ˆ: ì–‘íŒŒ - 1ê°œ)
* [ì¬ë£Œ 2] - [ì–‘] (ì˜ˆ: ë‹¤ì§„ ë§ˆëŠ˜ - 1í°ìˆ )
* ... (ëª¨ë“  í•„ìš” ì¬ë£Œ ëª…ì‹œ)

**ë§Œë“œëŠ” ë°©ë²•:**
1. [ì¡°ë¦¬ ë‹¨ê³„ 1 ìƒì„¸ ì„¤ëª…]
2. [ì¡°ë¦¬ ë‹¨ê³„ 2 ìƒì„¸ ì„¤ëª…]
3. ...

**ê¿€íŒ (ì„ íƒ ì‚¬í•­):**
* [ìš”ë¦¬ë¥¼ ë” ë§›ìˆê²Œ ë§Œë“¤ê±°ë‚˜ ë³€í˜•í•  ìˆ˜ ìˆëŠ” íŒ]

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ, ëª¨ë“  ì„¹ì…˜ì„ í¬í•¨í•˜ì—¬ ëª…í™•í•˜ê³  ë”°ë¼í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ì„¹ì…˜ ì œëª©ì€ **êµµì€ ê¸€ì”¨**ì™€ í•¨ê»˜ ì½œë¡ (:)ìœ¼ë¡œ ëë‚˜ë„ë¡ í•´ì£¼ì„¸ìš”. (ì˜ˆ: **ìš”ë¦¬ ì´ë¦„:**). ë¦¬ìŠ¤íŠ¸ í•­ëª© ë‚´ì—ì„œë„ **êµµì€ ê¸€ì”¨** ë§ˆí¬ë‹¤ìš´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                `;
                const recipeText = await callGeminiAPI(prompt);
                if (recipeText && UIElements.recipeDisplay) displayFormattedText(recipeText, UIElements.recipeDisplay, "AI ì¶”ì²œ ë ˆì‹œí”¼", "recipe");
            });
        }

        if (UIElements.recommendDishButton) {
            UIElements.recommendDishButton.addEventListener('click', async () => {
                const keywordsVal = UIElements.whatToEatKeywordsInput ? (UIElements.whatToEatKeywordsInput.value.trim() || "íŠ¹ë³„í•œ ì¡°ê±´ ì—†ìŒ") : "íŠ¹ë³„í•œ ì¡°ê±´ ì—†ìŒ";
                let recommendationPromptPart;
                if (keywordsVal === "íŠ¹ë³„í•œ ì¡°ê±´ ì—†ìŒ") {
                    recommendationPromptPart = `ì‚¬ìš©ìê°€ "ì˜¤ëŠ˜ ë­ ë¨¹ì§€?" ê³ ë¯¼ì„ í•˜ê³  ìˆì§€ë§Œ íŠ¹ë³„í•œ í‚¤ì›Œë“œëŠ” ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‚¬ìš©ìë¥¼ ìœ„í•´ ì°½ì˜ì ì´ê³  í¥ë¯¸ë¡œìš´ ìš”ë¦¬ 1ê°€ì§€ì™€ ê·¸ ìš”ë¦¬ë¥¼ ì¶”ì²œí•˜ëŠ” ê°„ë‹¨í•œ ì´ìœ ë¥¼ ììœ ë¡­ê²Œ ì œì•ˆí•´ì£¼ì„¸ìš”.`;
                } else {
                    recommendationPromptPart = `ì‚¬ìš©ìê°€ "ì˜¤ëŠ˜ ë­ ë¨¹ì§€?" ê³ ë¯¼ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í‚¤ì›Œë“œë¥¼ ì°¸ê³ í•˜ì—¬, ì°½ì˜ì ì´ê³  í¥ë¯¸ë¡œìš´ ìš”ë¦¬ 1ê°€ì§€ì™€ ê·¸ ìš”ë¦¬ë¥¼ ì¶”ì²œí•˜ëŠ” ê°„ë‹¨í•œ ì´ìœ ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.\n* ì‚¬ìš©ì í‚¤ì›Œë“œ: ${keywordsVal}`;
                }
                
                const prompt = `
${recommendationPromptPart}

ì‘ë‹µ í˜•ì‹:
**ì¶”ì²œ ìš”ë¦¬:** [ìš”ë¦¬ ì´ë¦„]
**ì¶”ì²œ ì´ìœ :** [2-3ë¬¸ì¥ìœ¼ë¡œ ëœ ë§¤ë ¥ì ì¸ ì¶”ì²œ ì´ìœ ]
ê·¸ë¦¬ê³  ë‹¤ìŒ ì¤„ì— ì •í™•íˆ "-> [ìš”ë¦¬ ì´ë¦„] ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°" í˜•ì‹ìœ¼ë¡œ í•´ë‹¹ ìš”ë¦¬ì˜ ë ˆì‹œí”¼ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” ë²„íŠ¼ ìë¦¬í‘œì‹œìë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ëŒ€ê´„í˜¸ ì•ˆì—ëŠ” ì¶”ì²œí•œ ìš”ë¦¬ ì´ë¦„ì„ ì •í™•íˆ ë„£ì–´ì£¼ì„¸ìš”. ì´ ë²„íŠ¼ ìë¦¬í‘œì‹œìëŠ” ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ ë‹¨ë… ë¼ì¸ìœ¼ë¡œ ì œê³µí•´ì£¼ì„¸ìš”.

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ì œëª©ì€ **êµµì€ ê¸€ì”¨**ì™€ í•¨ê»˜ ì½œë¡ (:)ìœ¼ë¡œ ëë‚˜ë„ë¡ í•´ì£¼ì„¸ìš”.
                `;
                const recommendationText = await callGeminiAPI(prompt, true);
                if (recommendationText && UIElements.recommendationDisplay) displayFormattedText(recommendationText, UIElements.recommendationDisplay, "ì˜¤ëŠ˜ì˜ ì¶”ì²œ", "recommendation");
            });
        }

        if (UIElements.searchSpecificDishButton) {
            UIElements.searchSpecificDishButton.addEventListener('click', async () => {
                const dishNameVal = UIElements.specificDishNameInput ? UIElements.specificDishNameInput.value.trim() : "";

                if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                if (UIElements.recipeDisplay) UIElements.recipeDisplay.innerHTML = '<p class="text-gray-500 italic text-center py-8">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                if (UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden');
                if (UIElements.nutritionAnalysisResultDiv) {
                    UIElements.nutritionAnalysisResultDiv.classList.add('hidden');
                    UIElements.nutritionAnalysisResultDiv.innerHTML = '';
                }
                if (UIElements.shoppingListResultDiv) {
                    UIElements.shoppingListResultDiv.classList.add('hidden');
                    UIElements.shoppingListResultDiv.innerHTML = '';
                }
                currentRecipeFullText = "";
                currentRecipeTitle = "";


                if (!dishNameVal) {
                    showError('ê²€ìƒ‰í•  ìš”ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden'); 
                    return;
                }
                
                const prompt = `
ì‚¬ìš©ìê°€ "${dishNameVal}" ìš”ë¦¬ì˜ ë ˆì‹œí”¼ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.
ì´ ìš”ë¦¬ì— ëŒ€í•œ ìƒì„¸í•œ ë ˆì‹œí”¼ë¥¼ ë‹¤ìŒ í˜•ì‹ì— ë§ì¶° ì œê³µí•´ì£¼ì„¸ìš”.

**ìš”ë¦¬ ì´ë¦„:**
${dishNameVal} (ë˜ëŠ” AIê°€ íŒë‹¨í•œ ì •í™•í•œ ìš”ë¦¬ ì´ë¦„)

**ê°„ë‹¨ ì„¤ëª…:**
[ìš”ë¦¬ì— ëŒ€í•œ ë§¤ë ¥ì ì¸ 2-3ë¬¸ì¥ ì„¤ëª…]

**ë‚œì´ë„:**
[ì˜ˆ: ì´ˆê¸‰ / ì¤‘ê¸‰ / ê³ ê¸‰]

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:**
ì¤€ë¹„: [Xë¶„] | ì¡°ë¦¬: [Yë¶„]

**ë¶„ëŸ‰:**
[Zì¸ë¶„]

**í•„ìš”í•œ ì¬ë£Œ:**
* [ì¬ë£Œ 1] - [ì–‘]
* [ì¬ë£Œ 2] - [ì–‘]
* ...

**ë§Œë“œëŠ” ë°©ë²•:**
1. [ì¡°ë¦¬ ë‹¨ê³„ 1 ìƒì„¸ ì„¤ëª…]
2. [ì¡°ë¦¬ ë‹¨ê³„ 2 ìƒì„¸ ì„¤ëª…]
3. ...

**ê¿€íŒ (ì„ íƒ ì‚¬í•­):**
* [ìš”ë¦¬ë¥¼ ë” ë§›ìˆê²Œ ë§Œë“¤ê±°ë‚˜ ë³€í˜•í•  ìˆ˜ ìˆëŠ” íŒ]

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ, ëª¨ë“  ì„¹ì…˜ì„ í¬í•¨í•˜ì—¬ ëª…í™•í•˜ê³  ë”°ë¼í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ì„¹ì…˜ ì œëª©ì€ **êµµì€ ê¸€ì”¨**ì™€ í•¨ê»˜ ì½œë¡ (:)ìœ¼ë¡œ ëë‚˜ë„ë¡ í•´ì£¼ì„¸ìš”. ë¦¬ìŠ¤íŠ¸ í•­ëª© ë‚´ì—ì„œë„ **êµµì€ ê¸€ì”¨** ë§ˆí¬ë‹¤ìš´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                `;
                const recipeText = await callGeminiAPI(prompt);

                if (recipeText && recipeText.trim() !== "" && UIElements.recipeDisplay) {
                    displayFormattedText(recipeText, UIElements.recipeDisplay, `"${dishNameVal}" ë ˆì‹œí”¼`, "recipe");
                } else if (recipeText === null) { 
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                } else { 
                    showError(`"${dishNameVal}"ì— ëŒ€í•œ ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`);
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                }
            });
        }
        
        if (UIElements.generateLeftoverRecipeButton) {
            UIElements.generateLeftoverRecipeButton.addEventListener('click', async () => {
                const ingredientsVal = UIElements.leftoverIngredientsInput ? UIElements.leftoverIngredientsInput.value.trim() : "";
                const cuisineStyleVal = UIElements.leftoverCuisineStyleInput ? UIElements.leftoverCuisineStyleInput.value.trim() : "ìƒê´€ ì—†ìŒ";

                if (!ingredientsVal) {
                    showError('ëƒ‰ì¥ê³  ì† ì¬ë£Œë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return;
                }
                
                const prompt = `
ë‹¹ì‹ ì€ ì‚¬ìš©ìê°€ ì œê³µí•œ 'ëƒ‰ì¥ê³  ì† ì¬ë£Œ'ë¥¼ ìµœëŒ€í•œ í™œìš©í•˜ì—¬ ë§›ìˆëŠ” ìš”ë¦¬ë¥¼ ë§Œë“œëŠ” AI ìš”ë¦¬ì‚¬ì…ë‹ˆë‹¤. ì¶”ê°€ ì¬ë£ŒëŠ” ìµœì†Œí™”í•˜ê±°ë‚˜, í•„ìš” ì—†ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
ì‚¬ìš©ì ì…ë ¥:
* ëƒ‰ì¥ê³  ì† ì¬ë£Œ: ${ingredientsVal}
* ì„ í˜¸ ìš”ë¦¬ ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­): ${cuisineStyleVal}

ìš”ì²­:
ìœ„ 'ëƒ‰ì¥ê³  ì† ì¬ë£Œ'ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í•˜ëŠ” ë ˆì‹œí”¼ 1ê°œë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”. ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¼ì£¼ì„¸ìš”.

**ìš”ë¦¬ ì´ë¦„:**
[AIê°€ ì œì•ˆí•˜ëŠ” ìš”ë¦¬ ì´ë¦„]

**ê°„ë‹¨ ì„¤ëª…:**
[ëƒ‰ì¥ê³  ì† ì¬ë£Œë¥¼ ì–´ë–»ê²Œ í™œìš©í–ˆëŠ”ì§€ ê°•ì¡°í•˜ëŠ” 2-3ë¬¸ì¥ ì„¤ëª…]

**ë‚œì´ë„:**
[ì˜ˆ: ì´ˆê¸‰ / ì¤‘ê¸‰ / ê³ ê¸‰]

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:**
ì¤€ë¹„: [Xë¶„] | ì¡°ë¦¬: [Yë¶„]

**ë¶„ëŸ‰:**
[Zì¸ë¶„]

**í•„ìš”í•œ ì¬ë£Œ:**
(ì£¼ë¡œ 'ëƒ‰ì¥ê³  ì† ì¬ë£Œ'ë¥¼ ì‚¬ìš©í•˜ë©°, ë§Œì•½ ì•„ì£¼ ì•½ê°„ì˜ ì¶”ê°€ ì–‘ë…/ì¬ë£Œê°€ í•„ìš”í•˜ë‹¤ë©´ ëª…ì‹œ)
* [ì¬ë£Œ 1] - [ì–‘]
* ...

**ë§Œë“œëŠ” ë°©ë²•:**
1. [ì¡°ë¦¬ ë‹¨ê³„ 1 ìƒì„¸ ì„¤ëª…]
2. [ì¡°ë¦¬ ë‹¨ê³„ 2 ìƒì„¸ ì„¤ëª…]
3. ...

**í™œìš© íŒ (ì„ íƒ ì‚¬í•­):**
* [ë‚¨ì€ ì¬ë£Œë¥¼ ë‹¤ë¥´ê²Œ í™œìš©í•˜ê±°ë‚˜, ìš”ë¦¬ë¥¼ ë” ë§›ìˆê²Œ í•˜ëŠ” íŒ]

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ, ëª¨ë“  ì„¹ì…˜ì„ í¬í•¨í•˜ì—¬ ëª…í™•í•˜ê³  ë”°ë¼í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ì„¹ì…˜ ì œëª©ì€ **êµµì€ ê¸€ì”¨**ì™€ í•¨ê»˜ ì½œë¡ (:)ìœ¼ë¡œ ëë‚˜ë„ë¡ í•´ì£¼ì„¸ìš”. ë¦¬ìŠ¤íŠ¸ í•­ëª© ë‚´ì—ì„œë„ **êµµì€ ê¸€ì”¨** ë§ˆí¬ë‹¤ìš´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                `;
                const recipeText = await callGeminiAPI(prompt);
                if (recipeText && UIElements.recipeDisplay) displayFormattedText(recipeText, UIElements.recipeDisplay, "ëƒ‰ì¥ê³  íŒŒë¨¹ê¸° ë ˆì‹œí”¼", "recipe");
            });
        }

        if (UIElements.generateMealPlanButton) {
            UIElements.generateMealPlanButton.addEventListener('click', async () => {
                const preferences = UIElements.mealPlanPreferencesInput ? UIElements.mealPlanPreferencesInput.value.trim() : "ê· í˜• ì¡íŒ ì¼ë°˜ì ì¸ ì‹ë‹¨";
                const prompt = `
ì‚¬ìš©ìì˜ ë‹¤ìŒ ìš”ì²­ì— ë”°ë¼ 7ì¼ì¹˜ ì €ë… ì‹ë‹¨ ì•„ì´ë””ì–´ë¥¼ ìš”ì¼ë³„(ì›”ìš”ì¼ë¶€í„° ì¼ìš”ì¼ê¹Œì§€)ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”.
ê° ì•„ì´ë””ì–´ëŠ” **"ìš”ì¼: ìš”ë¦¬ ì´ë¦„ - ê°„ë‹¨í•œ ì„¤ëª… (1~2ì¤„)"** í˜•ì‹ìœ¼ë¡œ í•œ ì¤„ì— í•˜ë‚˜ì”© ì‘ì„±í•´ì£¼ì„¸ìš”.
ì˜ˆì‹œ:
ì›”ìš”ì¼: ë‹­ê°ˆë¹„ - ë§¤ì½¤í•œ ì–‘ë…ì— ë³¶ì•„ ì˜¨ ê°€ì¡±ì´ ì¦ê¸°ê¸° ì¢‹ì€ ë©”ë‰´
í™”ìš”ì¼: ëœì¥ì°Œê°œ - êµ¬ìˆ˜í•˜ê³  ë“ ë“ í•œ í•œêµ­ì¸ì˜ ì†Œìš¸í‘¸ë“œ

ì‚¬ìš©ì ìš”ì²­: "${preferences}"
`;
                const mealPlanText = await callGeminiAPI(prompt, true);
                if (mealPlanText && UIElements.mealPlanDisplay) {
                    displayFormattedText(mealPlanText, UIElements.mealPlanDisplay, "AI ì¶”ì²œ ì£¼ê°„ ì‹ë‹¨", "mealPlan");
                }
            });
        }
        
        if (UIElements.generateThemedRecipesButton) {
            UIElements.generateThemedRecipesButton.addEventListener('click', async () => {
                const theme = UIElements.themeKeywordsInput ? UIElements.themeKeywordsInput.value.trim() : "";
                if (!theme) {
                    showError('ì›í•˜ëŠ” í…Œë§ˆë‚˜ ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ìƒì¼ íŒŒí‹°, ìº í•‘ ìš”ë¦¬)');
                    return;
                }
                const prompt = `
ì‚¬ìš©ìê°€ ë‹¤ìŒ í…Œë§ˆ ë˜ëŠ” ìƒí™©ì— ë§ëŠ” ìš”ë¦¬ ì•„ì´ë””ì–´ 2~3ê°€ì§€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤: "${theme}"
ê° ìš”ë¦¬ ì•„ì´ë””ì–´ì— ëŒ€í•´ **"ë²ˆí˜¸. ìš”ë¦¬ ì´ë¦„: ê°„ë‹¨í•œ ì„¤ëª… (1~2ì¤„)"** í˜•ì‹ìœ¼ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”.
ê° ìš”ë¦¬ ì´ë¦„ ë’¤ì—ëŠ” í•´ë‹¹ ë ˆì‹œí”¼ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆë„ë¡ "-> [ìš”ë¦¬ ì´ë¦„] ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°" í˜•ì‹ì˜ ë²„íŠ¼ ìë¦¬í‘œì‹œìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.

ì˜ˆì‹œ:
í…Œë§ˆ: "ë¹„ ì˜¤ëŠ” ë‚ "
1. ê¹€ì¹˜ì „: ë°”ì‚­í•˜ê³  ë§¤ì½¤í•œ ë§›ì´ ì¼í’ˆì¸ í•œêµ­ì˜ ëŒ€í‘œì ì¸ ë¹„ ì˜¤ëŠ” ë‚  ìŒì‹ì…ë‹ˆë‹¤. -> [ê¹€ì¹˜ì „] ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°
2. í•´ë¬¼ ì¹¼êµ­ìˆ˜: ë”°ëˆí•˜ê³  ì‹œì›í•œ êµ­ë¬¼ì— í•´ë¬¼ì´ ë“¬ë¿ ë“¤ì–´ê°„ ì¹¼êµ­ìˆ˜ì…ë‹ˆë‹¤. -> [í•´ë¬¼ ì¹¼êµ­ìˆ˜] ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
`;
                const themedRecipesText = await callGeminiAPI(prompt, true);
                if (themedRecipesText && UIElements.themedRecipesDisplay) {
                    displayFormattedText(themedRecipesText, UIElements.themedRecipesDisplay, `"${theme}" í…Œë§ˆ ìš”ë¦¬ ì¶”ì²œ`, "themedRecipes");
                }
            });
        }

        if (UIElements.confirmSubstituteButton) {
            UIElements.confirmSubstituteButton.addEventListener('click', async () => {
                const ingredientToSub = UIElements.ingredientToSubstituteInput ? UIElements.ingredientToSubstituteInput.value.trim() : "";
                const reasonForSub = UIElements.substitutionReasonInput ? UIElements.substitutionReasonInput.value.trim() : "";

                if (!ingredientToSub) {
                    showError("ëŒ€ì²´í•˜ê³  ì‹¶ì€ ì¬ë£Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
                    return;
                }
                if (!currentRecipeFullText) {
                    showError("ë¨¼ì € ë ˆì‹œí”¼ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.");
                    hideSubstituteModal();
                    return;
                }

                hideSubstituteModal(); 
                
                let reasonText = "";
                if (reasonForSub) {
                    reasonText = `ëŒ€ì²´í•˜ë ¤ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: "${reasonForSub}". `;
                }

                const prompt = `
í˜„ì¬ ì‚¬ìš©ìëŠ” ë‹¤ìŒ ë ˆì‹œí”¼ë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤:
--- ë ˆì‹œí”¼ ì‹œì‘ ---
${currentRecipeFullText}
--- ë ˆì‹œí”¼ ë ---

ì´ ë ˆì‹œí”¼ì—ì„œ "${ingredientToSub}" ì¬ë£Œë¥¼ ëŒ€ì²´í•  ë§Œí•œ ë‹¤ë¥¸ ì¬ë£Œ 2~3ê°€ì§€ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”. ${reasonText}ê° ëŒ€ì²´ ì¬ë£Œì— ëŒ€í•´, ì‚¬ìš©ëŸ‰ì€ ì–´ë–»ê²Œ ì¡°ì ˆí•´ì•¼ í•˜ëŠ”ì§€, ê·¸ë¦¬ê³  ëŒ€ì²´ ì‹œ íŠ¹ë³„íˆ ì£¼ì˜í•  ì ì´ë‚˜ ë§›ì˜ ë³€í™”ê°€ ìˆë‹¤ë©´ í•¨ê»˜ ì„¤ëª…í•´ì£¼ì„¸ìš”. ê²°ê³¼ëŠ” ëª…í™•í•˜ê³  ê°„ê²°í•˜ê²Œ ëª©ë¡ í˜•íƒœë¡œ ì œê³µí•´ì£¼ì„¸ìš”.

ì˜ˆì‹œ:
**"${ingredientToSub}" ëŒ€ì²´ ì¬ë£Œ ì¶”ì²œ:**
* **[ëŒ€ì²´ ì¬ë£Œ 1]:** [ì„¤ëª…, ì–‘ ì¡°ì ˆ íŒ, ì£¼ì˜ì‚¬í•­ ë“±]
* **[ëŒ€ì²´ ì¬ë£Œ 2]:** [ì„¤ëª…, ì–‘ ì¡°ì ˆ íŒ, ì£¼ì˜ì‚¬í•­ ë“±]
`;
                const substitutionText = await callGeminiAPI(prompt, true);
                if (substitutionText && UIElements.recipeDisplay) {
                    displayFormattedText(substitutionText, UIElements.recipeDisplay, `"${ingredientToSub}" ì¬ë£Œ ëŒ€ì²´ ì¶”ì²œ`, "substitution");
                }
            });
        }

        if (UIElements.analyzeNutritionButton) {
            UIElements.analyzeNutritionButton.addEventListener('click', async () => {
                if (!currentRecipeFullText) {
                    showError("ë¨¼ì € ë ˆì‹œí”¼ë¥¼ ì¡°íšŒí•˜ì—¬ ì˜ì–‘ ì •ë³´ë¥¼ ë¶„ì„í•  ë‚´ìš©ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.");
                    return;
                }
                 if (!UIElements.nutritionAnalysisResultDiv) { 
                    console.error("Error: nutritionAnalysisResultDiv is not a valid HTMLElement or is null/undefined.");
                    showError("ì˜ì–‘ ì •ë³´ë¥¼ í‘œì‹œí•  ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì•± ë‚´ë¶€ ì˜¤ë¥˜)");
                    return;
                }
                const prompt = `
ë‹¤ìŒ ë ˆì‹œí”¼ì˜ ì£¼ìš” ì˜ì–‘ ì •ë³´ë¥¼ 1ì¸ë¶„ ê¸°ì¤€ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”. (ë§Œì•½ ë ˆì‹œí”¼ì— ë¶„ëŸ‰ ì •ë³´ê°€ ìˆë‹¤ë©´ ê·¸ê²ƒì„ ì°¸ê³ í•˜ê³ , ì—†ë‹¤ë©´ ì¼ë°˜ì ì¸ 1ì¸ë¶„ ê¸°ì¤€ìœ¼ë¡œ ê°€ì •í•´ì£¼ì„¸ìš”.)
ì˜ˆìƒë˜ëŠ” ì´ ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼(g), ë‹¨ë°±ì§ˆ(g), ì§€ë°©(g) í•¨ëŸ‰ì„ ì•Œë ¤ì£¼ê³ , ê°€ëŠ¥í•˜ë‹¤ë©´ ë‚˜íŠ¸ë¥¨(mg) ì •ë³´ë„ ê°„ëµíˆ í¬í•¨í•´ì£¼ì„¸ìš”.
ê²°ê³¼ëŠ” ëª…í™•í•œ ëª©ë¡ í˜•íƒœë¡œ, ê° í•­ëª©ê³¼ ìˆ˜ì¹˜ë¥¼ í•¨ê»˜ ë³´ì—¬ì£¼ì„¸ìš”. (ì˜ˆ: **ì´ ì¹¼ë¡œë¦¬:** ì•½ XXX kcal). ê° ì˜ì–‘ì†Œ ë’¤ì—ëŠ” ë‹¨ìœ„ë¥¼ ëª…ì‹œí•´ì£¼ì„¸ìš”.

--- ë ˆì‹œí”¼ ë‚´ìš© ---
${currentRecipeFullText}
--- ë ˆì‹œí”¼ ë‚´ìš© ë ---
`;
                const nutritionText = await callGeminiAPI(prompt, true);
                if (nutritionText) {
                    UIElements.nutritionAnalysisResultDiv.innerHTML = ''; 
                    displayFormattedText(nutritionText, UIElements.nutritionAnalysisResultDiv, "ì˜ì–‘ ì •ë³´ ë¶„ì„ ê²°ê³¼ (1ì¸ë¶„ ê¸°ì¤€)", "nutrition"); 
                }
            });
        }

        if (UIElements.generateShoppingListButton) {
            UIElements.generateShoppingListButton.addEventListener('click', () => {
                if (!currentRecipeFullText) {
                    showError("ë¨¼ì € ë ˆì‹œí”¼ë¥¼ ì¡°íšŒí•˜ì—¬ ì¥ë³´ê¸° ëª©ë¡ì„ ìƒì„±í•  ë‚´ìš©ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (!UIElements.shoppingListResultDiv) { 
                    console.error("Error: shoppingListResultDiv is not a valid HTMLElement or is null/undefined.");
                    showError("ì¥ë³´ê¸° ëª©ë¡ì„ í‘œì‹œí•  ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì•± ë‚´ë¶€ ì˜¤ë¥˜)");
                    return;
                }

                const ingredientsSectionRegex = /\*\*í•„ìš”í•œ ì¬ë£Œ:\*\*\s*([\s\S]*?)(?=\n\*\*|$)/i;
                const match = currentRecipeFullText.match(ingredientsSectionRegex);

                if (match && match[1]) {
                    const ingredientsText = match[1].trim();
                    const ingredientsArray = ingredientsText.split('\n').map(item => item.replace(/^\s*\*\s*/, '').trim()).filter(item => item); 
                    
                    if (ingredientsArray.length > 0) {
                        UIElements.shoppingListResultDiv.innerHTML = `
                            <h3 class="text-lg font-semibold text-indigo-600 mb-3">ğŸ›’ ì¥ë³´ê¸° ëª©ë¡</h3>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                ${ingredientsArray.map(item => `<li>${applyBoldMarkdown(item)}</li>`).join('')}
                            </ul>
                            <button id="copyShoppingListButton" class="action-button mt-4 text-sm">
                                <i class="fas fa-copy mr-2"></i> ëª©ë¡ ë³µì‚¬í•˜ê¸°
                            </button>
                        `;
                        UIElements.shoppingListResultDiv.classList.remove('hidden');
                        if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden');


                        const copyButton = document.getElementById('copyShoppingListButton');
                        if(copyButton && UIElements.clipboardHelper) { 
                            copyButton.addEventListener('click', () => {
                                const listToCopy = ingredientsArray.join('\n');
                                UIElements.clipboardHelper.value = listToCopy;
                                UIElements.clipboardHelper.select();
                                try {
                                    document.execCommand('copy');
                                    showError('ì¥ë³´ê¸° ëª©ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); 
                                } catch (err) {
                                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                                    showError('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                                }
                                if (window.getSelection) {
                                    window.getSelection().removeAllRanges();
                                } else if (document.selection) {
                                    document.selection.empty();
                                }
                            });
                        } else if (!UIElements.clipboardHelper) {
                             console.warn("clipboardHelper ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ë³µì‚¬ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤.");
                        }

                    } else {
                        UIElements.shoppingListResultDiv.innerHTML = '<p class="text-gray-500 italic">ë ˆì‹œí”¼ì—ì„œ ì¬ë£Œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                        UIElements.shoppingListResultDiv.classList.remove('hidden');
                        if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden');
                    }
                } else {
                    UIElements.shoppingListResultDiv.innerHTML = '<p class="text-gray-500 italic">"í•„ìš”í•œ ì¬ë£Œ" ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    UIElements.shoppingListResultDiv.classList.remove('hidden');
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden');
                }
            });
        }

        // --- ìƒˆë¡œìš´ ê¸°ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        if (UIElements.getBeveragePairingButton) {
            UIElements.getBeveragePairingButton.addEventListener('click', async () => {
                const dishName = UIElements.beverageDishNameInput ? UIElements.beverageDishNameInput.value.trim() : "";
                if (!dishName) {
                    showError("ìŒë£Œë¥¼ ì¶”ì²œë°›ì„ ìš”ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (UIElements.beveragePairingResultWrapper) UIElements.beveragePairingResultWrapper.classList.add('hidden');
                const prompt = `"${dishName}" ìš”ë¦¬ì™€ ì˜ ì–´ìš¸ë¦¬ëŠ” ìŒë£Œ(ì™€ì¸, ë§¥ì£¼, ì „í†µì£¼, ë…¼ì•Œì½œ ìŒë£Œ ë“±)ë¥¼ 3ê°€ì§€ ì¶”ì²œí•´ì£¼ê³ , ê° ìŒë£Œì— ëŒ€í•œ ê°„ë‹¨í•œ í˜ì–´ë§ ì´ìœ ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”. ê²°ê³¼ëŠ” ëª©ë¡ í˜•íƒœë¡œ ì œê³µí•´ì£¼ì„¸ìš”. ê° ì¶”ì²œ í•­ëª©ì€ **ìŒë£Œ ì´ë¦„:** ìœ¼ë¡œ ì‹œì‘í•˜ê³ , ì„¤ëª…ì€ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.`;
                const resultText = await callGeminiAPI(prompt, true);
                if (resultText && UIElements.beveragePairingResult) {
                    displayFormattedText(resultText, UIElements.beveragePairingResult, `"${dishName}" ìŒë£Œ í˜ì–´ë§ ì¶”ì²œ`, "beveragePairing");
                }
            });
        }

        if (UIElements.searchCookingTermButton) {
            UIElements.searchCookingTermButton.addEventListener('click', async () => {
                const term = UIElements.cookingTermInput ? UIElements.cookingTermInput.value.trim() : "";
                if (!term) {
                    showError("ê²€ìƒ‰í•  ìš”ë¦¬ ìš©ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (UIElements.cookingTermResultWrapper) UIElements.cookingTermResultWrapper.classList.add('hidden');
                const prompt = `ìš”ë¦¬ ìš©ì–´ "${term}"ì— ëŒ€í•œ ì‰½ê³  ìì„¸í•œ ì„¤ëª…ì„ í•´ì£¼ì„¸ìš”. í•„ìš”í•œ ê²½ìš° ì˜ˆì‹œë„ í•¨ê»˜ ë“¤ì–´ì£¼ì„¸ìš”.`;
                const resultText = await callGeminiAPI(prompt, true);
                if (resultText && UIElements.cookingTermResult) {
                    displayFormattedText(resultText, UIElements.cookingTermResult, `"${term}" ìš©ì–´ ì„¤ëª…`, "cookingTerm");
                }
            });
        }

        if (UIElements.convertUnitButton) {
            UIElements.convertUnitButton.addEventListener('click', async () => {
                const value = UIElements.unitValueInput ? UIElements.unitValueInput.value.trim() : "";
                const fromUnit = UIElements.fromUnitInput ? UIElements.fromUnitInput.value.trim() : "";
                const toUnit = UIElements.toUnitInput ? UIElements.toUnitInput.value.trim() : "";

                if (!value || !fromUnit || !toUnit) {
                    showError("ë³€í™˜í•  ê°’, í˜„ì¬ ë‹¨ìœ„, ë³€í™˜í•  ë‹¨ìœ„ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (UIElements.unitConversionResultWrapper) UIElements.unitConversionResultWrapper.classList.add('hidden');
                const prompt = `ìš”ë¦¬ ê³„ëŸ‰ ë‹¨ìœ„ ë³€í™˜ ìš”ì²­ì…ë‹ˆë‹¤. ${value} ${fromUnit}ì€(ëŠ”) ëª‡ ${toUnit}ì¸ê°€ìš”? ìˆ«ìì™€ ë‹¨ìœ„ë§Œ ê°„ê²°í•˜ê²Œ ì•Œë ¤ì£¼ì„¸ìš”. (ì˜ˆ: 15 ml)`;
                const resultText = await callGeminiAPI(prompt, true);
                if (resultText && UIElements.unitConversionResult) {
                    displayFormattedText(resultText, UIElements.unitConversionResult, `ë‹¨ìœ„ ë³€í™˜ ê²°ê³¼: ${value} ${fromUnit} â†’ ${toUnit}`, "unitConversion");
                }
            });
        }
        
        if (UIElements.getSeasonalRecipesButton) {
            UIElements.getSeasonalRecipesButton.addEventListener('click', async () => {
                const season = UIElements.seasonInput ? UIElements.seasonInput.value.trim() : "";
                if (!season) {
                    showError("ì›” ë˜ëŠ” ê³„ì ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 7ì›”, ì—¬ë¦„).");
                    return;
                }
                if (UIElements.seasonalRecipeResultWrapper) UIElements.seasonalRecipeResultWrapper.classList.add('hidden');
                const prompt = `"${season}"ì— ì¦ê¸°ê¸° ì¢‹ì€ ì œì²  ì¬ë£Œë¥¼ í™œìš©í•œ íŠ¹ë³„í•œ ë ˆì‹œí”¼ 2~3ê°€ì§€ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”. ê° ë ˆì‹œí”¼ëŠ” ì´ë¦„ê³¼ ê°„ë‹¨í•œ ì„¤ëª…, ê·¸ë¦¬ê³  í•´ë‹¹ ë ˆì‹œí”¼ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆëŠ” ë²„íŠ¼ ìë¦¬í‘œì‹œì ("-> [ìš”ë¦¬ ì´ë¦„] ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°")ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤. ê° ì¶”ì²œì€ "ë²ˆí˜¸. **ìš”ë¦¬ ì´ë¦„:** ì„¤ëª…" í˜•ì‹ìœ¼ë¡œ ì‹œì‘í•´ì£¼ì„¸ìš”.`;
                const resultText = await callGeminiAPI(prompt, true);
                if (resultText && UIElements.seasonalRecipeResult) {
                    displayFormattedText(resultText, UIElements.seasonalRecipeResult, `"${season}" ì œì²  ìš”ë¦¬ ì¶”ì²œ`, "seasonalRecipe");
                }
            });
        }

        // "ë‚´ ë ˆì‹œí”¼ë¶ì— ì €ì¥" ë²„íŠ¼ ê¸°ëŠ¥
        if (UIElements.saveToRecipeBookButton) {
            UIElements.saveToRecipeBookButton.addEventListener('click', () => {
                if (!currentRecipeFullText || !currentRecipeTitle) {
                    showError("ì €ì¥í•  ë ˆì‹œí”¼ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë ˆì‹œí”¼ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                saveRecipeToBook(currentRecipeTitle, currentRecipeFullText);
            });
        }

        // --- ë‚´ ë ˆì‹œí”¼ë¶ (localStorage) ê´€ë ¨ í•¨ìˆ˜ ---
        function getSavedRecipes() {
            const recipes = localStorage.getItem('myRecipeBook');
            return recipes ? JSON.parse(recipes) : [];
        }

        function saveRecipeToBook(title, fullText) {
            if (!title || !fullText) {
                showError("ë ˆì‹œí”¼ ì œëª© ë˜ëŠ” ë‚´ìš©ì´ ì—†ì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            const recipes = getSavedRecipes();
            const newRecipe = {
                id: Date.now(), // ê°„ë‹¨í•œ ID ìƒì„±
                title: title,
                fullText: fullText
            };
            // ì¤‘ë³µ ì €ì¥ ë°©ì§€ (ì œëª© ê¸°ì¤€)
            if (recipes.some(recipe => recipe.title === newRecipe.title)) {
                showError(`"${newRecipe.title}" ë ˆì‹œí”¼ëŠ” ì´ë¯¸ ë ˆì‹œí”¼ë¶ì— ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
                return;
            }
            recipes.push(newRecipe);
            localStorage.setItem('myRecipeBook', JSON.stringify(recipes));
            showError(`"${title}" ë ˆì‹œí”¼ê°€ ë‚´ ë ˆì‹œí”¼ë¶ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            // ë ˆì‹œí”¼ë¶ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            const activeTabButton = document.querySelector('.tab-button.active');
            if (activeTabButton && activeTabButton.dataset.tab === 'tab11') {
                loadAndDisplaySavedRecipes();
            }
        }
        
        function loadAndDisplaySavedRecipes() {
            if (!UIElements.savedRecipesListDiv) return;
            const recipes = getSavedRecipes();
            UIElements.savedRecipesListDiv.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

            if (recipes.length === 0) {
                UIElements.savedRecipesListDiv.innerHTML = '<p class="text-gray-500 italic text-center">ì•„ì§ ì €ì¥ëœ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            recipes.forEach(recipe => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('saved-recipe-item', 'flex', 'justify-between', 'items-center');
                
                const titleSpan = document.createElement('span');
                titleSpan.classList.add('font-semibold', 'text-lg', 'text-indigo-700', 'cursor-pointer', 'hover:underline');
                titleSpan.textContent = recipe.title; // ì €ì¥ëœ ìˆœìˆ˜ ì œëª© í‘œì‹œ
                titleSpan.onclick = () => { // ì œëª© í´ë¦­ ì‹œ ë ˆì‹œí”¼ ë³´ê¸°
                     if (UIElements.recipeDisplay && UIElements.recipeOutputSection && UIElements.recipeOutputTitle) {
                        currentRecipeFullText = recipe.fullText; 
                        currentRecipeTitle = recipe.title; 
                        displayFormattedText(recipe.fullText, UIElements.recipeDisplay, `"${recipe.title}" ë ˆì‹œí”¼ (ë³´ê´€í•¨)`, "recipe");
                        UIElements.recipeOutputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
                itemDiv.appendChild(titleSpan);

                const buttonGroup = document.createElement('div');
                buttonGroup.classList.add('button-group');

                const viewButton = document.createElement('button');
                viewButton.innerHTML = '<i class="fas fa-eye mr-1"></i> ë³´ê¸°';
                viewButton.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'py-1', 'px-2', 'rounded', 'text-xs');
                viewButton.onclick = () => {
                    if (UIElements.recipeDisplay && UIElements.recipeOutputSection && UIElements.recipeOutputTitle) {
                        currentRecipeFullText = recipe.fullText; 
                        currentRecipeTitle = recipe.title; 
                        displayFormattedText(recipe.fullText, UIElements.recipeDisplay, `"${recipe.title}" ë ˆì‹œí”¼ (ë³´ê´€í•¨)`, "recipe");
                         UIElements.recipeOutputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };
                buttonGroup.appendChild(viewButton);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> ì‚­ì œ';
                deleteButton.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'py-1', 'px-2', 'rounded', 'text-xs', 'ml-2');
                deleteButton.onclick = (event) => { // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                    event.stopPropagation(); 
                    deleteRecipeFromBook(recipe.id);
                };
                buttonGroup.appendChild(deleteButton);
                itemDiv.appendChild(buttonGroup);
                UIElements.savedRecipesListDiv.appendChild(itemDiv);
            });
        }

        function deleteRecipeFromBook(recipeId) {
            let recipes = getSavedRecipes();
            const recipeToDelete = recipes.find(r => r.id === recipeId);
            if (recipeToDelete) {
                // ì‚¬ìš©ìì—ê²Œ ì •ë§ ì‚­ì œí•  ê²ƒì¸ì§€ í•œ ë²ˆ ë” í™•ì¸í•˜ëŠ” ë¡œì§ (ê°„ë‹¨í•œ alert ì‚¬ìš©, ì‹¤ì œ ì•±ì—ì„œëŠ” ì»¤ìŠ¤í…€ ëª¨ë‹¬ ê¶Œì¥)
                // if (confirm(`"${recipeToDelete.title}" ë ˆì‹œí”¼ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    recipes = recipes.filter(recipe => recipe.id !== recipeId);
                    localStorage.setItem('myRecipeBook', JSON.stringify(recipes));
                    loadAndDisplaySavedRecipes(); 
                    showError(`"${recipeToDelete.title}" ë ˆì‹œí”¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

                    if (UIElements.recipeOutputTitle && UIElements.recipeOutputTitle.textContent.includes(recipeToDelete.title) && UIElements.recipeDisplay) {
                        UIElements.recipeDisplay.innerHTML = '<p class="text-gray-500 italic text-center py-8">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                        if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden');
                        currentRecipeFullText = "";
                        currentRecipeTitle = "";
                    }
                // }
            } else {
                showError("ì‚­ì œí•  ë ˆì‹œí”¼ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        // ì´ˆê¸° ë¡œë“œ ì‹œ "ì˜¤ëŠ˜ì˜ ì¶”ì²œ" íƒ­ í™œì„±í™”
        const defaultInitialTabId = 'tab2';
        // ì´ì „ì— ì„ ì–¸ëœ initialActiveTabButton ë³€ìˆ˜ë¥¼ ì¬ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ let ë˜ëŠ” constë¥¼ ë‹¤ì‹œ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        let initialActiveTabButtonForLoad = document.querySelector(`.tab-button[data-tab="${defaultInitialTabId}"]`);
        let initialActiveTabContentForLoad = document.getElementById(defaultInitialTabId);

        // ëª¨ë“  íƒ­ì—ì„œ 'active' í´ë˜ìŠ¤ ë¨¼ì € ì œê±°
        if (UIElements.tabButtons) {
            UIElements.tabButtons.forEach(btn => btn.classList.remove('active'));
        }
        if (UIElements.tabContents) {
            UIElements.tabContents.forEach(content => content.classList.remove('active'));
        }

        if (initialActiveTabButtonForLoad && initialActiveTabContentForLoad) {
            initialActiveTabButtonForLoad.classList.add('active');
            initialActiveTabContentForLoad.classList.add('active');
        } else if (UIElements.tabButtons && UIElements.tabButtons.length > 0) { // Fallback: ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”
            UIElements.tabButtons[0].classList.add('active');
            const fallbackTabId = UIElements.tabButtons[0].dataset.tab;
            const fallbackContent = document.getElementById(fallbackTabId);
            if (fallbackContent) {
                fallbackContent.classList.add('active');
                initialActiveTabButtonForLoad = UIElements.tabButtons[0]; 
            }
        }
        
        // ì´ˆê¸° í™œì„±í™”ëœ íƒ­ì— ë”°ë¥¸ ë°ì´í„° ë¡œë“œ (initialActiveTabButtonForLoad ë³€ìˆ˜ ì‚¬ìš©)
        if (initialActiveTabButtonForLoad) { 
            const activeTab = initialActiveTabButtonForLoad.dataset.tab;
            if (activeTab === 'tab11') loadAndDisplaySavedRecipes();
            if (activeTab === 'tab12') loadDailyCalorieLog();
            if (activeTab === 'tab14') loadDailyExerciseLog();
            if (activeTab === 'tab15') loadAndUpdateWaterIntakeProgress();
        }


        // --- í—¬ìŠ¤ í”Œë˜ë„ˆ ê¸°ëŠ¥ë“¤ ---
        if(UIElements.analyzeAndLogCalorieButton) {
            UIElements.analyzeAndLogCalorieButton.addEventListener('click', async () => {
                const foodName = UIElements.calorieFoodNameInput.value.trim();
                const mealType = UIElements.calorieMealTypeSelect.value;
                if (!foodName) {
                    showError("ì¹¼ë¡œë¦¬ë¥¼ ë¶„ì„í•˜ê³  ê¸°ë¡í•  ìŒì‹/ì¬ë£Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (UIElements.calorieTrackerResultWrapper) UIElements.calorieTrackerResultWrapper.classList.add('hidden');

                const prompt = `ìŒì‹ "${foodName}"ì˜ ì˜ˆìƒ ì¹¼ë¡œë¦¬ì™€ ì£¼ìš” ì˜ì–‘ ì„±ë¶„(íƒ„ìˆ˜í™”ë¬¼, ë‹¨ë°±ì§ˆ, ì§€ë°©)ì„ ì•Œë ¤ì£¼ì„¸ìš”. ê²°ê³¼ëŠ” ëª…í™•í•œ ëª©ë¡ í˜•íƒœë¡œ ì œê³µí•´ì£¼ì„¸ìš”. (ì˜ˆ: **ì´ ì¹¼ë¡œë¦¬:** ì•½ XXX kcal)`;
                const analysisResult = await callGeminiAPI(prompt, true);

                if (analysisResult && UIElements.calorieTrackerResult) {
                    displayFormattedText(analysisResult, UIElements.calorieTrackerResult, `"${foodName}" ë¶„ì„ ê²°ê³¼`, "calorieTracker");
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ê¸°ë¡ (ê°„ë‹¨í™”ëœ ë²„ì „)
                    const calorieMatch = analysisResult.match(/ì´ ì¹¼ë¡œë¦¬:\s*ì•½\s*(\d+)\s*kcal/i);
                    const calories = calorieMatch ? parseInt(calorieMatch[1], 10) : 0;
                    saveCalorieLog({ foodName, mealType, calories, details: analysisResult });
                    loadDailyCalorieLog();
                }
            });
        }
        
        if(UIElements.generateDietPlanButton) {
            UIElements.generateDietPlanButton.addEventListener('click', async () => {
                const goal = UIElements.dietGoalSelect.value;
                const level = UIElements.activityLevelSelect.value;
                const duration = UIElements.dietDurationInput.value.trim();
                const preferences = UIElements.dietPreferencesPlannerInput.value.trim() || "íŠ¹ë³„í•œ ì œí•œ ì—†ìŒ";

                if (!duration || isNaN(parseInt(duration)) || parseInt(duration) <=0) {
                    showError("ì˜¬ë°”ë¥¸ ëª©í‘œ ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ìˆ«ì, 1 ì´ìƒ).");
                    return;
                }
                if (UIElements.dietPlannerResultWrapper) UIElements.dietPlannerResultWrapper.classList.add('hidden');
                const prompt = `ì‚¬ìš©ìì˜ ë‹¤ì´ì–´íŠ¸ ëª©í‘œëŠ” "${goal}", í™œë™ëŸ‰ ìˆ˜ì¤€ì€ "${level}", ëª©í‘œ ê¸°ê°„ì€ ${duration}ì¼, ì‹ë‹¨ ì„ í˜¸/ì œí•œ ì‚¬í•­ì€ "${preferences}" ì…ë‹ˆë‹¤. ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ${duration}ì¼ì¹˜ ë§ì¶¤í˜• ë‹¤ì´ì–´íŠ¸ ì‹ë‹¨ ê³„íšì„ ì„¸ì›Œì£¼ì„¸ìš”. ê° ë‚ ì§œë³„ ì•„ì¹¨, ì ì‹¬, ì €ë… ë©”ë‰´ì™€ ê°„ë‹¨í•œ ë ˆì‹œí”¼ ì•„ì´ë””ì–´ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.`;
                const resultText = await callGeminiAPI(prompt, true);
                 if (resultText && UIElements.dietPlannerResult) {
                    displayFormattedText(resultText, UIElements.dietPlannerResult, "AI ë§ì¶¤ ë‹¤ì´ì–´íŠ¸ ì‹ë‹¨", "dietPlanner");
                }
            });
        }

        if(UIElements.calculateExerciseCaloriesButton) {
            UIElements.calculateExerciseCaloriesButton.addEventListener('click', async () => {
                const type = UIElements.exerciseTypeInput.value.trim();
                const duration = UIElements.exerciseDurationInput.value.trim();
                if(!type || !duration || isNaN(parseInt(duration)) || parseInt(duration) <=0){
                    showError("ìš´ë™ ì¢…ë¥˜ì™€ ì‹œê°„ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if(UIElements.exerciseTrackerResultWrapper) UIElements.exerciseTrackerResultWrapper.classList.add('hidden');
                const prompt = `"${type}" ìš´ë™ì„ ${duration}ë¶„ ë™ì•ˆ í–ˆì„ ë•Œ ì˜ˆìƒë˜ëŠ” ì†Œëª¨ ì¹¼ë¡œë¦¬ë¥¼ ê³„ì‚°í•´ì£¼ì„¸ìš”. ê²°ê³¼ëŠ” "ì˜ˆìƒ ì†Œëª¨ ì¹¼ë¡œë¦¬: ì•½ XXX kcal" í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.`;
                const resultText = await callGeminiAPI(prompt, true);
                if(resultText && UIElements.exerciseTrackerResult){
                    displayFormattedText(resultText, UIElements.exerciseTrackerResult, `"${type}" (${duration}ë¶„) ì†Œëª¨ ì¹¼ë¡œë¦¬`, "exerciseTracker");
                    const calorieMatch = resultText.match(/ì•½\s*(\d+)\s*kcal/i);
                    const caloriesBurned = calorieMatch ? parseInt(calorieMatch[1], 10) : 0;
                    saveExerciseLog({ type, duration, caloriesBurned });
                    loadDailyExerciseLog();
                }
            });
        }

        if(UIElements.logWaterIntakeButton){
            UIElements.logWaterIntakeButton.addEventListener('click', () => {
                const amount = parseInt(UIElements.waterIntakeAmountInput.value, 10);
                if(isNaN(amount) || amount <= 0) {
                    showError("ì˜¬ë°”ë¥¸ ì„­ì·¨ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                logWater(amount);
                loadAndUpdateWaterIntakeProgress();
                UIElements.waterIntakeAmountInput.value = "250"; // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
            });
        }
        if(UIElements.waterIntakeGoalInput){
             UIElements.waterIntakeGoalInput.addEventListener('change', loadAndUpdateWaterIntakeProgress);
        }


        if(UIElements.getDietTipButton){
            UIElements.getDietTipButton.addEventListener('click', async () => {
                if(UIElements.dietTipResultWrapper) UIElements.dietTipResultWrapper.classList.add('hidden');
                const prompt = "ì˜¤ëŠ˜ì˜ ë‹¤ì´ì–´íŠ¸ ê¿€íŒì„ í•˜ë‚˜ ì•Œë ¤ì£¼ì„¸ìš”. ì§§ê³  ì‹¤ìš©ì ì¸ ë‚´ìš©ìœ¼ë¡œ ë¶€íƒí•©ë‹ˆë‹¤.";
                const resultText = await callGeminiAPI(prompt, true);
                if(resultText && UIElements.dietTipResult){
                    displayFormattedText(resultText, UIElements.dietTipResult, "ì˜¤ëŠ˜ì˜ ë‹¤ì´ì–´íŠ¸ ê¿€íŒ", "dietTip");
                }
            });
        }
        
        // ì¹¼ë¡œë¦¬ ê¸°ë¡ ê´€ë ¨ í•¨ìˆ˜
        function getTodaysDateString() { return new Date().toISOString().split('T')[0]; }

        function saveCalorieLog(entry) {
            const today = getTodaysDateString();
            let logs = JSON.parse(localStorage.getItem(`calorieLog_${today}`)) || [];
            logs.push({...entry, time: new Date().toLocaleTimeString()});
            localStorage.setItem(`calorieLog_${today}`, JSON.stringify(logs));
        }

        function loadDailyCalorieLog() {
            if(!UIElements.dailyCalorieLogDiv || !UIElements.totalDailyCaloriesSpan) return;
            const today = getTodaysDateString();
            const logs = JSON.parse(localStorage.getItem(`calorieLog_${today}`)) || [];
            UIElements.dailyCalorieLogDiv.innerHTML = '';
            let totalCalories = 0;
            if (logs.length === 0) {
                UIElements.dailyCalorieLogDiv.innerHTML = '<p class="text-gray-500 italic">ì•„ì§ ê¸°ë¡ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.classList.add('calorie-log-item', 'text-sm');
                    logItem.innerHTML = `<strong>${log.mealType}:</strong> ${log.foodName} - ì•½ ${log.calories} kcal <i>(${log.time})</i>`;
                    UIElements.dailyCalorieLogDiv.appendChild(logItem);
                    totalCalories += log.calories;
                });
            }
            UIElements.totalDailyCaloriesSpan.textContent = totalCalories;
        }
        
        // ìš´ë™ ê¸°ë¡ ê´€ë ¨ í•¨ìˆ˜
        function saveExerciseLog(entry) {
            const today = getTodaysDateString();
            let logs = JSON.parse(localStorage.getItem(`exerciseLog_${today}`)) || [];
            logs.push({...entry, time: new Date().toLocaleTimeString()});
            localStorage.setItem(`exerciseLog_${today}`, JSON.stringify(logs));
        }

        function loadDailyExerciseLog() {
            if(!UIElements.dailyExerciseLogDiv || !UIElements.totalDailyExerciseCaloriesSpan) return;
            const today = getTodaysDateString();
            const logs = JSON.parse(localStorage.getItem(`exerciseLog_${today}`)) || [];
            UIElements.dailyExerciseLogDiv.innerHTML = '';
            let totalCaloriesBurned = 0;
            if (logs.length === 0) {
                UIElements.dailyExerciseLogDiv.innerHTML = '<p class="text-gray-500 italic">ì•„ì§ ê¸°ë¡ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.classList.add('exercise-log-item', 'text-sm');
                    logItem.innerHTML = `<strong>${log.type}</strong> (${log.duration}ë¶„) - ì•½ ${log.caloriesBurned} kcal ì†Œëª¨ <i>(${log.time})</i>`;
                    UIElements.dailyExerciseLogDiv.appendChild(logItem);
                    totalCaloriesBurned += log.caloriesBurned;
                });
            }
            UIElements.totalDailyExerciseCaloriesSpan.textContent = totalCaloriesBurned;
        }

        // ìˆ˜ë¶„ ì„­ì·¨ ê´€ë ¨ í•¨ìˆ˜
        function logWater(amount) {
            const today = getTodaysDateString();
            let currentIntake = parseInt(localStorage.getItem(`waterIntake_${today}`), 10) || 0;
            currentIntake += amount;
            localStorage.setItem(`waterIntake_${today}`, currentIntake);
        }

        function loadAndUpdateWaterIntakeProgress() {
            if(!UIElements.waterIntakeProgressDiv || !UIElements.currentWaterIntakeSpan || !UIElements.waterGoalDisplaySpan || !UIElements.waterIntakeGoalInput) return;
            const today = getTodaysDateString();
            const currentIntake = parseInt(localStorage.getItem(`waterIntake_${today}`), 10) || 0;
            const goal = parseInt(UIElements.waterIntakeGoalInput.value, 10) || 2000;
            
            UIElements.currentWaterIntakeSpan.textContent = currentIntake;
            UIElements.waterGoalDisplaySpan.textContent = goal;
            
            const percentage = Math.min((currentIntake / goal) * 100, 100);
            UIElements.waterIntakeProgressDiv.style.width = `${percentage}%`;
            UIElements.waterIntakeProgressDiv.textContent = `${Math.round(percentage)}%`;

            if (percentage >= 100) {
                UIElements.waterIntakeProgressDiv.classList.replace('bg-blue-500', 'bg-green-500');
            } else {
                UIElements.waterIntakeProgressDiv.classList.replace('bg-green-500', 'bg-blue-500');
            }
        }
    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë ˆì‹œí”¼ ì…°í”„ Pro âœ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: #f8f9fc; 
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f0f2f5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #d1d9e6; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #b0b8c9; }
        
        .spinner {
            border-width: 3px;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        textarea:focus, input[type="text"]:focus {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4); 
            border-color: #6366f1;
        }
        .tab-button {
            transition: all 0.25s ease-in-out;
            border-bottom: 3px solid transparent;
            padding: 0.85rem 0.7rem; 
             white-space: nowrap; 
            display: inline-flex; 
            align-items: center;
        }
        .tab-button i { 
            margin-right: 0.35rem;
        }
        .tab-button.active {
            color: #4f46e5; 
            border-bottom-color: #4f46e5;
            font-weight: 700;
        }
        .tab-button:not(.active):hover {
            color: #3730a3; 
            background-color: #f0f2ff; 
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card {
            background-color: white;
            border-radius: 18px; 
            box-shadow: 0 10px 28px rgba(0, 0, 0, 0.06); 
            padding: 2rem 2.5rem; 
            margin-top: 2rem; 
        }
        .content-card h3.card-title { /* content-card ë‚´ë¶€ì˜ h3ì—ë§Œ ì ìš©ë  ìˆ˜ ìˆë„ë¡ í´ë˜ìŠ¤ ì¶”ê°€ */
            font-size: 1.4rem; 
            font-weight: 700;
            color: #3730a3; 
            margin-bottom: 1.2rem;
            padding-bottom: 0.7rem;
            border-bottom: 1px solid #e5e7eb; 
        }
         .content-card ul, .content-card ol {
            padding-left: 1.4rem;
        }
        .content-card li {
            margin-bottom: 0.7rem;
            line-height: 1.8;
            color: #4b5563; 
        }
        .content-card strong {
            font-weight: 700;
            color: #1f2937; 
        }
        .content-card p {
            color: #4b5563;
            line-height: 1.8;
            margin-bottom: 0.85rem;
        }
        .action-button { 
            font-size: 1.05rem;
            padding-top: 0.9rem;
            padding-bottom: 0.9rem;
        }
        button#substituteIngredientButton, button#analyzeNutritionButton, button#generateShoppingListButton { /* IDë¡œ ì •í™•íˆ ì§€ì • */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.2rem;
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
            transition: all 0.15s ease-in-out;
            margin-top: 0.5rem;
        }
        button#substituteIngredientButton:hover, button#analyzeNutritionButton:hover, button#generateShoppingListButton:hover {
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); 
        }

        button#substituteIngredientButton { background-color: #f59e0b; } 
        button#substituteIngredientButton:hover { background-color: #d97706; } 
        button#analyzeNutritionButton { background-color: #10b981; } 
        button#analyzeNutritionButton:hover { background-color: #059669; } 
        button#generateShoppingListButton { background-color: #3b82f6; } 
        button#generateShoppingListButton:hover { background-color: #2563eb; } 

        .meal-plan-item, .themed-recipe-item { 
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background-color: #f9fafb;
        }
        .meal-plan-item strong, .themed-recipe-item strong {
            color: #4f46e5;
        }
        .meal-plan-item button, .themed-recipe-item button {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            margin-top: 0.5rem;
        }
        #nutritionAnalysisResult, #shoppingListResult { 
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px dashed #cbd5e1; 
        }
        #copyShoppingListButton {
            background-color: #6b7280; 
            color: white;
            margin-top: 1rem;
        }
        #copyShoppingListButton:hover {
            background-color: #4b5563; 
        }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

    <div class="container mx-auto max-w-5xl w-full">
        <header class="text-center my-10 lg:my-14">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-purple-500 to-pink-500">
                AI ë ˆì‹œí”¼ ì…°í”„
            </h1>
            <p class="text-lg sm:text-xl text-gray-600 mt-5">AIì™€ í•¨ê»˜, ë§¤ì¼ë§¤ì¼ íŠ¹ë³„í•œ ë¯¸ì‹ ê²½í—˜ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
        </header>

        <nav class="mb-10 flex flex-wrap justify-center border-b border-gray-200">
            <button data-tab="tab1" class="tab-button active text-gray-600 text-sm sm:text-base">
                <i class="fas fa-cogs"></i>ë§ì¶¤ ë ˆì‹œí”¼
            </button>
            <button data-tab="tab2" class="tab-button text-gray-600 text-sm sm:text-base">
                <i class="fas fa-hat-chef"></i>ì˜¤ëŠ˜ì˜ ì¶”ì²œ
            </button>
            <button data-tab="tab3" class="tab-button text-gray-600 text-sm sm:text-base">
                <i class="fas fa-book-sparkles"></i>ìš”ë¦¬ ê²€ìƒ‰
            </button>
            <button data-tab="tab4" class="tab-button text-gray-600 text-sm sm:text-base">
                <i class="fas fa-carrot"></i>ëƒ‰ì¥ê³  íŒŒë¨¹ê¸°
            </button>
            <button data-tab="tab5" class="tab-button text-gray-600 text-sm sm:text-base">
                <i class="fas fa-calendar-alt"></i>AI ì£¼ê°„ ì‹ë‹¨
            </button>
            <button data-tab="tab6" class="tab-button text-gray-600 text-sm sm:text-base">
                <i class="fas fa-gifts"></i>í…Œë§ˆë³„ ìš”ë¦¬
            </button>
        </nav>

        <div class="bg-white p-6 sm:p-10 rounded-xl shadow-xl relative">
            <div id="tab1" class="tab-content active">
                <section class="space-y-7">
                    <p class="text-md text-gray-700 mb-4">ì›í•˜ëŠ” ìš”ë¦¬ ìŠ¤íƒ€ì¼ê³¼ ì‹ë‹¨ ì„ í˜¸ë„ë¥¼ ì•Œë ¤ì£¼ì‹œë©´, AIê°€ ì™„ë²½í•œ ë ˆì‹œí”¼ì™€ í•¨ê»˜ í•„ìš”í•œ ëª¨ë“  ì¬ë£Œë¥¼ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤!</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-7">
                        <div>
                            <label for="dietaryPreferences" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ¥— ì‹ë‹¨ ì„ í˜¸ë„/ì œí•œ (ì„ íƒ ì‚¬í•­)</label>
                            <input type="text" id="dietaryPreferences" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ì €íƒ„ìˆ˜í™”ë¬¼, ë¹„ê±´, ê²¬ê³¼ë¥˜ ì œì™¸">
                        </div>
                        <div>
                            <label for="cuisineStyle" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸœ ì„ í˜¸ ìš”ë¦¬ ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­)</label>
                            <input type="text" id="cuisineStyle" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ì´íƒˆë¦¬ì•ˆ, í“¨ì „ í•œì‹, ì´ˆê°„ë‹¨">
                        </div>
                    </div>
                    <button id="generateRecipeButton" class="action-button w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-wand-magic-sparkles mr-3"></i>AI ì¶”ì²œ ë ˆì‹œí”¼ ìƒì„±
                    </button>
                </section>
            </div>

            <div id="tab2" class="tab-content">
                 <section class="space-y-7">
                    <div>
                        <label for="whatToEatKeywords" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ’¡ ì›í•˜ëŠ” ìš”ë¦¬ ëŠë‚Œ (ì„ íƒ ì‚¬í•­)</label>
                        <input type="text" id="whatToEatKeywords" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ë“ ë“ í•œ í•œ ë¼, ì™€ì¸ê³¼ ì–´ìš¸ë¦¬ëŠ”, ë§¤ì½¤í•œ ë„ì „">
                        <p class="text-xs text-gray-500 mt-1.5">AIì—ê²Œ ììœ ë¡œìš´ ì¶”ì²œì„ ë§¡ê²¨ë³´ì„¸ìš”!</p>
                    </div>
                    <button id="recommendDishButton" class="action-button w-full bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-lightbulb-on mr-3"></i>ì˜¤ëŠ˜ì˜ ìš”ë¦¬ ì¶”ì²œë°›ê¸°
                    </button>
                    <div id="recommendationDisplayWrapper" class="hidden">
                        <div id="recommendationDisplay" class="content-card">
                            </div>
                    </div>
                </section>
            </div>

            <div id="tab3" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="specificDishName" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ³ ì°¾ê³  ì‹¶ì€ ìš”ë¦¬ ì´ë¦„</label>
                        <input type="text" id="specificDishName" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ë´‰ê³¨ë ˆ íŒŒìŠ¤íƒ€, ë‹­ë³¶ìŒíƒ•">
                    </div>
                    <button id="searchSpecificDishButton" class="action-button w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-book-open-reader mr-3"></i>ë ˆì‹œí”¼ ê²€ìƒ‰
                    </button>
                </section>
            </div>
            
            <div id="tab4" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="leftoverIngredients" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ¥• ëƒ‰ì¥ê³  ì† ì¬ë£Œ ì…ë ¥</label>
                        <textarea id="leftoverIngredients" rows="4" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ë‚¨ì€ ì‚¼ê²¹ì‚´ ì¡°ê¸ˆ, ì‹œê¸ˆì¹˜ ë°˜ ë‹¨, ë‘ë¶€ ë°˜ ëª¨, ì–‘íŒŒ 1/4ê°œ"></textarea>
                        <p class="text-xs text-gray-500 mt-1.5">ê°€ì§€ê³  ìˆëŠ” ì¬ë£Œë“¤ì„ ìµœëŒ€í•œ í™œìš©í•˜ëŠ” ë ˆì‹œí”¼ë¥¼ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤!</p>
                    </div>
                     <div>
                        <label for="leftoverCuisineStyle" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸœ ì„ í˜¸ ìš”ë¦¬ ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­)</label>
                        <input type="text" id="leftoverCuisineStyle" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: í•œì‹, ê°„ë‹¨í•œ ë³¶ìŒ, êµ­ë¬¼ ìš”ë¦¬">
                    </div>
                    <button id="generateLeftoverRecipeButton" class="action-button w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-recycle mr-3"></i>ëƒ‰ì¥ê³  íŒŒë¨¹ê¸° ë ˆì‹œí”¼ ìƒì„±!
                    </button>
                </section>
            </div>

            <div id="tab5" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="mealPlanPreferences" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ“… ì£¼ê°„ ì‹ë‹¨ ìš”ì²­ì‚¬í•­</label>
                        <input type="text" id="mealPlanPreferences" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ê³ ë‹¨ë°± ìœ„ì£¼, ì±„ì‹ìœ¼ë¡œ ì¼ì£¼ì¼, ê°„ë‹¨í•œ ì €ë… ë©”ë‰´ë“¤">
                        <p class="text-xs text-gray-500 mt-1.5">AIê°€ 7ì¼ì¹˜ ì €ë… ì‹ë‹¨ ì•„ì´ë””ì–´ë¥¼ ì œì•ˆí•´ ë“œë¦½ë‹ˆë‹¤.</p>
                    </div>
                    <button id="generateMealPlanButton" class="action-button w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-calendar-check mr-3"></i>AI ì£¼ê°„ ì‹ë‹¨ ìƒì„±!
                    </button>
                     <div id="mealPlanDisplayWrapper" class="hidden">
                        <div id="mealPlanDisplay" class="content-card">
                            </div>
                    </div>
                </section>
            </div>

            <div id="tab6" class="tab-content">
                <section class="space-y-7">
                    <div>
                        <label for="themeKeywords" class="block text-md font-semibold text-gray-800 mb-2.5">ğŸ‰ ì›í•˜ëŠ” í…Œë§ˆ/ìƒí™© ì…ë ¥</label>
                        <input type="text" id="themeKeywords" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ìƒì¼ íŒŒí‹°, ìº í•‘ ìš”ë¦¬, ë¹„ ì˜¤ëŠ” ë‚ , ì†ë‹˜ ì´ˆëŒ€">
                        <p class="text-xs text-gray-500 mt-1.5">AIê°€ í…Œë§ˆì— ë§ëŠ” íŠ¹ë³„í•œ ìš”ë¦¬ë“¤ì„ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.</p>
                    </div>
                    <button id="generateThemedRecipesButton" class="action-button w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-gifts mr-3"></i>í…Œë§ˆ ìš”ë¦¬ ì¶”ì²œë°›ê¸°!
                    </button>
                     <div id="themedRecipesDisplayWrapper" class="hidden">
                        <div id="themedRecipesDisplay" class="content-card">
                            </div>
                    </div>
                </section>
            </div>
        </div>
        
        <div id="loadingIndicator" class="my-10 text-indigo-600 hidden flex flex-col items-center justify-center text-lg">
            <svg class="spinner w-12 h-12 mr-3 border-indigo-500 rounded-full" viewBox="0 0 24 24"></svg>
            <p id="loadingText" class="mt-4 font-semibold text-gray-700">AI ì…°í”„ê°€ ì—´ì‹¬íˆ ìš”ë¦¬ ì¤‘...</p>
        </div>

        <section id="recipeOutputSection" class="hidden">
             <div class="content-card">
                <h2 id="recipeOutputTitle" class="text-2xl md:text-3xl font-bold text-gray-800 mb-8 text-center">âœ¨ AI ì…°í”„ì˜ ë‹µë³€ âœ¨</h2>
                <div id="recipeDisplay" class="w-full min-h-[100px] space-y-6"> <p class="text-gray-500 italic text-center py-8">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
                <div id="additionalActionsSection" class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row flex-wrap justify-center gap-3 sm:gap-4 hidden">
                    <button id="generateShoppingListButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-list-check mr-2"></i> ì¥ë³´ê¸° ëª©ë¡ ìƒì„±
                    </button>
                    <button id="substituteIngredientButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-exchange-alt mr-2"></i> ì¬ë£Œ ëŒ€ì²´ ì¶”ì²œ
                    </button>
                    <button id="analyzeNutritionButton" class="text-sm sm:text-base inline-flex items-center justify-center">
                        <i class="fas fa-chart-pie mr-2"></i> ì˜ì–‘ ì •ë³´ ë¶„ì„
                    </button>
                </div>
                <div id="shoppingListResult" class="hidden"> </div>
                <div id="nutritionAnalysisResult" class="hidden"> </div>
             </div>
        </section>
    </div>

    <div id="substituteModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full mx-auto transform transition-all duration-300 ease-out scale-95 opacity-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">ì¬ë£Œ ëŒ€ì²´ ì¶”ì²œ ìš”ì²­</h3>
                <button id="closeSubstituteModal" class="text-gray-400 hover:text-gray-600 transition-colors text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <p class="text-gray-600 text-sm">í˜„ì¬ ë³´ê³  ê³„ì‹  ë ˆì‹œí”¼ì—ì„œ ë°”ê¾¸ê³  ì‹¶ì€ ì¬ë£Œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. AIê°€ ì ì ˆí•œ ëŒ€ì²´ ì¬ë£Œë¥¼ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.</p>
                <div>
                    <label for="ingredientToSubstitute" class="block text-sm font-medium text-gray-700 mb-1">ë°”ê¾¸ê³  ì‹¶ì€ ì¬ë£Œ ì´ë¦„:</label>
                    <input type="text" id="ingredientToSubstitute" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ìš°ìœ , ë¼ì§€ê³ ê¸° ëª©ì‚´">
                </div>
                 <div>
                    <label for="substitutionReason" class="block text-sm font-medium text-gray-700 mb-1">ëŒ€ì²´ ì´ìœ  (ì„ íƒ ì‚¬í•­):</label>
                    <input type="text" id="substitutionReason" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="ì˜ˆ: ì•Œë ˆë¥´ê¸°, ì±„ì‹, ì§‘ì— ì—†ì–´ì„œ">
                </div>
            </div>
            <div class="mt-8 text-right">
                <button id="confirmSubstituteButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2.5 px-6 rounded-lg transition-colors text-sm shadow-md hover:shadow-lg">
                    AIì—ê²Œ ì¶”ì²œ ìš”ì²­
                </button>
            </div>
        </div>
    </div>


    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-auto transform transition-all duration-300 ease-out scale-95 opacity-0" 
             data-modal-state="closed">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-2xl font-bold text-red-600 flex items-center"><i class="fas fa-exclamation-triangle mr-3"></i>ì˜¤ë¥˜ ë°œìƒ</h3>
                <button id="closeErrorModal" class="text-gray-400 hover:text-gray-600 transition-colors text-2xl">&times;</button>
            </div>
            <p id="errorMessage" class="text-gray-700 mb-8 text-md leading-relaxed">ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            <div class="text-right">
                <button id="confirmErrorModal" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-6 rounded-lg transition-colors text-sm shadow-md hover:shadow-lg">
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <textarea id="clipboardHelper" style="position: absolute; left: -9999px; top: -9999px;"></textarea>


    <script>
    // ì „ì—­ ë³€ìˆ˜
    let currentRecipeFullText = ""; 

    // DOM ìš”ì†Œë“¤ì„ ì €ì¥í•  ê°ì²´
    const UIElements = {};

    document.addEventListener('DOMContentLoaded', () => {
        // ì£¼ìš” UI ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
        UIElements.tabButtons = document.querySelectorAll('.tab-button');
        UIElements.tabContents = document.querySelectorAll('.tab-content');
        UIElements.dietaryPreferencesInput = document.getElementById('dietaryPreferences');
        UIElements.cuisineStyleInput = document.getElementById('cuisineStyle');
        UIElements.generateRecipeButton = document.getElementById('generateRecipeButton');
        UIElements.whatToEatKeywordsInput = document.getElementById('whatToEatKeywords');
        UIElements.recommendDishButton = document.getElementById('recommendDishButton');
        UIElements.recommendationDisplayWrapper = document.getElementById('recommendationDisplayWrapper');
        UIElements.recommendationDisplay = document.getElementById('recommendationDisplay');
        UIElements.specificDishNameInput = document.getElementById('specificDishName');
        UIElements.searchSpecificDishButton = document.getElementById('searchSpecificDishButton');
        UIElements.leftoverIngredientsInput = document.getElementById('leftoverIngredients');
        UIElements.leftoverCuisineStyleInput = document.getElementById('leftoverCuisineStyle');
        UIElements.generateLeftoverRecipeButton = document.getElementById('generateLeftoverRecipeButton');
        UIElements.mealPlanPreferencesInput = document.getElementById('mealPlanPreferences');
        UIElements.generateMealPlanButton = document.getElementById('generateMealPlanButton');
        UIElements.mealPlanDisplayWrapper = document.getElementById('mealPlanDisplayWrapper');
        UIElements.mealPlanDisplay = document.getElementById('mealPlanDisplay');
        UIElements.themeKeywordsInput = document.getElementById('themeKeywords');
        UIElements.generateThemedRecipesButton = document.getElementById('generateThemedRecipesButton');
        UIElements.themedRecipesDisplayWrapper = document.getElementById('themedRecipesDisplayWrapper');
        UIElements.themedRecipesDisplay = document.getElementById('themedRecipesDisplay');
        UIElements.loadingIndicator = document.getElementById('loadingIndicator');
        UIElements.loadingText = document.getElementById('loadingText');
        UIElements.recipeOutputSection = document.getElementById('recipeOutputSection');
        UIElements.recipeOutputTitle = document.getElementById('recipeOutputTitle');
        UIElements.recipeDisplay = document.getElementById('recipeDisplay');
        UIElements.additionalActionsSection = document.getElementById('additionalActionsSection');
        UIElements.generateShoppingListButton = document.getElementById('generateShoppingListButton'); 
        UIElements.shoppingListResultDiv = document.getElementById('shoppingListResult'); 
        UIElements.substituteIngredientButton = document.getElementById('substituteIngredientButton');
        UIElements.analyzeNutritionButton = document.getElementById('analyzeNutritionButton'); 
        UIElements.nutritionAnalysisResultDiv = document.getElementById('nutritionAnalysisResult'); 
        UIElements.substituteModal = document.getElementById('substituteModal');
        UIElements.substituteModalContent = UIElements.substituteModal ? UIElements.substituteModal.querySelector('div > div') : null;
        UIElements.closeSubstituteModalButton = document.getElementById('closeSubstituteModal');
        UIElements.ingredientToSubstituteInput = document.getElementById('ingredientToSubstitute');
        UIElements.substitutionReasonInput = document.getElementById('substitutionReason');
        UIElements.confirmSubstituteButton = document.getElementById('confirmSubstituteButton');
        UIElements.errorModal = document.getElementById('errorModal');
        UIElements.errorModalContentEl = UIElements.errorModal ? UIElements.errorModal.querySelector('div[data-modal-state]') : null;
        UIElements.errorMessageElement = document.getElementById('errorMessage');
        UIElements.closeErrorModalButton = document.getElementById('closeErrorModal');
        UIElements.confirmErrorModalButton = document.getElementById('confirmErrorModal');
        UIElements.clipboardHelper = document.getElementById('clipboardHelper');

        // íƒ­ ê¸°ëŠ¥ ì´ˆê¸°í™”
        if (UIElements.tabButtons && UIElements.tabContents) {
            UIElements.tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    UIElements.tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    UIElements.tabContents.forEach(content => content.classList.remove('active'));
                    const activeTabContent = document.getElementById(button.dataset.tab);
                    if (activeTabContent) activeTabContent.classList.add('active');
                    
                    // íƒ­ ë³€ê²½ ì‹œ ê³µí†µ ì´ˆê¸°í™”
                    if(UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                    if(UIElements.recommendationDisplayWrapper) UIElements.recommendationDisplayWrapper.classList.add('hidden');
                    if(UIElements.mealPlanDisplayWrapper) UIElements.mealPlanDisplayWrapper.classList.add('hidden');
                    if(UIElements.themedRecipesDisplayWrapper) UIElements.themedRecipesDisplayWrapper.classList.add('hidden'); 
                    if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden'); 
                    if(UIElements.nutritionAnalysisResultDiv) {
                        UIElements.nutritionAnalysisResultDiv.classList.add('hidden');
                        UIElements.nutritionAnalysisResultDiv.innerHTML = ''; 
                    }
                    if(UIElements.shoppingListResultDiv) {
                        UIElements.shoppingListResultDiv.classList.add('hidden');
                        UIElements.shoppingListResultDiv.innerHTML = '';
                    }
                    currentRecipeFullText = ""; 
                });
            });
        }
        
        // ì˜¤ë¥˜ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
        function showError(message) {
            if(UIElements.errorMessageElement) UIElements.errorMessageElement.textContent = message;
            if(UIElements.errorModal) UIElements.errorModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                if(UIElements.errorModalContentEl) {
                    UIElements.errorModalContentEl.classList.remove('scale-95', 'opacity-0');
                    UIElements.errorModalContentEl.classList.add('scale-100', 'opacity-100');
                }
            });
        }
        function hideErrorModal() {
            if(UIElements.errorModalContentEl){
                UIElements.errorModalContentEl.classList.add('scale-95', 'opacity-0');
                UIElements.errorModalContentEl.classList.remove('scale-100', 'opacity-100');
            }
            if(UIElements.errorModal) {
                setTimeout(() => UIElements.errorModal.classList.add('hidden'), 300);
            }
        }
        if(UIElements.closeErrorModalButton) UIElements.closeErrorModalButton.addEventListener('click', hideErrorModal);
        if(UIElements.confirmErrorModalButton) UIElements.confirmErrorModalButton.addEventListener('click', hideErrorModal);

        // ì¬ë£Œ ëŒ€ì²´ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
        function showSubstituteModal() {
            if(UIElements.ingredientToSubstituteInput) UIElements.ingredientToSubstituteInput.value = ''; 
            if(UIElements.substitutionReasonInput) UIElements.substitutionReasonInput.value = '';
            if(UIElements.substituteModal) UIElements.substituteModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                if(UIElements.substituteModalContent){
                    UIElements.substituteModalContent.classList.remove('scale-95', 'opacity-0');
                    UIElements.substituteModalContent.classList.add('scale-100', 'opacity-100');
                }
            });
        }
        function hideSubstituteModal() {
             if(UIElements.substituteModalContent){
                UIElements.substituteModalContent.classList.add('scale-95', 'opacity-0');
                UIElements.substituteModalContent.classList.remove('scale-100', 'opacity-100');
            }
            if(UIElements.substituteModal) {
                setTimeout(() => UIElements.substituteModal.classList.add('hidden'), 300);
            }
        }
        if(UIElements.substituteIngredientButton) UIElements.substituteIngredientButton.addEventListener('click', showSubstituteModal);
        if(UIElements.closeSubstituteModalButton) UIElements.closeSubstituteModalButton.addEventListener('click', hideSubstituteModal);

        // ë¡œë”© ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜
        function setLoading(isLoading, message = "AI ì…°í”„ê°€ ì—´ì‹¬íˆ ìš”ë¦¬ ì¤‘...") {
            const allActionButtons = [
                UIElements.generateRecipeButton, UIElements.recommendDishButton, UIElements.searchSpecificDishButton, 
                UIElements.generateLeftoverRecipeButton, UIElements.generateMealPlanButton, UIElements.generateThemedRecipesButton, 
                UIElements.confirmSubstituteButton, UIElements.analyzeNutritionButton, UIElements.generateShoppingListButton
            ];
            if (isLoading) {
                if(UIElements.loadingIndicator) UIElements.loadingIndicator.classList.remove('hidden');
                if(UIElements.loadingText) UIElements.loadingText.textContent = message;
                allActionButtons.forEach(btn => { if(btn) {btn.disabled = true; btn.classList.add('opacity-70', 'cursor-not-allowed');} });
            } else {
                if(UIElements.loadingIndicator) UIElements.loadingIndicator.classList.add('hidden');
                allActionButtons.forEach(btn => { if(btn) {btn.disabled = false; btn.classList.remove('opacity-70', 'cursor-not-allowed');} });
            }
        }

        // Gemini API í˜¸ì¶œ í•¨ìˆ˜
        async function callGeminiAPI(prompt, isAuxiliaryAction = false) {
            setLoading(true, isAuxiliaryAction ? "AIê°€ ì •ë³´ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..." : "ìµœê³ ì˜ ë ˆì‹œí”¼ë¥¼ êµ¬ìƒ ì¤‘...");
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.7, topK: 40, topP: 0.95,
                    maxOutputTokens: isAuxiliaryAction ? 1024 : 2048, 
                }
            };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: 'ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨ ë˜ëŠ” ë¹ˆ ì‘ë‹µ' } }));
                    console.error("API Error Data:", errorData);
                    throw new Error(`API ìš”ì²­ ì‹¤íŒ¨ (${response.status}): ${errorData.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜'}`);
                }
                const result = await response.json();

                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else if (result.promptFeedback?.blockReason) {
                     throw new Error(`AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì´ìœ : ${result.promptFeedback.blockReason}. (ì•ˆì „ ì„¤ì • ê´€ë ¨ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`);
                } else if (result.candidates && result.candidates[0]?.finishReason && result.candidates[0].finishReason !== 'STOP') {
                     throw new Error(`AI ì‘ë‹µì´ ì™„ë£Œë˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì´ìœ : ${result.candidates[0].finishReason}.`);
                } else {
                    console.error("API ì‘ë‹µì— ìœ íš¨í•œ ë‚´ìš©ì´ ì—†ê±°ë‚˜, ì˜ˆìƒì¹˜ ëª»í•œ êµ¬ì¡°ì…ë‹ˆë‹¤:", result);
                    throw new Error('AIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì‘ë‹µ ë‚´ìš©ì´ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error("Gemini API í˜¸ì¶œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
                showError(error.message || "API í†µì‹  ì¤‘ ì‹¬ê°í•œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return null;
            } finally {
                setLoading(false);
            }
        }
        
        function applyBoldMarkdown(text) {
            return text.replace(/\*\*(?!\s)(.+?)(?<!\s)\*\*/g, '<strong>$1</strong>');
        }

        function displayFormattedText(rawText, containerElement, title, outputType = "recipe") {
            if (!(containerElement instanceof HTMLElement)) {
                console.error(`displayFormattedText: containerElement (${containerElement ? containerElement.id : 'N/A'})ê°€ ìœ íš¨í•œ HTML ìš”ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤. Title: "${title}"`);
                showError(`ì½˜í…ì¸ ë¥¼ í‘œì‹œí•  ë‚´ë¶€ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${title}`);
                return;
            }

            // rawTextê°€ nullì´ê±°ë‚˜ ë¹ˆ ë¬¸ìì—´ì¼ ë•Œì˜ ê¸°ë³¸ ì²˜ë¦¬ (ì£¼ë¡œ API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ)
            if (!rawText || rawText.trim() === "") {
                // ì´ ê²½ìš°ëŠ” ë³´í†µ callGeminiAPIì—ì„œ nullì„ ë°˜í™˜í•˜ê³  showErrorê°€ ì´ë¯¸ í˜¸ì¶œëœ ìƒíƒœì´ê±°ë‚˜,
                // í˜¸ì¶œë¶€ì—ì„œ ë¹ˆ ì‘ë‹µì— ëŒ€í•œ showErrorë¥¼ í˜¸ì¶œí•œ í›„ì´ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì¶”ê°€ì ì¸ ì˜¤ë¥˜ í‘œì‹œëŠ” ìì œ.
                // ëŒ€ì‹ , ì»¨í…Œì´ë„ˆë¥¼ ë¹„ìš°ê³  ê´€ë ¨ ì„¹ì…˜ì´ ìˆ¨ê²¨ì ¸ ìˆë„ë¡ ë³´ì¥.
                containerElement.innerHTML = `<p class="text-gray-500 italic text-center py-8">í‘œì‹œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                if (UIElements.recipeOutputSection && (outputType === "recipe" || outputType === "substitution")) {
                    UIElements.recipeOutputSection.classList.remove('hidden'); // ì„¹ì…˜ì€ ë³´ì—¬ì£¼ë˜, ë‚´ìš© ì—†ìŒì„ ì•Œë¦¼
                }
                if (outputType === "recipe" && UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden');
                return;
            }

            containerElement.innerHTML = ''; 
            
            // ì œëª© ë° ì¶”ê°€ ì•¡ì…˜ ë²„íŠ¼ ê´€ë¦¬ (ë ˆì‹œí”¼ ê´€ë ¨ ì¶œë ¥ ì‹œ)
            if (outputType === "recipe" || outputType === "substitution") {
                if(UIElements.recipeOutputTitle) UIElements.recipeOutputTitle.textContent = title;
                if (outputType === "recipe") { 
                    currentRecipeFullText = rawText; 
                    if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.remove('hidden'); 
                    if(UIElements.nutritionAnalysisResultDiv) {
                        UIElements.nutritionAnalysisResultDiv.classList.add('hidden');
                        UIElements.nutritionAnalysisResultDiv.innerHTML = ''; 
                    }
                    if(UIElements.shoppingListResultDiv) {
                        UIElements.shoppingListResultDiv.classList.add('hidden');
                        UIElements.shoppingListResultDiv.innerHTML = '';
                    }
                } else if (outputType === "substitution") { // ì¬ë£Œ ëŒ€ì²´ ì‹œì—ë„ ì¶”ê°€ ì•¡ì…˜ì€ ë³´ì´ë„ë¡
                    if(UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.remove('hidden'); 
                }
            } else if (outputType === "nutrition" || outputType === "shoppingList") {
                // ì˜ì–‘ ì •ë³´ë‚˜ ì‡¼í•‘ ë¦¬ìŠ¤íŠ¸ëŠ” recipeDisplayê°€ ì•„ë‹Œ ë³„ë„ divì— í‘œì‹œë˜ë¯€ë¡œ, recipeOutputTitleì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ.
                // additionalActionsSectionì€ ì´ë¯¸ recipe íƒ€ì…ì—ì„œ ê´€ë¦¬ë¨.
            }


            const lines = rawText.split('\n');
            let currentList = null; 
            let isFirstTitleInCard = true; 

            lines.forEach(line => {
                let processedLine = line.trim();
                if (!processedLine) return; 

                const buttonPatternRegex = /(?:->\s*)?(?:\[|\uFF3B)([^\]\uFF3D]+?)(?:\]|\uFF3D)\s*ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°/;
                if ((outputType === "recommendation" || outputType === "themedRecipes") && buttonPatternRegex.test(processedLine)) {
                    const dishNameMatch = processedLine.match(buttonPatternRegex);
                    if (dishNameMatch && dishNameMatch[1]) {
                        const dishName = dishNameMatch[1].trim();
                        const pButton = document.createElement('p');
                        pButton.classList.add('mt-6', 'text-center'); 
                        const button = document.createElement('button');
                        button.innerHTML = `<i class="fas fa-utensils mr-2"></i> ${applyBoldMarkdown(dishName)} ë ˆì‹œí”¼ ë³´ê¸°`;
                        button.classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'text-white', 'font-semibold', 'py-3', 'px-6', 'rounded-lg', 'shadow-md', 'hover:shadow-lg', 'transition-all', 'duration-150', 'text-base', 'inline-flex', 'items-center');
                        button.onclick = () => {
                            if(UIElements.specificDishNameInput) UIElements.specificDishNameInput.value = dishName; 
                            if (UIElements.tabButtons && UIElements.tabContents && UIElements.searchSpecificDishButton) {
                                UIElements.tabButtons.forEach(btn => btn.classList.remove('active')); 
                                const tab3Button = document.querySelector('button[data-tab="tab3"]');
                                if(tab3Button) tab3Button.classList.add('active'); 
                                UIElements.tabContents.forEach(content => content.classList.remove('active')); 
                                const tab3Content = document.getElementById('tab3');
                                if(tab3Content) tab3Content.classList.add('active'); 
                                if(UIElements.recommendationDisplayWrapper) UIElements.recommendationDisplayWrapper.classList.add('hidden'); 
                                if(UIElements.themedRecipesDisplayWrapper) UIElements.themedRecipesDisplayWrapper.classList.add('hidden');
                                UIElements.searchSpecificDishButton.click(); 
                            }
                        };
                        pButton.appendChild(button);
                        containerElement.appendChild(pButton);
                        return; 
                    }
                }
                
                if (outputType === "mealPlan" && /^(ì›”ìš”ì¼|í™”ìš”ì¼|ìˆ˜ìš”ì¼|ëª©ìš”ì¼|ê¸ˆìš”ì¼|í† ìš”ì¼|ì¼ìš”ì¼)\s*:/i.test(processedLine)) {
                    if (currentList) { containerElement.appendChild(currentList); currentList = null; } 
                    const parts = processedLine.split(/:(.+)/); 
                    const day = parts[0].trim();
                    const mealDesc = parts[1] ? parts[1].trim() : "ì¶”ì²œ ë©”ë‰´ ì •ë³´ ì—†ìŒ";
                    
                    const mealItemDiv = document.createElement('div');
                    mealItemDiv.classList.add('meal-plan-item');
                    
                    const dayStrong = document.createElement('strong');
                    dayStrong.textContent = day + ": ";
                    mealItemDiv.appendChild(dayStrong);
                    
                    const descSpan = document.createElement('span');
                    const mealNameMatch = mealDesc.match(/^([^-(]+)/);
                    const mealNameForButton = mealNameMatch ? mealNameMatch[1].trim() : mealDesc.substring(0,15); 

                    descSpan.innerHTML = applyBoldMarkdown(mealDesc); 
                    mealItemDiv.appendChild(descSpan);

                    const searchRecipeBtn = document.createElement('button');
                    searchRecipeBtn.innerHTML = `<i class="fas fa-search mr-1"></i> "${mealNameForButton}" ë ˆì‹œí”¼ ê²€ìƒ‰`;
                    searchRecipeBtn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700', 'font-medium', 'py-1', 'px-2', 'rounded', 'text-xs', 'block', 'mt-2');
                    searchRecipeBtn.onclick = () => {
                        if(UIElements.specificDishNameInput) UIElements.specificDishNameInput.value = mealNameForButton;
                        if (UIElements.tabButtons && UIElements.tabContents && UIElements.searchSpecificDishButton) {
                            UIElements.tabButtons.forEach(btn => btn.classList.remove('active'));
                            const tab3Button = document.querySelector('button[data-tab="tab3"]');
                            if(tab3Button) tab3Button.classList.add('active');
                            UIElements.tabContents.forEach(content => content.classList.remove('active'));
                            const tab3Content = document.getElementById('tab3');
                            if(tab3Content) tab3Content.classList.add('active');
                            if(UIElements.mealPlanDisplayWrapper) UIElements.mealPlanDisplayWrapper.classList.add('hidden');
                            UIElements.searchSpecificDishButton.click();
                        }
                    };
                    mealItemDiv.appendChild(searchRecipeBtn);
                    containerElement.appendChild(mealItemDiv);
                    return; 
                }
                
                 if (outputType === "themedRecipes" && /^\d+\.\s*([^:]+):\s*(.+)/.test(processedLine)) {
                     if (currentList) { containerElement.appendChild(currentList); currentList = null; }
                    const itemMatch = processedLine.match(/^\d+\.\s*([^:]+):\s*(.+)/);
                    const recipeName = itemMatch[1].trim();
                    const recipeDesc = itemMatch[2].trim();

                    const themedItemDiv = document.createElement('div');
                    themedItemDiv.classList.add('themed-recipe-item');

                    const nameStrong = document.createElement('strong');
                    nameStrong.textContent = recipeName;
                    themedItemDiv.appendChild(nameStrong);

                    const descP = document.createElement('p');
                    descP.textContent = recipeDesc;
                    descP.classList.add('text-sm', 'text-gray-600', 'mt-1');
                    themedItemDiv.appendChild(descP);
                    
                    const pButton = document.createElement('p');
                    pButton.classList.add('mt-2'); 
                    const button = document.createElement('button');
                    button.innerHTML = `<i class="fas fa-utensils mr-2"></i> ${applyBoldMarkdown(recipeName)} ë ˆì‹œí”¼ ë³´ê¸°`;
                    button.classList.add('bg-indigo-100', 'hover:bg-indigo-200', 'text-indigo-700', 'font-medium', 'py-1', 'px-2', 'rounded', 'text-xs');

                    button.onclick = () => {
                        if(UIElements.specificDishNameInput) UIElements.specificDishNameInput.value = recipeName; 
                        if (UIElements.tabButtons && UIElements.tabContents && UIElements.searchSpecificDishButton) {
                            UIElements.tabButtons.forEach(btn => btn.classList.remove('active')); 
                            const tab3Button = document.querySelector('button[data-tab="tab3"]');
                            if(tab3Button) tab3Button.classList.add('active'); 
                            UIElements.tabContents.forEach(content => content.classList.remove('active')); 
                            const tab3Content = document.getElementById('tab3');
                            if(tab3Content) tab3Content.classList.add('active'); 
                            if(UIElements.themedRecipesDisplayWrapper) UIElements.themedRecipesDisplayWrapper.classList.add('hidden');
                            UIElements.searchSpecificDishButton.click(); 
                        }
                    };
                    pButton.appendChild(button);
                    themedItemDiv.appendChild(pButton);
                    containerElement.appendChild(themedItemDiv);
                    return;
                }

                const sectionTitleRegex = /^(?:(\*\*([^*]+?)\*\*)|([ê°€-í£\w\s()]+?))(?::\s*)?$/;
                const sectionTitleMatch = processedLine.match(sectionTitleRegex);
                const currentLineIndex = lines.indexOf(line); 
                const nextLineIsListItem = (currentLineIndex + 1 < lines.length) && lines[currentLineIndex + 1].trim().match(/^(\d+\.|\*|-)\s/);
                
                const isLikelyTitle = sectionTitleMatch && 
                                    !buttonPatternRegex.test(processedLine) && 
                                    ( nextLineIsListItem || 
                                      processedLine.endsWith(':') || 
                                      currentLineIndex === 0 || 
                                      (currentLineIndex > 0 && !lines[currentLineIndex-1].trim()) );

                if (isLikelyTitle) {
                    if (currentList) { containerElement.appendChild(currentList); currentList = null; } 
                    const h3 = document.createElement('h3');
                    // content-card ë‚´ë¶€ì˜ h3ì™€ êµ¬ë¶„í•˜ê¸° ìœ„í•´ card-title í´ë˜ìŠ¤ ëŒ€ì‹  ì¼ë°˜ ìŠ¤íƒ€ì¼ ì ìš©
                    h3.innerHTML = applyBoldMarkdown((sectionTitleMatch[2] || sectionTitleMatch[3]).trim()); 
                    h3.classList.add('text-xl', 'font-semibold', 'text-indigo-700', 'mb-3');
                     if (isFirstTitleInCard && (outputType === "recipe" || outputType === "substitution" || outputType === "nutrition" || outputType === "shoppingList")) { 
                        // recipeDisplay ë‚´ë¶€ì˜ ì²« ì œëª©ì€ mt-0, ê·¸ ì™¸ (recommendationDisplay ë“±)ëŠ” content-cardì˜ h3 ìŠ¤íƒ€ì¼ ë”°ë¦„
                        // card-title í´ë˜ìŠ¤ë¥¼ recipeOutputTitleì—ë§Œ ì ìš©í•˜ê³  ì—¬ê¸°ì„œëŠ” ì¼ë°˜ h3 ìŠ¤íƒ€ì¼ë§
                         h3.classList.add('mt-0'); 
                         isFirstTitleInCard = false;
                    } else {
                        h3.classList.add('mt-5');
                    }
                    containerElement.appendChild(h3);
                    return; 
                }
                
                const listItemRegex = /^(\d+\.|\*|-)\s*(.*)/;
                const listItemMatch = processedLine.match(listItemRegex);
                if (listItemMatch) {
                    const listMarker = listItemMatch[1]; 
                    let listItemText = listItemMatch[2]; 
                    const isOrdered = listMarker.match(/^\d+\./); 

                    if (!currentList || (isOrdered && currentList.tagName !== 'OL') || (!isOrdered && currentList.tagName !== 'UL')) {
                        if (currentList) containerElement.appendChild(currentList); 
                        currentList = document.createElement(isOrdered ? 'ol' : 'ul'); 
                        currentList.classList.add('list-inside', 'pl-1', 'space-y-2', 'text-gray-700');
                        if(isOrdered) currentList.classList.add('list-decimal'); else currentList.classList.add('list-disc');
                    }
                    const li = document.createElement('li');
                    li.innerHTML = applyBoldMarkdown(listItemText); 
                    currentList.appendChild(li);
                    return; 
                }
                
                if (currentList) { containerElement.appendChild(currentList); currentList = null; } 
                const p = document.createElement('p');
                p.innerHTML = applyBoldMarkdown(processedLine); 
                p.classList.add('text-gray-700', 'leading-relaxed', 'mb-3');
                containerElement.appendChild(p);
            });

            if (currentList) { containerElement.appendChild(currentList); } 
            
            // ê° íƒ€ì…ì— ë§ëŠ” wrapper í‘œì‹œ
            if (outputType === "recommendation" && UIElements.recommendationDisplayWrapper) UIElements.recommendationDisplayWrapper.classList.remove('hidden');
            else if (outputType === "mealPlan" && UIElements.mealPlanDisplayWrapper) UIElements.mealPlanDisplayWrapper.classList.remove('hidden');
            else if (outputType === "themedRecipes" && UIElements.themedRecipesDisplayWrapper) UIElements.themedRecipesDisplayWrapper.classList.remove('hidden');
            else if ((outputType === "recipe" || outputType === "substitution") && UIElements.recipeOutputSection) { // nutrition, shoppingListëŠ” recipeOutputSection ë‚´ ë‹¤ë¥¸ divì— í‘œì‹œ
                 UIElements.recipeOutputSection.classList.remove('hidden');
            } else if (outputType === "nutrition" && UIElements.nutritionAnalysisResultDiv) {
                 UIElements.nutritionAnalysisResultDiv.classList.remove('hidden');
                 if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden'); // ë¶€ëª¨ ì„¹ì…˜ë„ ë³´ì´ê²Œ
            } else if (outputType === "shoppingList" && UIElements.shoppingListResultDiv) {
                 UIElements.shoppingListResultDiv.classList.remove('hidden');
                 if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden'); // ë¶€ëª¨ ì„¹ì…˜ë„ ë³´ì´ê²Œ
            }
            
            // ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ (ë‚´ìš©ì´ ê¸¸ ê²½ìš°ë¥¼ ëŒ€ë¹„)
            if (containerElement && UIElements.recipeOutputSection && UIElements.recipeOutputSection.contains(containerElement)) {
                UIElements.recipeOutputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else if (containerElement) {
                containerElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ê° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (null ì²´í¬ í›„ í• ë‹¹)
        if (UIElements.generateRecipeButton) {
            UIElements.generateRecipeButton.addEventListener('click', async () => {
                const dietaryPreferencesVal = UIElements.dietaryPreferencesInput ? UIElements.dietaryPreferencesInput.value.trim() : 'íŠ¹ë³„í•œ ì œí•œ ì—†ìŒ';
                const cuisineStyleVal = UIElements.cuisineStyleInput ? UIElements.cuisineStyleInput.value.trim() : 'ëª¨ë“  ìŠ¤íƒ€ì¼ í™˜ì˜';

                if (dietaryPreferencesVal === 'íŠ¹ë³„í•œ ì œí•œ ì—†ìŒ' && cuisineStyleVal === 'ëª¨ë“  ìŠ¤íƒ€ì¼ í™˜ì˜') {
                     showError('ë ˆì‹œí”¼ë¥¼ ì¶”ì²œë°›ìœ¼ë ¤ë©´ ì‹ë‹¨ ì„ í˜¸ë„ ë˜ëŠ” ìš”ë¦¬ ìŠ¤íƒ€ì¼ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                     return;
                }
                
                const prompt = `
ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì…ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ ë§ì¶¤í˜• ë ˆì‹œí”¼ë¥¼ ìƒì„±í•˜ëŠ” AI ìš”ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ì ì…ë ¥:
* ì‹ë‹¨ ì„ í˜¸ë„/ì œí•œì‚¬í•­: ${dietaryPreferencesVal}
* ì„ í˜¸ ìš”ë¦¬ ìŠ¤íƒ€ì¼: ${cuisineStyleVal}

ìš”ì²­:
ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì„ í˜¸ë„ì™€ ìŠ¤íƒ€ì¼ì— ë§ëŠ” ìš”ë¦¬ë¥¼ ì¶”ì²œí•˜ê³  í•´ë‹¹ ìš”ë¦¬ì— í•„ìš”í•œ ëª¨ë“  ì¬ë£Œ ëª©ë¡ì„ í¬í•¨í•˜ì—¬ ë ˆì‹œí”¼ 1ê°œë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.

**ìš”ë¦¬ ì´ë¦„:**
[AIê°€ ì œì•ˆí•˜ëŠ” ìš”ë¦¬ ì´ë¦„]

**ê°„ë‹¨ ì„¤ëª…:**
[ìš”ë¦¬ì— ëŒ€í•œ ë§¤ë ¥ì ì¸ 2-3ë¬¸ì¥ ì„¤ëª…]

**ë‚œì´ë„:**
[ì˜ˆ: ì´ˆê¸‰ / ì¤‘ê¸‰ / ê³ ê¸‰]

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:**
ì¤€ë¹„: [Xë¶„] | ì¡°ë¦¬: [Yë¶„]

**ë¶„ëŸ‰:**
[Zì¸ë¶„]

**í•„ìš”í•œ ì¬ë£Œ:**
* [ì¬ë£Œ 1] - [ì–‘] (ì˜ˆ: ì–‘íŒŒ - 1ê°œ)
* [ì¬ë£Œ 2] - [ì–‘] (ì˜ˆ: ë‹¤ì§„ ë§ˆëŠ˜ - 1í°ìˆ )
* ... (ëª¨ë“  í•„ìš” ì¬ë£Œ ëª…ì‹œ)

**ë§Œë“œëŠ” ë°©ë²•:**
1. [ì¡°ë¦¬ ë‹¨ê³„ 1 ìƒì„¸ ì„¤ëª…]
2. [ì¡°ë¦¬ ë‹¨ê³„ 2 ìƒì„¸ ì„¤ëª…]
3. ...

**ê¿€íŒ (ì„ íƒ ì‚¬í•­):**
* [ìš”ë¦¬ë¥¼ ë” ë§›ìˆê²Œ ë§Œë“¤ê±°ë‚˜ ë³€í˜•í•  ìˆ˜ ìˆëŠ” íŒ]

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ, ëª¨ë“  ì„¹ì…˜ì„ í¬í•¨í•˜ì—¬ ëª…í™•í•˜ê³  ë”°ë¼í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ì„¹ì…˜ ì œëª©ì€ **êµµì€ ê¸€ì”¨**ì™€ í•¨ê»˜ ì½œë¡ (:)ìœ¼ë¡œ ëë‚˜ë„ë¡ í•´ì£¼ì„¸ìš”. (ì˜ˆ: **ìš”ë¦¬ ì´ë¦„:**). ë¦¬ìŠ¤íŠ¸ í•­ëª© ë‚´ì—ì„œë„ **êµµì€ ê¸€ì”¨** ë§ˆí¬ë‹¤ìš´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                `;
                const recipeText = await callGeminiAPI(prompt);
                if (recipeText && UIElements.recipeDisplay) displayFormattedText(recipeText, UIElements.recipeDisplay, "âœ¨ AI ì¶”ì²œ ë ˆì‹œí”¼ âœ¨", "recipe");
            });
        }

        if (UIElements.recommendDishButton) {
            UIElements.recommendDishButton.addEventListener('click', async () => {
                const keywordsVal = UIElements.whatToEatKeywordsInput ? UIElements.whatToEatKeywordsInput.value.trim() : "íŠ¹ë³„í•œ ì¡°ê±´ ì—†ìŒ";
                const prompt = `
ì‚¬ìš©ìê°€ "ì˜¤ëŠ˜ ë­ ë¨¹ì§€?" ê³ ë¯¼ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í‚¤ì›Œë“œë¥¼ ì°¸ê³ í•˜ì—¬, ì°½ì˜ì ì´ê³  í¥ë¯¸ë¡œìš´ ìš”ë¦¬ 1ê°€ì§€ì™€ ê·¸ ìš”ë¦¬ë¥¼ ì¶”ì²œí•˜ëŠ” ê°„ë‹¨í•œ ì´ìœ ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.
* ì‚¬ìš©ì í‚¤ì›Œë“œ: ${keywordsVal}

ì‘ë‹µ í˜•ì‹:
**ì¶”ì²œ ìš”ë¦¬:** [ìš”ë¦¬ ì´ë¦„]
**ì¶”ì²œ ì´ìœ :** [2-3ë¬¸ì¥ìœ¼ë¡œ ëœ ë§¤ë ¥ì ì¸ ì¶”ì²œ ì´ìœ ]
ê·¸ë¦¬ê³  ë‹¤ìŒ ì¤„ì— ì •í™•íˆ "-> [ìš”ë¦¬ ì´ë¦„] ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°" í˜•ì‹ìœ¼ë¡œ í•´ë‹¹ ìš”ë¦¬ì˜ ë ˆì‹œí”¼ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” ë²„íŠ¼ ìë¦¬í‘œì‹œìë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”. ëŒ€ê´„í˜¸ ì•ˆì—ëŠ” ì¶”ì²œí•œ ìš”ë¦¬ ì´ë¦„ì„ ì •í™•íˆ ë„£ì–´ì£¼ì„¸ìš”. ì´ ë²„íŠ¼ ìë¦¬í‘œì‹œìëŠ” ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´ ë‹¨ë… ë¼ì¸ìœ¼ë¡œ ì œê³µí•´ì£¼ì„¸ìš”.

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ì œëª©ì€ **êµµì€ ê¸€ì”¨**ì™€ í•¨ê»˜ ì½œë¡ (:)ìœ¼ë¡œ ëë‚˜ë„ë¡ í•´ì£¼ì„¸ìš”.
                `;
                const recommendationText = await callGeminiAPI(prompt, true);
                if (recommendationText && UIElements.recommendationDisplay) displayFormattedText(recommendationText, UIElements.recommendationDisplay, "ì˜¤ëŠ˜ì˜ ì¶”ì²œ", "recommendation");
            });
        }

        if (UIElements.searchSpecificDishButton) {
            UIElements.searchSpecificDishButton.addEventListener('click', async () => {
                const dishNameVal = UIElements.specificDishNameInput ? UIElements.specificDishNameInput.value.trim() : "";

                // ê²€ìƒ‰ ì‹œì‘ ì „, ì´ì „ ê²°ê³¼ ë° ê´€ë ¨ ì„¹ì…˜ ì´ˆê¸°í™”/ìˆ¨ê¹€
                if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                if (UIElements.recipeDisplay) UIElements.recipeDisplay.innerHTML = '<p class="text-gray-500 italic text-center py-8">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                if (UIElements.additionalActionsSection) UIElements.additionalActionsSection.classList.add('hidden');
                if (UIElements.nutritionAnalysisResultDiv) {
                    UIElements.nutritionAnalysisResultDiv.classList.add('hidden');
                    UIElements.nutritionAnalysisResultDiv.innerHTML = '';
                }
                if (UIElements.shoppingListResultDiv) {
                    UIElements.shoppingListResultDiv.classList.add('hidden');
                    UIElements.shoppingListResultDiv.innerHTML = '';
                }
                currentRecipeFullText = "";

                if (!dishNameVal) {
                    showError('ê²€ìƒ‰í•  ìš”ë¦¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden'); // í™•ì‹¤íˆ ìˆ¨ê¹€
                    return;
                }
                
                const prompt = `
ì‚¬ìš©ìê°€ "${dishNameVal}" ìš”ë¦¬ì˜ ë ˆì‹œí”¼ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.
ì´ ìš”ë¦¬ì— ëŒ€í•œ ìƒì„¸í•œ ë ˆì‹œí”¼ë¥¼ ë‹¤ìŒ í˜•ì‹ì— ë§ì¶° ì œê³µí•´ì£¼ì„¸ìš”.

**ìš”ë¦¬ ì´ë¦„:**
${dishNameVal} (ë˜ëŠ” AIê°€ íŒë‹¨í•œ ì •í™•í•œ ìš”ë¦¬ ì´ë¦„)

**ê°„ë‹¨ ì„¤ëª…:**
[ìš”ë¦¬ì— ëŒ€í•œ ë§¤ë ¥ì ì¸ 2-3ë¬¸ì¥ ì„¤ëª…]

**ë‚œì´ë„:**
[ì˜ˆ: ì´ˆê¸‰ / ì¤‘ê¸‰ / ê³ ê¸‰]

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:**
ì¤€ë¹„: [Xë¶„] | ì¡°ë¦¬: [Yë¶„]

**ë¶„ëŸ‰:**
[Zì¸ë¶„]

**í•„ìš”í•œ ì¬ë£Œ:**
* [ì¬ë£Œ 1] - [ì–‘]
* [ì¬ë£Œ 2] - [ì–‘]
* ...

**ë§Œë“œëŠ” ë°©ë²•:**
1. [ì¡°ë¦¬ ë‹¨ê³„ 1 ìƒì„¸ ì„¤ëª…]
2. [ì¡°ë¦¬ ë‹¨ê³„ 2 ìƒì„¸ ì„¤ëª…]
3. ...

**ê¿€íŒ (ì„ íƒ ì‚¬í•­):**
* [ìš”ë¦¬ë¥¼ ë” ë§›ìˆê²Œ ë§Œë“¤ê±°ë‚˜ ë³€í˜•í•  ìˆ˜ ìˆëŠ” íŒ]

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ, ëª¨ë“  ì„¹ì…˜ì„ í¬í•¨í•˜ì—¬ ëª…í™•í•˜ê³  ë”°ë¼í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ì„¹ì…˜ ì œëª©ì€ **êµµì€ ê¸€ì”¨**ì™€ í•¨ê»˜ ì½œë¡ (:)ìœ¼ë¡œ ëë‚˜ë„ë¡ í•´ì£¼ì„¸ìš”. ë¦¬ìŠ¤íŠ¸ í•­ëª© ë‚´ì—ì„œë„ **êµµì€ ê¸€ì”¨** ë§ˆí¬ë‹¤ìš´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                `;
                const recipeText = await callGeminiAPI(prompt);

                if (recipeText && recipeText.trim() !== "" && UIElements.recipeDisplay) {
                    displayFormattedText(recipeText, UIElements.recipeDisplay, `âœ¨ "${dishNameVal}" ë ˆì‹œí”¼ âœ¨`, "recipe");
                    // recipeOutputSectionì€ displayFormattedText ë‚´ë¶€ì—ì„œ ë³´ì´ë„ë¡ ì²˜ë¦¬ë¨
                } else if (recipeText === null) { // API í˜¸ì¶œ ì‹¤íŒ¨ (showErrorëŠ” callGeminiAPIì—ì„œ ì´ë¯¸ ì²˜ë¦¬)
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                } else { // API ì‘ë‹µì€ ì„±ê³µí–ˆìœ¼ë‚˜ ë‚´ìš©ì´ ë¹„ì–´ìˆëŠ” ê²½ìš°
                    showError(`"${dishNameVal}"ì— ëŒ€í•œ ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`);
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.add('hidden');
                }
            });
        }
        
        if (UIElements.generateLeftoverRecipeButton) {
            UIElements.generateLeftoverRecipeButton.addEventListener('click', async () => {
                const ingredientsVal = UIElements.leftoverIngredientsInput ? UIElements.leftoverIngredientsInput.value.trim() : "";
                const cuisineStyleVal = UIElements.leftoverCuisineStyleInput ? UIElements.leftoverCuisineStyleInput.value.trim() : "ìƒê´€ ì—†ìŒ";

                if (!ingredientsVal) {
                    showError('ëƒ‰ì¥ê³  ì† ì¬ë£Œë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return;
                }
                
                const prompt = `
ë‹¹ì‹ ì€ ì‚¬ìš©ìê°€ ì œê³µí•œ 'ëƒ‰ì¥ê³  ì† ì¬ë£Œ'ë¥¼ ìµœëŒ€í•œ í™œìš©í•˜ì—¬ ë§›ìˆëŠ” ìš”ë¦¬ë¥¼ ë§Œë“œëŠ” AI ìš”ë¦¬ì‚¬ì…ë‹ˆë‹¤. ì¶”ê°€ ì¬ë£ŒëŠ” ìµœì†Œí™”í•˜ê±°ë‚˜, í•„ìš” ì—†ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
ì‚¬ìš©ì ì…ë ¥:
* ëƒ‰ì¥ê³  ì† ì¬ë£Œ: ${ingredientsVal}
* ì„ í˜¸ ìš”ë¦¬ ìŠ¤íƒ€ì¼ (ì„ íƒ ì‚¬í•­): ${cuisineStyleVal}

ìš”ì²­:
ìœ„ 'ëƒ‰ì¥ê³  ì† ì¬ë£Œ'ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í•˜ëŠ” ë ˆì‹œí”¼ 1ê°œë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”. ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¼ì£¼ì„¸ìš”.

**ìš”ë¦¬ ì´ë¦„:**
[AIê°€ ì œì•ˆí•˜ëŠ” ìš”ë¦¬ ì´ë¦„]

**ê°„ë‹¨ ì„¤ëª…:**
[ëƒ‰ì¥ê³  ì† ì¬ë£Œë¥¼ ì–´ë–»ê²Œ í™œìš©í–ˆëŠ”ì§€ ê°•ì¡°í•˜ëŠ” 2-3ë¬¸ì¥ ì„¤ëª…]

**ë‚œì´ë„:**
[ì˜ˆ: ì´ˆê¸‰ / ì¤‘ê¸‰ / ê³ ê¸‰]

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:**
ì¤€ë¹„: [Xë¶„] | ì¡°ë¦¬: [Yë¶„]

**ë¶„ëŸ‰:**
[Zì¸ë¶„]

**í•„ìš”í•œ ì¬ë£Œ:**
(ì£¼ë¡œ 'ëƒ‰ì¥ê³  ì† ì¬ë£Œ'ë¥¼ ì‚¬ìš©í•˜ë©°, ë§Œì•½ ì•„ì£¼ ì•½ê°„ì˜ ì¶”ê°€ ì–‘ë…/ì¬ë£Œê°€ í•„ìš”í•˜ë‹¤ë©´ ëª…ì‹œ)
* [ì¬ë£Œ 1] - [ì–‘]
* ...

**ë§Œë“œëŠ” ë°©ë²•:**
1. [ì¡°ë¦¬ ë‹¨ê³„ 1 ìƒì„¸ ì„¤ëª…]
2. [ì¡°ë¦¬ ë‹¨ê³„ 2 ìƒì„¸ ì„¤ëª…]
3. ...

**í™œìš© íŒ (ì„ íƒ ì‚¬í•­):**
* [ë‚¨ì€ ì¬ë£Œë¥¼ ë‹¤ë¥´ê²Œ í™œìš©í•˜ê±°ë‚˜, ìš”ë¦¬ë¥¼ ë” ë§›ìˆê²Œ í•˜ëŠ” íŒ]

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ, ëª¨ë“  ì„¹ì…˜ì„ í¬í•¨í•˜ì—¬ ëª…í™•í•˜ê³  ë”°ë¼í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”. ê° ì„¹ì…˜ ì œëª©ì€ **êµµì€ ê¸€ì”¨**ì™€ í•¨ê»˜ ì½œë¡ (:)ìœ¼ë¡œ ëë‚˜ë„ë¡ í•´ì£¼ì„¸ìš”. ë¦¬ìŠ¤íŠ¸ í•­ëª© ë‚´ì—ì„œë„ **êµµì€ ê¸€ì”¨** ë§ˆí¬ë‹¤ìš´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                `;
                const recipeText = await callGeminiAPI(prompt);
                if (recipeText && UIElements.recipeDisplay) displayFormattedText(recipeText, UIElements.recipeDisplay, "ğŸŒ¿ ëƒ‰ì¥ê³  íŒŒë¨¹ê¸° ë ˆì‹œí”¼ ğŸŒ¿", "recipe");
            });
        }

        if (UIElements.generateMealPlanButton) {
            UIElements.generateMealPlanButton.addEventListener('click', async () => {
                const preferences = UIElements.mealPlanPreferencesInput ? UIElements.mealPlanPreferencesInput.value.trim() : "ê· í˜• ì¡íŒ ì¼ë°˜ì ì¸ ì‹ë‹¨";
                const prompt = `
ì‚¬ìš©ìì˜ ë‹¤ìŒ ìš”ì²­ì— ë”°ë¼ 7ì¼ì¹˜ ì €ë… ì‹ë‹¨ ì•„ì´ë””ì–´ë¥¼ ìš”ì¼ë³„(ì›”ìš”ì¼ë¶€í„° ì¼ìš”ì¼ê¹Œì§€)ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”.
ê° ì•„ì´ë””ì–´ëŠ” **"ìš”ì¼: ìš”ë¦¬ ì´ë¦„ - ê°„ë‹¨í•œ ì„¤ëª… (1~2ì¤„)"** í˜•ì‹ìœ¼ë¡œ í•œ ì¤„ì— í•˜ë‚˜ì”© ì‘ì„±í•´ì£¼ì„¸ìš”.
ì˜ˆì‹œ:
ì›”ìš”ì¼: ë‹­ê°ˆë¹„ - ë§¤ì½¤í•œ ì–‘ë…ì— ë³¶ì•„ ì˜¨ ê°€ì¡±ì´ ì¦ê¸°ê¸° ì¢‹ì€ ë©”ë‰´
í™”ìš”ì¼: ëœì¥ì°Œê°œ - êµ¬ìˆ˜í•˜ê³  ë“ ë“ í•œ í•œêµ­ì¸ì˜ ì†Œìš¸í‘¸ë“œ

ì‚¬ìš©ì ìš”ì²­: "${preferences}"
`;
                const mealPlanText = await callGeminiAPI(prompt, true);
                if (mealPlanText && UIElements.mealPlanDisplay) {
                    displayFormattedText(mealPlanText, UIElements.mealPlanDisplay, "ğŸ“… AI ì¶”ì²œ ì£¼ê°„ ì‹ë‹¨ ğŸ“…", "mealPlan");
                }
            });
        }
        
        if (UIElements.generateThemedRecipesButton) {
            UIElements.generateThemedRecipesButton.addEventListener('click', async () => {
                const theme = UIElements.themeKeywordsInput ? UIElements.themeKeywordsInput.value.trim() : "";
                if (!theme) {
                    showError('ì›í•˜ëŠ” í…Œë§ˆë‚˜ ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ìƒì¼ íŒŒí‹°, ìº í•‘ ìš”ë¦¬)');
                    return;
                }
                const prompt = `
ì‚¬ìš©ìê°€ ë‹¤ìŒ í…Œë§ˆ ë˜ëŠ” ìƒí™©ì— ë§ëŠ” ìš”ë¦¬ ì•„ì´ë””ì–´ 2~3ê°€ì§€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤: "${theme}"
ê° ìš”ë¦¬ ì•„ì´ë””ì–´ì— ëŒ€í•´ **"ë²ˆí˜¸. ìš”ë¦¬ ì´ë¦„: ê°„ë‹¨í•œ ì„¤ëª… (1~2ì¤„)"** í˜•ì‹ìœ¼ë¡œ ì œì•ˆí•´ì£¼ì„¸ìš”.
ê° ìš”ë¦¬ ì´ë¦„ ë’¤ì—ëŠ” í•´ë‹¹ ë ˆì‹œí”¼ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆë„ë¡ "-> [ìš”ë¦¬ ì´ë¦„] ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°" í˜•ì‹ì˜ ë²„íŠ¼ ìë¦¬í‘œì‹œìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.

ì˜ˆì‹œ:
í…Œë§ˆ: "ë¹„ ì˜¤ëŠ” ë‚ "
1. ê¹€ì¹˜ì „: ë°”ì‚­í•˜ê³  ë§¤ì½¤í•œ ë§›ì´ ì¼í’ˆì¸ í•œêµ­ì˜ ëŒ€í‘œì ì¸ ë¹„ ì˜¤ëŠ” ë‚  ìŒì‹ì…ë‹ˆë‹¤. -> [ê¹€ì¹˜ì „] ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°
2. í•´ë¬¼ ì¹¼êµ­ìˆ˜: ë”°ëˆí•˜ê³  ì‹œì›í•œ êµ­ë¬¼ì— í•´ë¬¼ì´ ë“¬ë¿ ë“¤ì–´ê°„ ì¹¼êµ­ìˆ˜ì…ë‹ˆë‹¤. -> [í•´ë¬¼ ì¹¼êµ­ìˆ˜] ì „ì²´ ë ˆì‹œí”¼ ë³´ê¸°

ê²°ê³¼ëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
`;
                const themedRecipesText = await callGeminiAPI(prompt, true);
                if (themedRecipesText && UIElements.themedRecipesDisplay) {
                    displayFormattedText(themedRecipesText, UIElements.themedRecipesDisplay, `ğŸ‰ "${theme}" í…Œë§ˆ ìš”ë¦¬ ì¶”ì²œ ğŸ‰`, "themedRecipes");
                }
            });
        }

        if (UIElements.confirmSubstituteButton) {
            UIElements.confirmSubstituteButton.addEventListener('click', async () => {
                const ingredientToSub = UIElements.ingredientToSubstituteInput ? UIElements.ingredientToSubstituteInput.value.trim() : "";
                const reasonForSub = UIElements.substitutionReasonInput ? UIElements.substitutionReasonInput.value.trim() : "";

                if (!ingredientToSub) {
                    // ëª¨ë‹¬ ë‚´ì—ì„œ ì˜¤ë¥˜ë¥¼ ì§ì ‘ í‘œì‹œí•˜ê±°ë‚˜, ë©”ì¸ showErrorë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    // ì—¬ê¸°ì„œëŠ” ëª¨ë‹¬ì„ ë‹«ì§€ ì•Šê³  ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ëŠ” ê²ƒì´ ë” ë‚˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    // ê°„ë‹¨í•˜ê²Œ alert ëŒ€ì‹  console.error ë˜ëŠ” ëª¨ë‹¬ ë‚´ì— ì‘ì€ ì˜¤ë¥˜ ë©”ì‹œì§€ ê³µê°„ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    // ì§€ê¸ˆì€ showErrorë¥¼ ì‚¬ìš©í•˜ë˜, ëª¨ë‹¬ì´ ë‹«íˆëŠ” ê²ƒì„ ê°ìˆ˜í•©ë‹ˆë‹¤.
                    showError("ëŒ€ì²´í•˜ê³  ì‹¶ì€ ì¬ë£Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
                    return;
                }
                if (!currentRecipeFullText) {
                    showError("ë¨¼ì € ë ˆì‹œí”¼ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.");
                    hideSubstituteModal();
                    return;
                }

                hideSubstituteModal(); 
                
                let reasonText = "";
                if (reasonForSub) {
                    reasonText = `ëŒ€ì²´í•˜ë ¤ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: "${reasonForSub}". `;
                }

                const prompt = `
í˜„ì¬ ì‚¬ìš©ìëŠ” ë‹¤ìŒ ë ˆì‹œí”¼ë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤:
--- ë ˆì‹œí”¼ ì‹œì‘ ---
${currentRecipeFullText}
--- ë ˆì‹œí”¼ ë ---

ì´ ë ˆì‹œí”¼ì—ì„œ "${ingredientToSub}" ì¬ë£Œë¥¼ ëŒ€ì²´í•  ë§Œí•œ ë‹¤ë¥¸ ì¬ë£Œ 2~3ê°€ì§€ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”. ${reasonText}ê° ëŒ€ì²´ ì¬ë£Œì— ëŒ€í•´, ì‚¬ìš©ëŸ‰ì€ ì–´ë–»ê²Œ ì¡°ì ˆí•´ì•¼ í•˜ëŠ”ì§€, ê·¸ë¦¬ê³  ëŒ€ì²´ ì‹œ íŠ¹ë³„íˆ ì£¼ì˜í•  ì ì´ë‚˜ ë§›ì˜ ë³€í™”ê°€ ìˆë‹¤ë©´ í•¨ê»˜ ì„¤ëª…í•´ì£¼ì„¸ìš”. ê²°ê³¼ëŠ” ëª…í™•í•˜ê³  ê°„ê²°í•˜ê²Œ ëª©ë¡ í˜•íƒœë¡œ ì œê³µí•´ì£¼ì„¸ìš”.

ì˜ˆì‹œ:
**"${ingredientToSub}" ëŒ€ì²´ ì¬ë£Œ ì¶”ì²œ:**
* **[ëŒ€ì²´ ì¬ë£Œ 1]:** [ì„¤ëª…, ì–‘ ì¡°ì ˆ íŒ, ì£¼ì˜ì‚¬í•­ ë“±]
* **[ëŒ€ì²´ ì¬ë£Œ 2]:** [ì„¤ëª…, ì–‘ ì¡°ì ˆ íŒ, ì£¼ì˜ì‚¬í•­ ë“±]
`;
                const substitutionText = await callGeminiAPI(prompt, true);
                if (substitutionText && UIElements.recipeDisplay) {
                    displayFormattedText(substitutionText, UIElements.recipeDisplay, `ğŸ”„ "${ingredientToSub}" ì¬ë£Œ ëŒ€ì²´ ì¶”ì²œ ğŸ”„`, "substitution");
                }
            });
        }

        if (UIElements.analyzeNutritionButton) {
            UIElements.analyzeNutritionButton.addEventListener('click', async () => {
                if (!currentRecipeFullText) {
                    showError("ë¨¼ì € ë ˆì‹œí”¼ë¥¼ ì¡°íšŒí•˜ì—¬ ì˜ì–‘ ì •ë³´ë¥¼ ë¶„ì„í•  ë‚´ìš©ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.");
                    return;
                }
                 if (!UIElements.nutritionAnalysisResultDiv) { 
                    console.error("Error: nutritionAnalysisResultDiv is not a valid HTMLElement or is null/undefined.");
                    showError("ì˜ì–‘ ì •ë³´ë¥¼ í‘œì‹œí•  ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì•± ë‚´ë¶€ ì˜¤ë¥˜)");
                    return;
                }
                const prompt = `
ë‹¤ìŒ ë ˆì‹œí”¼ì˜ ì£¼ìš” ì˜ì–‘ ì •ë³´ë¥¼ 1ì¸ë¶„ ê¸°ì¤€ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”. (ë§Œì•½ ë ˆì‹œí”¼ì— ë¶„ëŸ‰ ì •ë³´ê°€ ìˆë‹¤ë©´ ê·¸ê²ƒì„ ì°¸ê³ í•˜ê³ , ì—†ë‹¤ë©´ ì¼ë°˜ì ì¸ 1ì¸ë¶„ ê¸°ì¤€ìœ¼ë¡œ ê°€ì •í•´ì£¼ì„¸ìš”.)
ì˜ˆìƒë˜ëŠ” ì´ ì¹¼ë¡œë¦¬, íƒ„ìˆ˜í™”ë¬¼(g), ë‹¨ë°±ì§ˆ(g), ì§€ë°©(g) í•¨ëŸ‰ì„ ì•Œë ¤ì£¼ê³ , ê°€ëŠ¥í•˜ë‹¤ë©´ ë‚˜íŠ¸ë¥¨(mg) ì •ë³´ë„ ê°„ëµíˆ í¬í•¨í•´ì£¼ì„¸ìš”.
ê²°ê³¼ëŠ” ëª…í™•í•œ ëª©ë¡ í˜•íƒœë¡œ, ê° í•­ëª©ê³¼ ìˆ˜ì¹˜ë¥¼ í•¨ê»˜ ë³´ì—¬ì£¼ì„¸ìš”. (ì˜ˆ: **ì´ ì¹¼ë¡œë¦¬:** ì•½ XXX kcal). ê° ì˜ì–‘ì†Œ ë’¤ì—ëŠ” ë‹¨ìœ„ë¥¼ ëª…ì‹œí•´ì£¼ì„¸ìš”.

--- ë ˆì‹œí”¼ ë‚´ìš© ---
${currentRecipeFullText}
--- ë ˆì‹œí”¼ ë‚´ìš© ë ---
`;
                const nutritionText = await callGeminiAPI(prompt, true);
                if (nutritionText) {
                    UIElements.nutritionAnalysisResultDiv.innerHTML = ''; 
                    displayFormattedText(nutritionText, UIElements.nutritionAnalysisResultDiv, "ğŸ“Š ì˜ì–‘ ì •ë³´ ë¶„ì„ ê²°ê³¼ (1ì¸ë¶„ ê¸°ì¤€)", "nutrition"); 
                }
            });
        }

        if (UIElements.generateShoppingListButton) {
            UIElements.generateShoppingListButton.addEventListener('click', () => {
                if (!currentRecipeFullText) {
                    showError("ë¨¼ì € ë ˆì‹œí”¼ë¥¼ ì¡°íšŒí•˜ì—¬ ì¥ë³´ê¸° ëª©ë¡ì„ ìƒì„±í•  ë‚´ìš©ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (!UIElements.shoppingListResultDiv) { 
                    console.error("Error: shoppingListResultDiv is not a valid HTMLElement or is null/undefined.");
                    showError("ì¥ë³´ê¸° ëª©ë¡ì„ í‘œì‹œí•  ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì•± ë‚´ë¶€ ì˜¤ë¥˜)");
                    return;
                }

                const ingredientsSectionRegex = /\*\*í•„ìš”í•œ ì¬ë£Œ:\*\*\s*([\s\S]*?)(?=\n\*\*|$)/i;
                const match = currentRecipeFullText.match(ingredientsSectionRegex);

                if (match && match[1]) {
                    const ingredientsText = match[1].trim();
                    const ingredientsArray = ingredientsText.split('\n').map(item => item.replace(/^\s*\*\s*/, '').trim()).filter(item => item); 
                    
                    if (ingredientsArray.length > 0) {
                        UIElements.shoppingListResultDiv.innerHTML = `
                            <h3 class="text-lg font-semibold text-indigo-600 mb-3">ğŸ›’ ì¥ë³´ê¸° ëª©ë¡</h3>
                            <ul class="list-disc list-inside space-y-1 text-gray-700">
                                ${ingredientsArray.map(item => `<li>${applyBoldMarkdown(item)}</li>`).join('')}
                            </ul>
                            <button id="copyShoppingListButton" class="action-button mt-4 text-sm">
                                <i class="fas fa-copy mr-2"></i> ëª©ë¡ ë³µì‚¬í•˜ê¸°
                            </button>
                        `;
                        UIElements.shoppingListResultDiv.classList.remove('hidden');
                        if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden');


                        const copyButton = document.getElementById('copyShoppingListButton');
                        if(copyButton && UIElements.clipboardHelper) { 
                            copyButton.addEventListener('click', () => {
                                const listToCopy = ingredientsArray.join('\n');
                                UIElements.clipboardHelper.value = listToCopy;
                                UIElements.clipboardHelper.select();
                                try {
                                    document.execCommand('copy');
                                    showError('ì¥ë³´ê¸° ëª©ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'); 
                                } catch (err) {
                                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                                    showError('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                                }
                                if (window.getSelection) {
                                    window.getSelection().removeAllRanges();
                                } else if (document.selection) {
                                    document.selection.empty();
                                }
                            });
                        } else if (!UIElements.clipboardHelper) {
                             console.warn("clipboardHelper ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ë³µì‚¬ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤.");
                        }

                    } else {
                        UIElements.shoppingListResultDiv.innerHTML = '<p class="text-gray-500 italic">ë ˆì‹œí”¼ì—ì„œ ì¬ë£Œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                        UIElements.shoppingListResultDiv.classList.remove('hidden');
                        if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden');
                    }
                } else {
                    UIElements.shoppingListResultDiv.innerHTML = '<p class="text-gray-500 italic">"í•„ìš”í•œ ì¬ë£Œ" ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    UIElements.shoppingListResultDiv.classList.remove('hidden');
                    if (UIElements.recipeOutputSection) UIElements.recipeOutputSection.classList.remove('hidden');
                }
            });
        }
    });
    </script>
</body>
</html>
